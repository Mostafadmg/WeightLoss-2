<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="GLP-1 Prescribing Portal - Safe prescribing assistant for Mounjaro, Wegovy & Nevolat"
    />
    <title>GLP-1 Prescribing Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;700;900&family=Manrope:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
/* ============================================
   CSS Variables & Themes
   ============================================ */
:root {
  /* Dark Theme (Default) */
  --bg: #0f0f12;
  --bg-card: #18181b;
  --bg-elevated: #1f1f23;
  --bg-hover: #27272a;
  --border: #2e2e33;
  --text: #fafafa;
  --text-secondary: #a1a1aa;
  --text-muted: #71717a;

  /* Common surfaces */
  --accent-bg: rgba(99, 102, 241, 0.12);

  /* Layout */
  --content-max-width: 1160px;
  --content-padding: 32px;
  --content-padding-sm: 20px;

  /* Focus ring */
  --focus-ring: 0 0 0 3px rgba(99, 102, 241, 0.28);

  /* Accent Colors */
  --accent: #6366f1;
  --accent-light: #818cf8;
  --success: #22c55e;
  --success-bg: rgba(34, 197, 94, 0.1);
  --warning: #f59e0b;
  --warning-bg: rgba(245, 158, 11, 0.1);
  --danger: #ef4444;
  --danger-bg: rgba(239, 68, 68, 0.1);
  --purple: #a855f7;
  --purple-bg: rgba(168, 85, 247, 0.1);
  --cyan: #06b6d4;
  --cyan-bg: rgba(6, 182, 212, 0.1);

  /* Gradients */
  --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  --gradient-2: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
  --gradient-3: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
  --gradient-4: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
  --gradient-5: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);

  /* Shadows */
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);

  /* Border Radius */
  --radius: 12px;
  --radius-lg: 16px;

  /* Transitions */
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);

  /* Sidebar Width */
  --sidebar-width: 280px;
}

/* Light Theme */
[data-theme="light"] {
  --bg: #f5f5f7;
  --bg-card: #ffffff;
  --bg-elevated: #fafafa;
  --bg-hover: #f0f0f0;
  --border: #e5e5ea;
  --text: #1d1d1f;
  --text-secondary: #6e6e73;
  --text-muted: #86868b;

  --accent-bg: rgba(88, 85, 214, 0.12);

  --focus-ring: 0 0 0 3px rgba(88, 85, 214, 0.22);

  /* Accent Colors - adjusted for light theme */
  --accent: #5855d6;
  --accent-light: #7c79e8;
  --success: #28a745;
  --success-bg: rgba(40, 167, 69, 0.1);
  --warning: #ff9500;
  --warning-bg: rgba(255, 149, 0, 0.1);
  --danger: #dc3545;
  --danger-bg: rgba(220, 53, 69, 0.1);
  --purple: #af52de;
  --purple-bg: rgba(175, 82, 222, 0.1);
  --cyan: #0891b2;
  --cyan-bg: rgba(8, 145, 178, 0.1);

  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
}

/* ============================================
   Base Styles
   ============================================ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Manrope", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transition: background-color 0.3s ease, color 0.3s ease;
}

:where(
    a,
    button,
    input,
    select,
    textarea,
    summary,
    [role="button"],
    .nav-item,
    .nav-link
  ):focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
  border-radius: 10px;
}

@media (prefers-reduced-motion: reduce) {
  * {
    transition: none !important;
    animation: none !important;
    scroll-behavior: auto !important;
  }
}

.app {
  display: flex;
  min-height: 100vh;
}

/* ============================================
   Sidebar
   ============================================ */
.sidebar {
  width: var(--sidebar-width);
  background: linear-gradient(180deg, #1c1c1e 0%, #2c2c2e 100%);
  border-right: 1px solid rgba(255, 255, 255, 0.06);
  box-shadow: 2px 0 15px rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
  overflow-y: auto;
}

.sidebar-header {
  padding: 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  display: flex;
  align-items: center;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #0a84ff 0%, #5e5ce6 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
}

.logo-icon svg {
  width: 26px;
  height: 26px;
  stroke: white;
  stroke-width: 2.5;
}

.logo-text-container {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.logo-text {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.03em;
  background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.logo-badge {
  font-size: 10px;
  font-weight: 600;
  background: var(--accent);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
}

/* Theme Toggle in Top Right */
.theme-toggle-wrapper {
  display: flex;
  align-items: center;
  gap: 12px;
}

.font-selector {
  padding: 8px 12px;
  border-radius: 8px;
  background-color: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: white;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  backdrop-filter: blur(10px);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 12px 12px;
  padding-right: 32px;
  min-width: 110px;
}

.font-selector:hover {
  background-color: rgba(255, 255, 255, 0.15);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 12px 12px;
  border-color: rgba(255, 255, 255, 0.25);
}

.font-selector:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.15);
  border-color: #0a84ff;
  box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
}

.font-selector option {
  background-color: var(--bg-card);
  color: var(--text);
  padding: 8px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

.font-selector option[value="Poppins"] {
  font-family: "Poppins", sans-serif;
}

.font-selector option[value="Inter"] {
  font-family: "Inter", sans-serif;
}

.font-selector option[value="Outfit"] {
  font-family: "Outfit", sans-serif;
}

.font-selector option[value="Roboto"] {
  font-family: "Roboto", sans-serif;
}

.font-selector option[value="Manrope"] {
  font-family: "Manrope", sans-serif;
}

[data-theme="light"] .font-selector {
  background-color: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236e6e73' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 12px 12px;
}

[data-theme="light"] .font-selector:hover {
  background: var(--bg-hover);
  border-color: var(--accent);
}

[data-theme="light"] .font-selector:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.theme-toggle {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0;
  outline: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toggle-track {
  position: relative;
  display: flex;
  align-items: center;
  width: 48px;
  height: 24px;
  background: #9ca3af;
  border-radius: 12px;
  border: none;
  transition: background 0.3s ease;
  cursor: pointer;
}

.toggle-thumb {
  position: absolute;
  top: 1.3px;
  left: 2px;
  width: 21px;
  height: 21px;
  background: #ffffff;
  border-radius: 50%;
  transition: transform 0.3s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

/* Light mode state */
.theme-toggle[data-theme="light"] .toggle-track {
  background: #3b82f6;
}

.theme-toggle[data-theme="light"] .toggle-thumb {
  transform: translateX(22px);
}

/* Hover effect */
.theme-toggle:hover .toggle-track {
  background: #6b7280;
}

.theme-toggle[data-theme="light"]:hover .toggle-track {
  background: #2563eb;
}

.theme-toggle:active .toggle-thumb {
  width: 18px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.theme-toggle[data-theme="light"]:active .toggle-thumb {
  width: 19px;
  transform: translateX(12px);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* Theme Selector */
.theme-selector {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 120px;
}

.theme-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: rgba(255, 255, 255, 0.4);
}

.theme-dropdown {
  width: 100%;
  padding: 10px 14px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: white;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  backdrop-filter: blur(10px);
}

.theme-dropdown:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.25);
}

.theme-dropdown:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.15);
  border-color: #0a84ff;
  box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
}
select,
.theme-dropdown select {
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1aa' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 32px;
}

.theme-dropdown:hover {
  background: var(--bg-hover);
  border-color: var(--accent);
}

.theme-dropdown:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.theme-dropdown option {
  background: var(--bg-card);
  color: var(--text);
  padding: 8px;
}

/* Theme Toggle (Legacy - keeping for backward compatibility) */
.theme-toggle.legacy {
  width: 36px;
  height: 36px;
  border-radius: 8px;

  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.theme-toggle.legacy svg {
  width: 18px;
  height: 18px;
  position: absolute;
  transition: opacity 0.2s ease, transform 0.2s ease;
}

.theme-toggle.legacy .sun-icon {
  opacity: 0;
  transform: rotate(90deg);
}

.theme-toggle.legacy .moon-icon {
  opacity: 1;
  transform: rotate(0deg);
}

[data-theme="light"] .theme-toggle.legacy .sun-icon {
  opacity: 1;
  transform: rotate(0deg);
}

[data-theme="light"] .theme-toggle.legacy .moon-icon {
  opacity: 0;
  transform: rotate(-90deg);
}

/* Navigation */
.sidebar-nav {
  flex: 1;
  padding: 16px 12px;
  overflow-y: auto;
}

.nav-section {
  margin-bottom: 24px;
}

.nav-section-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: rgba(255, 255, 255, 0.3);
  padding: 8px 12px;
  margin-bottom: 8px;
}

.nav-item,
.nav-link {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.6);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  margin-bottom: 2px;
  text-decoration: none;
  position: relative;
}

.nav-item:hover,
.nav-link:hover {
  background: rgba(255, 255, 255, 0.08);
  color: rgba(255, 255, 255, 0.9);
}

.nav-item.active {
  background: #0a84ff;
  color: white;
  box-shadow: 0 2px 8px rgba(10, 132, 255, 0.3);
}

.nav-item svg,
.nav-link svg {
  width: 18px;
  height: 18px;
  opacity: 0.7;
  flex-shrink: 0;
  transition: var(--transition);
}

.nav-item.active svg {
  opacity: 1;
}

.nav-item .badge {
  margin-left: auto;
  font-size: 11px;
  font-weight: 600;
  background: var(--bg-elevated);
  padding: 2px 8px;
  border-radius: 10px;
  color: var(--text-muted);
}

.nav-item.active .badge {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.external-link {
  width: 14px !important;
  height: 14px !important;
  margin-left: auto;
}

/* Mobile Toggle */
.mobile-toggle {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  color: white;
  box-shadow: var(--shadow-lg);
  cursor: pointer;
  z-index: 200;
  transition: var(--transition);
}

.mobile-toggle:hover {
  transform: scale(1.1);
}

.mobile-toggle svg {
  width: 24px;
  height: 24px;
}

/* ============================================
   Main Content
   ============================================ */
.main {
  flex: 1;
  margin-left: var(--sidebar-width);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-card);
  position: sticky;
  top: 0;
  z-index: 50;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  flex-wrap: wrap;
}

.header-left h1 {
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.header-left p {
  font-size: 14px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
  max-width: 800px;
  justify-content: flex-end;
}

/* Search Container */
.search-container {
  position: relative;
  flex: 1;
  max-width: 500px;
}

.search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  color: var(--text-muted);
  pointer-events: none;
  transition: var(--transition);
}

.search-input {
  width: 100%;
  padding: 10px 220px 10px 44px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg-elevated);
  color: var(--text);
  font-family: inherit;
  font-size: 14px;
  outline: none;
  transition: var(--transition);
}

.search-input::placeholder {
  color: var(--text-muted);
}

.search-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-input:focus ~ .search-icon {
  color: var(--accent);
}

.search-clear {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: var(--transition);
  color: var(--text-muted);
}

.search-clear:hover {
  background: var(--bg-hover);
  color: var(--text);
}

.search-clear svg {
  width: 16px;
  height: 16px;
}

/* Ctrl+F style occurrence controls (global + local) */
.occurrence-controls {
  position: absolute;
  right: 44px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 2px 6px;
  border: 1px solid var(--border);
  background: var(--bg-card);
  border-radius: 8px;
  box-shadow: var(--shadow);
}

.occurrence-count {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  min-width: 86px;
  text-align: center;
  white-space: nowrap;
}

.occurrence-nav {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 26px;
  height: 26px;
  border-radius: 6px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: var(--transition);
}

.occurrence-nav:hover {
  background: var(--bg-hover);
  color: var(--text);
}

.occurrence-nav svg {
  width: 16px;
  height: 16px;
}

/* Find highlight marks */
mark.find-highlight {
  padding: 0 2px;
  border-radius: 3px;
}

mark.find-highlight.find-highlight--global {
  background: rgba(99, 102, 241, 0.25);
  color: var(--text);
}

mark.find-highlight.find-highlight--local {
  background: rgba(245, 158, 11, 0.25);
  color: var(--text);
}

mark.find-highlight.find-highlight--active-global {
  background: rgba(99, 102, 241, 0.45);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.18);
}

mark.find-highlight.find-highlight--active-local {
  background: rgba(245, 158, 11, 0.45);
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.18);
}

/* Search dropdown: global match counts + per-tab list */
.search-results-subheader {
  padding: 10px 16px;
  font-size: 12px;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
}

.search-results-tabs {
  padding: 10px 12px 12px;
  border-bottom: 1px solid var(--border);
}

.search-results-tabs-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin: 0 4px 8px;
}

.search-tab-match {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: var(--transition);
  text-align: left;
}

.search-tab-match:hover {
  background: var(--bg-hover);
  border-color: var(--border);
}

.search-tab-match-title {
  font-size: 13px;
  font-weight: 600;
}

.search-tab-match-count {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-muted);
  padding: 2px 8px;
  border-radius: 999px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
}

/* Search Results Dropdown */
.search-results {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  max-height: 500px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.search-results.active {
  display: block;
}

.search-results-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.search-result-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: var(--transition);
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item:hover {
  background: var(--bg-hover);
}

.search-result-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.search-result-title mark {
  background: rgba(99, 102, 241, 0.2);
  color: var(--accent);
  padding: 2px 4px;
  border-radius: 3px;
}

.search-result-context {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.search-result-context mark {
  background: rgba(99, 102, 241, 0.15);
  color: var(--text);
  padding: 1px 3px;
  border-radius: 2px;
  font-weight: 500;
}

.search-result-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  margin-top: 6px;
  background: var(--bg-elevated);
  color: var(--text-muted);
}

.search-results-header {
  padding: 10px 16px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  background: var(--bg-elevated);
}

.search-no-results {
  padding: 40px 16px;
  text-align: center;
  color: var(--text-secondary);
}

.search-no-results svg {
  width: 48px;
  height: 48px;
  margin: 0 auto 12px;
  opacity: 0.4;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  border: none;
  white-space: nowrap;
}

.btn-primary {
  background: var(--gradient-1);
  color: white;
}

.btn-primary:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--bg-elevated);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-hover);
}

.btn svg {
  width: 16px;
  height: 16px;
}

/* Content Area */
.content {
  padding: var(--content-padding);
  flex: 1;
}

.content > * {
  width: 100%;
  max-width: var(--content-max-width);
  margin-left: 0;
  margin-right: auto;
}

/* Page Transitions */
.page {
  display: none;
  animation: fadeIn 0.3s ease;
}

.page.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes highlight-pulse {
  0%,
  100% {
    background: transparent;
    box-shadow: none;
  }
  50% {
    background: var(--accent-bg);
    box-shadow: 0 0 0 4px var(--accent-bg);
  }
}

/* ============================================
   Dashboard Components
   ============================================ */
.welcome-card {
  background: var(--gradient-1);
  border-radius: var(--radius-lg);
  padding: 32px;
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
  color: white;
}

.welcome-card::before {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  width: 300px;
  height: 100%;
  background: url("data:image/svg+xml,%3Csvg width='300' height='200' viewBox='0 0 300 200' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='250' cy='100' r='120' fill='rgba(255,255,255,0.1)'/%3E%3Ccircle cx='300' cy='50' r='80' fill='rgba(255,255,255,0.05)'/%3E%3C/svg%3E");
  background-size: cover;
  pointer-events: none;
}

.welcome-card h2 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
  position: relative;
}

.welcome-card p {
  font-size: 16px;
  opacity: 0.9;
  position: relative;
}

.welcome-card .time {
  position: absolute;
  top: 32px;
  right: 32px;
  font-size: 14px;
  opacity: 0.8;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  transition: var(--transition);
}

.stat-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.stat-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}

.stat-icon.blue {
  background: var(--cyan-bg);
  color: var(--cyan);
}
.stat-icon.green {
  background: var(--success-bg);
  color: var(--success);
}
.stat-icon.orange {
  background: var(--warning-bg);
  color: var(--warning);
}
.stat-icon.purple {
  background: var(--purple-bg);
  color: var(--purple);
}

.stat-icon svg {
  width: 20px;
  height: 20px;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 13px;
  color: var(--text-secondary);
}

/* Section Title */
.section-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title svg {
  width: 20px;
  height: 20px;
  color: var(--accent);
}

/* Prescription Grid */
.prescription-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(280px, 320px));
  gap: 20px;
  margin-bottom: 32px;
  justify-content: start;
}

.prescription-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.prescription-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--gradient-1);
  opacity: 0;
  transition: opacity 0.2s ease;
}

.prescription-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.prescription-card:hover::before,
.prescription-card.active::before {
  opacity: 1;
}

.prescription-card.active {
  border-color: var(--accent);
  background: var(--bg-elevated);
}

.prescription-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 16px;
}

.prescription-icon.starter {
  background: var(--gradient-2);
}
.prescription-icon.stepup {
  background: var(--gradient-3);
}
.prescription-icon.repeat {
  background: var(--gradient-5);
}
.prescription-icon.transfer {
  background: var(--gradient-1);
}
.prescription-icon.switching {
  background: var(--gradient-4);
}

.prescription-icon svg {
  width: 24px;
  height: 24px;
  stroke: white;
}

.prescription-card h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 6px;
}

.prescription-card p {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.prescription-card .checks-count {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-top: 12px;
  padding: 6px 10px;
  background: var(--bg);
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
}

.prescription-card .checks-count svg {
  width: 14px;
  height: 14px;
}

/* ============================================
   Checklist Components
   ============================================ */
.checklist-panel {
  display: none;
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.checklist-panel.active {
  display: block;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(24px) scale(0.98);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.checklist-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 28px;
  padding: 24px 28px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(6, 182, 212, 0.04));
  border: 1px solid rgba(99, 102, 241, 0.15);
  border-radius: 20px;
  flex-wrap: wrap;
  gap: 20px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(255, 255, 255, 0.03) inset;
}

.checklist-header::after {
  content: "";
  position: absolute;
  top: -50%;
  right: -20%;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(99, 102, 241, 0.08) 0%, transparent 70%);
  pointer-events: none;
}

[data-theme="light"] .checklist-header {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(6, 182, 212, 0.03));
  border-color: rgba(99, 102, 241, 0.12);
}

.checklist-title {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  position: relative;
  z-index: 1;
}

.checklist-title h2 {
  font-size: 22px;
  font-weight: 800;
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.type-badge {
  padding: 6px 16px;
  border-radius: 24px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.02em;
  text-transform: uppercase;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid transparent;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.type-badge:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.type-badge.starter {
  background: linear-gradient(135deg, var(--success-bg), rgba(34, 197, 94, 0.2));
  color: var(--success);
  border-color: rgba(34, 197, 94, 0.3);
}
.type-badge.stepup {
  background: linear-gradient(135deg, var(--warning-bg), rgba(245, 158, 11, 0.2));
  color: var(--warning);
  border-color: rgba(245, 158, 11, 0.3);
}
.type-badge.repeat {
  background: linear-gradient(135deg, var(--cyan-bg), rgba(6, 182, 212, 0.2));
  color: var(--cyan);
  border-color: rgba(6, 182, 212, 0.3);
}
.type-badge.transfer {
  background: linear-gradient(135deg, var(--purple-bg), rgba(168, 85, 247, 0.2));
  color: var(--purple);
  border-color: rgba(168, 85, 247, 0.3);
}

/* Progress Ring */
.progress-ring {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 16px;
  background: rgba(34, 197, 94, 0.08);
  border-radius: 16px;
  border: 1px solid rgba(34, 197, 94, 0.15);
  position: relative;
  z-index: 1;
  transition: all 0.3s ease;
}

.progress-ring:hover {
  background: rgba(34, 197, 94, 0.12);
  border-color: rgba(34, 197, 94, 0.25);
}

.progress-circle {
  width: 64px;
  height: 64px;
  position: relative;
  filter: drop-shadow(0 2px 8px rgba(34, 197, 94, 0.2));
}

.progress-circle svg {
  transform: rotate(-90deg);
}

.progress-circle .bg {
  fill: none;
  stroke: var(--border);
  stroke-width: 5;
  opacity: 0.5;
}

.progress-circle .progress {
  fill: none;
  stroke: url(#progressGradient);
  stroke-width: 5;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  filter: drop-shadow(0 0 6px rgba(34, 197, 94, 0.4));
}

.progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 15px;
  font-weight: 800;
  letter-spacing: -0.02em;
  color: var(--success);
}

.progress-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  line-height: 1.4;
}

/* Checklist Section */
.checklist-section {
  --section-accent: var(--accent);
  --section-accent-bg: rgba(99, 102, 241, 0.12);
  --section-glow: rgba(99, 102, 241, 0.15);
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 18px;
  margin-bottom: 20px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(255, 255, 255, 0.02) inset;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.checklist-section:hover {
  border-color: var(--section-accent);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px var(--section-glow),
    0 0 24px var(--section-glow);
  transform: translateY(-2px);
}

/* Accent colors (Chrome/Edge/Safari support) */
.checklist-section:has(.section-header-icon.blue) {
  --section-accent: var(--cyan);
  --section-accent-bg: var(--cyan-bg);
  --section-glow: rgba(6, 182, 212, 0.2);
}

.checklist-section:has(.section-header-icon.green) {
  --section-accent: var(--success);
  --section-accent-bg: var(--success-bg);
  --section-glow: rgba(34, 197, 94, 0.2);
}

.checklist-section:has(.section-header-icon.orange) {
  --section-accent: var(--warning);
  --section-accent-bg: var(--warning-bg);
  --section-glow: rgba(245, 158, 11, 0.2);
}

.checklist-section:has(.section-header-icon.purple) {
  --section-accent: var(--purple);
  --section-accent-bg: var(--purple-bg);
  --section-glow: rgba(168, 85, 247, 0.2);
}

.section-header {
  padding: 18px 24px;
  background: linear-gradient(135deg, var(--section-accent-bg) 0%, transparent 60%);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 14px;
  position: relative;
}

.section-header::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 5px;
  background: var(--section-accent);
}

.section-header::after {
  content: "";
  position: absolute;
  right: 24px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--section-accent);
  opacity: 0.6;
  box-shadow: 0 0 8px var(--section-accent);
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%,
  100% {
    opacity: 0.4;
    transform: translateY(-50%) scale(1);
  }
  50% {
    opacity: 0.8;
    transform: translateY(-50%) scale(1.2);
  }
}

.section-header-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.section-header-icon:hover {
  transform: scale(1.05);
}

.section-header-icon.blue {
  background: linear-gradient(135deg, #06b6d4, #0891b2);
  color: #fff;
}
.section-header-icon.green {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: #fff;
}
.section-header-icon.orange {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #fff;
}
.section-header-icon.purple {
  background: linear-gradient(135deg, #a855f7, #9333ea);
  color: #fff;
}

.section-header-icon svg {
  width: 18px;
  height: 18px;
  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
}

.section-header span {
  font-size: 15px;
  font-weight: 700;
  letter-spacing: -0.01em;
  color: var(--text);
  line-height: 1.3;
}

.section-header span::after {
  display: none;
}

.section-progress {
  margin-left: auto;
  font-size: 13px;
  font-weight: 700;
  color: var(--section-accent);
  padding: 4px 12px;
  background: var(--section-accent-bg);
  border-radius: 20px;
}

/* Check Items */
.check-item {
  display: flex;
  align-items: flex-start;
  justify-content: flex-start;
  gap: 18px;
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  text-align: left;

  /* Default checked accent (overridden per section via data-accent) */
  --check-accent: var(--success);
  --check-accent-bg: var(--success-bg);
  --check-glow: rgba(34, 197, 94, 0.15);
}

.check-item::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 0;
  background: var(--check-accent);
  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.check-item[data-accent="blue"] {
  --check-accent: var(--cyan);
  --check-accent-bg: var(--cyan-bg);
  --check-glow: rgba(6, 182, 212, 0.15);
}

.check-item[data-accent="green"] {
  --check-accent: var(--success);
  --check-accent-bg: var(--success-bg);
  --check-glow: rgba(34, 197, 94, 0.15);
}

.check-item[data-accent="orange"] {
  --check-accent: var(--warning);
  --check-accent-bg: var(--warning-bg);
  --check-glow: rgba(245, 158, 11, 0.15);
}

.check-item[data-accent="purple"] {
  --check-accent: var(--purple);
  --check-accent-bg: var(--purple-bg);
  --check-glow: rgba(168, 85, 247, 0.15);
}

.check-item::after {
  content: "";
  position: absolute;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  width: 24px;
  height: 24px;
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 5l7 7-7 7'/%3E%3C/svg%3E")
    center/contain no-repeat;
  opacity: 0.3;
  transition: all 0.3s ease;
}

.check-item:last-child {
  border-bottom: none;
}

.check-item:hover {
  background: linear-gradient(90deg, var(--check-accent-bg), transparent 80%);
}

.check-item:hover::after {
  opacity: 0.6;
  transform: translateY(-50%) translateX(4px);
}

.check-item:hover::before {
  width: 6px;
}

.checklist-section .check-item:nth-of-type(even):not(.checked) {
  background: rgba(255, 255, 255, 0.015);
}

[data-theme="light"] .checklist-section .check-item:nth-of-type(even):not(.checked) {
  background: rgba(0, 0, 0, 0.015);
}

.check-item.checked {
  background: linear-gradient(
    90deg,
    var(--check-accent-bg) 0%,
    rgba(34, 197, 94, 0.02) 100%
  );
}

.check-item.checked::before {
  width: 6px;
  background: var(--check-accent);
  box-shadow: 0 0 12px var(--check-glow);
}

.check-item.checked::after {
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2322c55e' stroke-width='3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M5 13l4 4L19 7'/%3E%3C/svg%3E")
    center/contain no-repeat;
  opacity: 1;
  animation: checkmark-pop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes checkmark-pop {
  0% {
    transform: translateY(-50%) scale(0);
    opacity: 0;
  }
  50% {
    transform: translateY(-50%) scale(1.2);
  }
  100% {
    transform: translateY(-50%) scale(1);
    opacity: 1;
  }
}

.checkbox {
  width: 26px;
  height: 26px;
  border: 2.5px solid var(--border);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  margin-top: 0;
  background: rgba(255, 255, 255, 0.03);
  position: relative;
  z-index: 1;
}

.checkbox::before {
  content: "";
  position: absolute;
  inset: -4px;
  border-radius: 14px;
  background: var(--check-accent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.check-item:hover .checkbox {
  border-color: var(--check-accent);
  transform: scale(1.05);
}

.check-item:hover .checkbox::before {
  opacity: 0.1;
}

.check-item.checked .checkbox {
  background: linear-gradient(
    135deg,
    var(--check-accent),
    color-mix(in srgb, var(--check-accent) 70%, #000)
  );
  border-color: var(--check-accent);
  box-shadow: 0 4px 12px var(--check-glow), 0 0 0 3px var(--check-accent-bg);
  animation: checkbox-check 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes checkbox-check {
  0% {
    transform: scale(1);
  }
  30% {
    transform: scale(0.9);
  }
  60% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}

.checkbox svg {
  width: 16px;
  height: 16px;
  stroke: white;
  stroke-width: 3;
  opacity: 0;
  transform: scale(0) rotate(-45deg);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
  position: relative;
  z-index: 1;
}

.check-item.checked .checkbox svg {
  opacity: 1;
  transform: scale(1) rotate(0);
}

.check-content {
  flex: 1;
  position: relative;
  z-index: 1;
  padding-right: 32px;
  text-align: left;
}

.check-label {
  font-size: 14.5px;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--text);
  line-height: 1.4;
  letter-spacing: -0.01em;
  text-align: left;
}

.check-item.checked .check-label {
  color: var(--check-accent);
}

.check-hint {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.6;
  text-align: left;
}

.check-hint.warning,
.check-hint.danger {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 12px;
  margin-top: 8px;
  border: 1px solid transparent;
  font-weight: 500;
}

.check-hint.warning::before,
.check-hint.danger::before {
  content: "";
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.check-hint.warning {
  color: var(--warning);
  background: linear-gradient(135deg, var(--warning-bg), rgba(245, 158, 11, 0.08));
  border-color: rgba(245, 158, 11, 0.25);
}

.check-hint.warning::before {
  background: var(--warning);
  box-shadow: 0 0 8px var(--warning);
}

.check-hint.danger {
  color: var(--danger);
  background: linear-gradient(135deg, var(--danger-bg), rgba(239, 68, 68, 0.08));
  border-color: rgba(239, 68, 68, 0.25);
}

.check-hint.danger::before {
  background: var(--danger);
  box-shadow: 0 0 8px var(--danger);
}

.check-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12.5px;
  font-weight: 600;
  color: var(--accent);
  margin-top: 10px;
  cursor: pointer;
  text-decoration: none;
  padding: 6px 12px;
  background: rgba(99, 102, 241, 0.08);
  border-radius: 8px;
  transition: all 0.2s ease;
}

.check-link:hover {
  background: rgba(99, 102, 241, 0.15);
  transform: translateX(2px);
}

.check-link svg {
  width: 12px;
  height: 12px;
}

/* Status Bar */
.status-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 24px 28px;
  background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99, 102, 241, 0.02) 100%);
  border: 1px solid var(--border);
  border-radius: 18px;
  margin-top: 28px;
  gap: 20px;
  flex-wrap: wrap;
  position: relative;
  overflow: hidden;
}

.status-bar::before {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--warning) 0%, var(--success) 100%);
  opacity: 0.3;
}

.status-info {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

.status-badge {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: -0.01em;
  border: 1px solid transparent;
  transition: all 0.3s ease;
}

.status-badge.pending {
  background: linear-gradient(135deg, var(--warning-bg), rgba(245, 158, 11, 0.15));
  color: var(--warning);
  border-color: rgba(245, 158, 11, 0.3);
  animation: pending-pulse 2s ease-in-out infinite;
}

@keyframes pending-pulse {
  0%,
  100% {
    box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(245, 158, 11, 0);
  }
}

.status-badge.complete {
  background: linear-gradient(135deg, var(--success-bg), rgba(34, 197, 94, 0.15));
  color: var(--success);
  border-color: rgba(34, 197, 94, 0.3);
  box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
}

.status-badge svg {
  width: 18px;
  height: 18px;
}

.btn-actions {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
}

.btn-reset {
  background: transparent;
  color: var(--text-secondary);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 10px 20px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn-reset:hover {
  background: var(--bg-elevated);
  color: var(--text);
  border-color: var(--text-muted);
  transform: translateY(-1px);
}

.btn-sign {
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  color: white;
  opacity: 0.35;
  pointer-events: none;
  border-radius: 12px;
  padding: 10px 24px;
  font-weight: 700;
  border: none;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-sign.ready {
  opacity: 1;
  pointer-events: auto;
  animation: ready-glow 2s ease-in-out infinite;
}

@keyframes ready-glow {
  0%,
  100% {
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  }
  50% {
    box-shadow: 0 4px 24px rgba(34, 197, 94, 0.5), 0 0 0 4px rgba(34, 197, 94, 0.1);
  }
}

.btn-sign.ready:hover {
  background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
}

/* ============================================
   Checklist Responsive Styles
   ============================================ */

/* Tablet (768px - 1024px) */
@media (max-width: 1024px) {
  .checklist-header {
    padding: 20px 22px;
    gap: 16px;
  }

  .checklist-title h2 {
    font-size: 20px;
  }

  .progress-circle {
    width: 56px;
    height: 56px;
  }

  .progress-ring {
    padding: 10px 14px;
  }

  .checklist-section {
    border-radius: 14px;
  }

  .section-header {
    padding: 14px 20px;
  }

  .section-header-icon {
    width: 32px;
    height: 32px;
  }

  .check-item {
    padding: 16px 20px;
    gap: 14px;
  }

  .status-bar {
    padding: 20px 22px;
    border-radius: 14px;
  }
}

/* Mobile (max 768px) */
@media (max-width: 768px) {
  .checklist-header {
    flex-direction: column;
    align-items: flex-start;
    padding: 18px 18px;
    gap: 16px;
    border-radius: 16px;
  }

  .checklist-header::after {
    width: 200px;
    height: 200px;
    top: -30%;
    right: -30%;
  }

  .checklist-title {
    width: 100%;
    flex-wrap: wrap;
    gap: 12px;
  }

  .checklist-title h2 {
    font-size: 18px;
    width: 100%;
  }

  .type-badge {
    padding: 5px 12px;
    font-size: 11px;
  }

  .progress-ring {
    width: 100%;
    justify-content: center;
    padding: 12px 14px;
    border-radius: 12px;
  }

  .progress-circle {
    width: 52px;
    height: 52px;
  }

  .progress-text {
    font-size: 13px;
  }

  .progress-label {
    font-size: 12px;
    text-align: center;
  }

  .checklist-section {
    border-radius: 12px;
    margin-bottom: 14px;
  }

  .section-header {
    padding: 12px 14px;
    gap: 10px;
  }

  .section-header::before {
    width: 4px;
  }

  .section-header::after {
    right: 14px;
    width: 6px;
    height: 6px;
  }

  .section-header-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
  }

  .section-header-icon svg {
    width: 14px;
    height: 14px;
  }

  .section-header span {
    font-size: 13px;
    flex: 1;
    min-width: 0;
  }

  .section-progress {
    font-size: 11px;
    padding: 3px 8px;
  }

  .check-item {
    padding: 14px 14px;
    gap: 12px;
  }

  .check-item::after {
    right: 10px;
    width: 18px;
    height: 18px;
  }

  .checkbox {
    width: 22px;
    height: 22px;
    border-radius: 8px;
    border-width: 2px;
  }

  .checkbox svg {
    width: 13px;
    height: 13px;
  }

  .check-content {
    padding-right: 24px;
  }

  .check-label {
    font-size: 13.5px;
    margin-bottom: 4px;
  }

  .check-hint {
    font-size: 12px;
    line-height: 1.5;
  }

  .check-hint.warning,
  .check-hint.danger {
    padding: 6px 10px;
    font-size: 11.5px;
    border-radius: 10px;
    margin-top: 6px;
  }

  .check-link {
    font-size: 11.5px;
    padding: 5px 10px;
    margin-top: 8px;
  }

  .status-bar {
    flex-direction: column;
    padding: 18px 16px;
    gap: 16px;
    border-radius: 14px;
    margin-top: 20px;
  }

  .status-info {
    width: 100%;
    justify-content: center;
    gap: 12px;
  }

  .status-badge {
    padding: 8px 14px;
    font-size: 12.5px;
    border-radius: 10px;
  }

  .status-badge svg {
    width: 15px;
    height: 15px;
  }

  .btn-actions {
    width: 100%;
    justify-content: stretch;
    gap: 10px;
  }

  .btn-reset,
  .btn-sign {
    flex: 1;
    justify-content: center;
    padding: 10px 16px;
    font-size: 13px;
    border-radius: 10px;
  }
}

/* Small Mobile (max 480px) */
@media (max-width: 480px) {
  .checklist-header {
    padding: 14px 14px;
    border-radius: 14px;
  }

  .checklist-title h2 {
    font-size: 16px;
  }

  .type-badge {
    font-size: 10px;
    padding: 4px 10px;
  }

  .progress-circle {
    width: 46px;
    height: 46px;
  }

  .progress-text {
    font-size: 12px;
  }

  .checklist-section {
    border-radius: 10px;
    margin-bottom: 12px;
  }

  .section-header {
    padding: 10px 12px;
    gap: 8px;
  }

  .section-header-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
  }

  .section-header-icon svg {
    width: 12px;
    height: 12px;
  }

  .section-header span {
    font-size: 12px;
  }

  .check-item {
    padding: 12px 12px;
    gap: 10px;
  }

  .checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
  }

  .checkbox svg {
    width: 11px;
    height: 11px;
  }

  .check-label {
    font-size: 12.5px;
  }

  .check-hint {
    font-size: 11px;
  }

  .status-bar {
    padding: 14px 12px;
    gap: 14px;
  }

  .status-badge {
    padding: 6px 12px;
    font-size: 11.5px;
  }

  .btn-reset,
  .btn-sign {
    padding: 9px 14px;
    font-size: 12px;
  }
}

/* ============================================
   Protocol Pages
   ============================================ */
.protocol-page {
  max-width: 900px;
}

/* ============================================
   SCR Protocol (Enhanced Visuals)
   ============================================ */
.scr-protocol {
  max-width: 980px;
}

.protocol-hero {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(6, 182, 212, 0.12));
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: var(--radius-lg);
  padding: 18px 18px;
  margin-bottom: 16px;
}

[data-theme="light"] .protocol-hero {
  border-color: rgba(0, 0, 0, 0.08);
}

.protocol-hero-title {
  font-size: 14px;
  font-weight: 800;
  letter-spacing: 0.02em;
  text-transform: uppercase;
  margin-bottom: 8px;
  color: var(--text);
}

.protocol-hero-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 14px;
}

.scr-flow {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap: 12px;
}

.scr-flow-card {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius);
  padding: 14px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

[data-theme="light"] .scr-flow-card {
  background: rgba(255, 255, 255, 0.9);
  border-color: rgba(0, 0, 0, 0.08);
}

.scr-flow-card::before {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  height: 3px;
  opacity: 0.95;
}

.scr-flow-card.blue::before {
  background: var(--gradient-5);
}

.scr-flow-card.green::before {
  background: var(--gradient-2);
}

.scr-flow-card.orange::before {
  background: var(--gradient-3);
}

.scr-flow-card.purple::before {
  background: var(--gradient-1);
}

.scr-flow-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
  border-color: rgba(255, 255, 255, 0.18);
}

.scr-flow-top {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.scr-flow-title {
  font-size: 14px;
  font-weight: 800;
  color: var(--text);
}

.scr-flow-text {
  font-size: 12.5px;
  color: var(--text-secondary);
  line-height: 1.55;
}

.scr-chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px 9px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: 0.02em;
  border: 1px solid transparent;
  white-space: nowrap;
}

.scr-chip.green {
  background: var(--success-bg);
  color: var(--success);
  border-color: rgba(34, 197, 94, 0.35);
}

.scr-chip.blue {
  background: var(--cyan-bg);
  color: var(--cyan);
  border-color: rgba(6, 182, 212, 0.35);
}

.scr-chip.orange {
  background: var(--warning-bg);
  color: var(--warning);
  border-color: rgba(245, 158, 11, 0.35);
}

.scr-chip.purple {
  background: var(--purple-bg);
  color: var(--purple);
  border-color: rgba(168, 85, 247, 0.35);
}

.scr-outcomes {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
}

.scr-outcome-card {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  transition: var(--transition);
}

.scr-outcome-card:hover {
  border-color: rgba(99, 102, 241, 0.45);
  box-shadow: var(--shadow);
}

.scr-outcome-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 6px;
}

.scr-outcome-text {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.55;
}

.scr-two-col {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 14px;
}

@media (max-width: 820px) {
  .scr-two-col {
    grid-template-columns: 1fr;
  }
}

.protocol-ol {
  margin: 0;
  padding-left: 18px;
}

.protocol-ol li {
  padding: 6px 0;
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.55;
  border-bottom: 1px solid var(--border);
}

.protocol-ol li:last-child {
  border-bottom: none;
}

details.accordion {
  margin-top: 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
  transition: all 0.3s ease;
}

details.accordion:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.06);
  border-color: rgba(99, 102, 241, 0.3);
}

details.accordion summary {
  cursor: pointer;
  user-select: none;
  padding: 20px 24px;
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  list-style: none;
  position: relative;
  background: linear-gradient(180deg, rgba(99, 102, 241, 0.04) 0%, transparent 100%);
  transition: all 0.2s ease;
}

details.accordion summary:hover {
  background: linear-gradient(
    180deg,
    rgba(99, 102, 241, 0.08) 0%,
    rgba(99, 102, 241, 0.02) 100%
  );
}

details.accordion summary::-webkit-details-marker {
  display: none;
}

details.accordion summary::after {
  content: "+";
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px;
  height: 28px;
  display: grid;
  place-items: center;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
  color: #ffffff;
  font-weight: 700;
  font-size: 18px;
  box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
  transition: all 0.3s ease;
}

details.accordion summary:hover::after {
  box-shadow: 0 3px 8px rgba(99, 102, 241, 0.4);
  transform: translateY(-50%) scale(1.05);
}

details.accordion[open] summary::after {
  content: "";
  background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
  box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
}

.accordion-body {
  padding: 24px;
  border-top: 1px solid rgba(99, 102, 241, 0.1);
  background: var(--bg-card);
}

.scr-questions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
}

.scr-question-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
}

.scr-question-title {
  font-size: 13px;
  font-weight: 800;
  margin-bottom: 8px;
  color: var(--text);
}

.scr-copy-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: 14px;
  margin-bottom: 8px;
}

.scr-copy-title {
  font-size: 13px;
  font-weight: 800;
  color: var(--text);
}

.macro-box {
  margin: 0;
  padding: 12px 14px;
  border-radius: var(--radius);
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text-secondary);
  font-size: 12.5px;
  line-height: 1.55;
  white-space: pre-wrap;
}

[data-theme="light"] .macro-box {
  background: rgba(0, 0, 0, 0.03);
  border-color: rgba(0, 0, 0, 0.08);
}

.copy-btn {
  padding: 8px 12px;
  font-size: 12.5px;
}

.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  margin-bottom: 24px;
  padding: 8px 0;
  transition: var(--transition);
}

.back-btn:hover {
  color: var(--text);
}

.back-btn svg {
  width: 16px;
  height: 16px;
}

.protocol-page-header {
  margin-bottom: 22px;
}

/* Page headers that include a dedicated local search bar (e.g., Contraindications) */
.page-header-with-search {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 22px;
}

.page-header-with-search .protocol-page-header {
  margin-bottom: 0;
  flex: 1 1 340px;
  min-width: 260px;
}

.local-search-container {
  position: relative;
  flex: 0 1 420px;
  min-width: 260px;
}

.local-search-input {
  width: 100%;
  padding: 10px 220px 10px 44px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg-elevated);
  color: var(--text);
  font-family: inherit;
  font-size: 14px;
  transition: var(--transition);
}

.local-search-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: var(--focus-ring);
}

.local-search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  width: 18px;
  height: 18px;
  pointer-events: none;
}

.local-search-clear {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  display: none;
  transition: var(--transition);
}

.local-search-clear:hover {
  background: var(--bg-hover);
  color: var(--text);
}

.local-search-clear svg {
  width: 16px;
  height: 16px;
}

@media (max-width: 820px) {
  .local-search-container {
    flex: 1 1 100%;
    max-width: none;
  }
}

.page-h1 {
  font-size: 24px;
  font-weight: 800;
  letter-spacing: -0.02em;
  line-height: 1.2;
  margin-bottom: 8px;
}

.page-lead {
  color: var(--text-secondary);
  font-size: 13.5px;
  line-height: 1.55;
}

/* ============================================
   Protocol Tabs - Premium Professional Design
   ============================================ */

.protocol-tabs {
  display: inline-flex;
  gap: 10px;
  margin: 0 0 40px;
  padding: 6px;
  background: rgba(248, 250, 252, 0.6);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(226, 232, 240, 0.8);
  border-radius: 16px;
  flex-wrap: wrap;
  position: sticky;
  top: 0;
  z-index: 10;
  max-width: fit-content;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
}

[data-theme="dark"] .protocol-tabs {
  background: rgba(45, 55, 72, 0.7);
  border-color: rgba(74, 85, 104, 0.6);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.protocol-tab {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 28px;
  font-size: 14.5px;
  font-weight: 600;
  letter-spacing: -0.01em;
  color: #64748b;
  background: transparent;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  white-space: nowrap;
  overflow: hidden;
}

[data-theme="dark"] .protocol-tab {
  color: #94a3b8;
}

.protocol-tab::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0);
  border-radius: 12px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: -1;
}

.protocol-tab svg {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  opacity: 0.65;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Smooth hover effect */
.protocol-tab:hover:not(.active) {
  color: #475569;
  transform: translateY(-1px);
}

.protocol-tab:hover:not(.active)::before {
  background: rgba(255, 255, 255, 0.8);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

[data-theme="dark"] .protocol-tab:hover:not(.active) {
  color: #cbd5e1;
}

[data-theme="dark"] .protocol-tab:hover:not(.active)::before {
  background: rgba(71, 85, 105, 0.5);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.protocol-tab:hover:not(.active) svg {
  opacity: 0.85;
  transform: scale(1.05);
}

/* Active tab - Elegant and prominent */
.protocol-tab.active {
  color: #ffffff;
  font-weight: 650;
}

.protocol-tab.active::before {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  box-shadow:
    0 4px 14px rgba(102, 126, 234, 0.25),
    0 2px 6px rgba(118, 75, 162, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

.protocol-tab.active svg {
  opacity: 1;
  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
}

.protocol-tab.active:hover {
  transform: translateY(-1px);
}

.protocol-tab.active:hover::before {
  background: linear-gradient(135deg, #5a67d8 0%, #6b46a1 100%);
  box-shadow:
    0 6px 18px rgba(102, 126, 234, 0.3),
    0 3px 8px rgba(118, 75, 162, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

/* Tab content containers */
.protocol-tab-content {
  display: none;
  animation: fadeInContent 0.3s ease-out;
}

.protocol-tab-content.active {
  display: block;
}

@keyframes fadeInContent {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Protocol Cards - Clean Readable Design */
.protocol-card {
  --card-accent: #667eea;
  --card-accent-light: rgba(102, 126, 234, 0.04);
  background: #ffffff;
  border: 1.5px solid #e2e8f0;
  border-left: 4px solid var(--card-accent);
  border-radius: 12px;
  padding: 36px 40px;
  margin-bottom: 32px;
  transition: box-shadow 0.2s ease, transform 0.2s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
  position: relative;
}

[data-theme="dark"] .protocol-card {
  background: #2d3748;
  border-color: #4a5568;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

/* Color variants - clean borders */
.protocol-card:has(.icon.blue) {
  --card-accent: #3b82f6;
  --card-accent-light: rgba(59, 130, 246, 0.04);
}

.protocol-card:has(.icon.green) {
  --card-accent: #10b981;
  --card-accent-light: rgba(16, 185, 129, 0.04);
}

.protocol-card:has(.icon.orange) {
  --card-accent: #f59e0b;
  --card-accent-light: rgba(245, 158, 11, 0.04);
}

.protocol-card:has(.icon.red) {
  --card-accent: #ef4444;
  --card-accent-light: rgba(239, 68, 68, 0.04);
}

.protocol-card:has(.icon.purple) {
  --card-accent: #8b5cf6;
  --card-accent-light: rgba(139, 92, 246, 0.04);
}

.protocol-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transform: translateY(-2px);
}

[data-theme="dark"] .protocol-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.protocol-title {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.015em;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f1f5f9;
  color: #1a202c;
  line-height: 1.4;
}

[data-theme="dark"] .protocol-title {
  color: #f7fafc;
  border-bottom-color: #374151;
}

.protocol-title .icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: box-shadow 0.2s ease;
  flex-shrink: 0;
}

.protocol-title .icon.blue {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #fff;
}
.protocol-title .icon.green {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: #fff;
}
.protocol-title .icon.orange {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: #fff;
}
.protocol-title .icon.red {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: #fff;
}
.protocol-title .icon.purple {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  color: #fff;
}

.protocol-title .icon svg {
  width: 20px;
  height: 20px;
  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.15));
}

.protocol-text {
  font-size: 15.5px;
  color: var(--text-secondary);
  line-height: 1.8;
  margin-bottom: 18px;
  max-width: 85ch;
  letter-spacing: 0.002em;
}

.protocol-text:last-child {
  margin-bottom: 0;
}

.protocol-text strong {
  color: var(--text);
  font-weight: 600;
  letter-spacing: 0;
}

.protocol-list {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.protocol-list li {
  position: relative;
  padding: 14px 18px 14px 32px;
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.75;
  background: #fafbfc;
  border-left: 3px solid var(--card-accent, var(--accent));
  border-radius: 6px;
  transition: box-shadow 0.2s ease;
  border: 1px solid #f1f5f9;
  border-left-width: 3px;
}

[data-theme="dark"] .protocol-list li {
  background: #374151;
  border-color: #4b5563;
}

.protocol-list li:hover {
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

.protocol-list li::before {
  content: "";
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 6px;
  height: 6px;
  background: var(--card-accent, var(--accent));
  border-radius: 50%;
}

.protocol-list li strong {
  color: var(--text);
  font-weight: 600;
  letter-spacing: 0;
}

.protocol-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin: 24px 0;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
  table-layout: auto;
  background: var(--bg-card);
  display: table;
}

.protocol-table th,
.protocol-table td {
  padding: 22px 26px;
  text-align: left;
  border-bottom: 1px solid rgba(99, 102, 241, 0.12);
  border-right: 1px solid rgba(99, 102, 241, 0.08);
  font-size: 14.5px;
  line-height: 1.9;
  vertical-align: top;
  word-wrap: break-word;
  overflow-wrap: break-word;
  min-width: 120px;
}

.protocol-table th:last-child,
.protocol-table td:last-child {
  border-right: none;
}

.protocol-table th {
  background: linear-gradient(
    180deg,
    rgba(99, 102, 241, 0.08) 0%,
    rgba(99, 102, 241, 0.04) 100%
  );
  font-weight: 700;
  font-size: 11.5px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--accent);
  border-bottom: 2px solid rgba(99, 102, 241, 0.25);
  position: sticky;
  top: 0;
  z-index: 10;
  white-space: normal;
  padding: 18px 26px;
}

/* Column-specific styling for 5-column tables - use min-width instead of fixed width */
.protocol-table tr:has(th:nth-child(5)) th:nth-child(1),
.protocol-table tr:has(th:nth-child(5)) ~ tr td:nth-child(1) {
  min-width: 180px;
}

.protocol-table tr:has(th:nth-child(5)) th:nth-child(2),
.protocol-table tr:has(th:nth-child(5)) ~ tr td:nth-child(2) {
  min-width: 130px;
  text-align: left;
}

.protocol-table tr:has(th:nth-child(5)) th:nth-child(3),
.protocol-table tr:has(th:nth-child(5)) ~ tr td:nth-child(3) {
  min-width: 110px;
  text-align: center;
}

.protocol-table tr:has(th:nth-child(5)) th:nth-child(4),
.protocol-table tr:has(th:nth-child(5)) ~ tr td:nth-child(4) {
  min-width: 320px;
}

.protocol-table tr:has(th:nth-child(5)) th:nth-child(5),
.protocol-table tr:has(th:nth-child(5)) ~ tr td:nth-child(5) {
  min-width: 320px;
}

/* Column-specific styling for 2-column tables (Table 1) */
.protocol-table tr:has(th:nth-child(2):last-child) th:nth-child(1),
.protocol-table tr:has(th:nth-child(2):last-child) ~ tr td:nth-child(1) {
  min-width: 400px;
}

.protocol-table tr:has(th:nth-child(2):last-child) th:nth-child(2),
.protocol-table tr:has(th:nth-child(2):last-child) ~ tr td:nth-child(2) {
  min-width: 150px;
  text-align: center;
}

.protocol-table td {
  color: var(--text);
  background: var(--bg-card);
}

.protocol-table tbody tr {
  border-left: 3px solid transparent;
  transition: all 0.2s ease;
}

.protocol-table tbody tr:nth-child(even) td {
  background: rgba(99, 102, 241, 0.015);
}

.protocol-table tbody tr:hover {
  border-left-color: var(--accent);
  background: rgba(99, 102, 241, 0.02);
}

.protocol-table tr:last-child td {
  border-bottom: none;
}

/* Condition column styling */
.protocol-table td:first-child {
  font-weight: 600;
  color: var(--text);
}

.protocol-table td:first-child strong {
  font-size: 15px;
  display: block;
  margin-bottom: 10px;
  color: var(--text);
  line-height: 1.4;
}

/* Decision outcomes styling */
.protocol-table .decision-reject {
  color: #ffffff;
  font-weight: 700;
  display: block;
  padding: 9px 18px;
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  border-radius: 6px;
  font-size: 11.5px;
  letter-spacing: 0.8px;
  box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
  text-transform: uppercase;
  white-space: nowrap;
  margin: 7px 0;
  width: fit-content;
  max-width: 100%;
}

.protocol-table .decision-prescribe {
  color: #ffffff;
  font-weight: 700;
  display: block;
  padding: 9px 18px;
  background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
  border-radius: 6px;
  font-size: 11.5px;
  letter-spacing: 0.8px;
  box-shadow: 0 2px 4px rgba(22, 163, 74, 0.3);
  text-transform: uppercase;
  white-space: nowrap;
  margin: 7px 0;
  width: fit-content;
  max-width: 100%;
}

.protocol-table .decision-clinical {
  color: #ffffff;
  font-weight: 700;
  display: block;
  padding: 9px 18px;
  background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
  border-radius: 6px;
  font-size: 11.5px;
  letter-spacing: 0.8px;
  box-shadow: 0 2px 4px rgba(234, 88, 12, 0.3);
  text-transform: uppercase;
  white-space: nowrap;
  margin: 7px 0;
  width: fit-content;
  max-width: 100%;
}

/* Checklist styling */
.protocol-table .checklist-item {
  display: flex;
  align-items: flex-start;
  margin: 11px 0;
  line-height: 1.85;
  padding-left: 2px;
  font-size: 13.5px;
}

.protocol-table .checklist-item::before {
  content: "";
  color: var(--accent);
  font-weight: bold;
  margin-right: 8px;
  flex-shrink: 0;
  font-size: 14px;
  margin-top: 1px;
}

/* Timeframe column styling */
.protocol-table td:nth-child(2) {
  font-weight: 600;
  font-size: 14px;
}

/* Macro badge styling */
.protocol-table .tag {
  font-size: 12px;
  padding: 8px 16px;
  font-weight: 700;
  letter-spacing: 0.4px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
  white-space: nowrap;
  display: block;
  width: fit-content;
  max-width: 100%;
  margin: 5px 0;
}

/* Table row zebra striping for better readability */
.protocol-table tbody tr:nth-child(even) {
  background: rgba(99, 102, 241, 0.01);
}

/* Wrapper for responsive tables */
.table-wrapper {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 20px 0;
  border-radius: 10px;
}

.table-wrapper .protocol-table,
.table-wrapper .dose-table {
  margin: 0;
}

/* Responsive table design */
@media (max-width: 1600px) {
  .protocol-table th,
  .protocol-table td {
    padding: 18px 20px;
    font-size: 14px;
  }

  .protocol-table th {
    padding: 16px 20px;
  }

  .protocol-table .checklist-item {
    font-size: 13px;
  }

  .protocol-table td:first-child strong {
    font-size: 14.5px;
  }
}

@media (max-width: 1400px) {
  .protocol-table th,
  .protocol-table td {
    padding: 16px 18px;
    font-size: 13.5px;
  }

  .protocol-table th {
    padding: 15px 18px;
  }

  .protocol-table .decision-reject,
  .protocol-table .decision-prescribe,
  .protocol-table .decision-clinical {
    padding: 7px 14px;
    font-size: 11px;
  }

  .protocol-table td:first-child strong {
    font-size: 14px;
  }
}

@media (max-width: 1200px) {
  .protocol-table th,
  .protocol-table td {
    padding: 14px 16px;
    font-size: 13px;
  }

  .protocol-table th {
    padding: 14px 16px;
  }

  .protocol-table .checklist-item {
    margin: 6px 0;
    font-size: 12.5px;
  }

  .protocol-table .tag {
    font-size: 11px;
    padding: 6px 12px;
  }

  .protocol-table td:first-child strong {
    font-size: 13.5px;
  }
}

@media (max-width: 992px) {
  /* Enable horizontal scroll on smaller screens */
  .accordion-body {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .protocol-table {
    min-width: 1400px;
    display: table;
  }

  .protocol-table th,
  .protocol-table td {
    padding: 18px 22px;
    font-size: 14px;
  }
}

@media (max-width: 768px) {
  .protocol-table {
    min-width: 1350px;
  }

  .protocol-table th,
  .protocol-table td {
    padding: 16px 20px;
    font-size: 13.5px;
  }

  .protocol-table .checklist-item {
    font-size: 11.5px;
    margin: 5px 0;
  }

  .protocol-table .decision-reject,
  .protocol-table .decision-prescribe,
  .protocol-table .decision-clinical {
    padding: 6px 12px;
    font-size: 10px;
  }

  .protocol-table .tag {
    font-size: 10px;
    padding: 5px 10px;
  }
}

/* Tags */
.tag {
  display: inline-flex;
  align-items: center;
  padding: 5px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  line-height: 1.4;
  white-space: nowrap;
  margin: 3px 0;
  transition: all 0.2s ease;
  box-shadow: none;
  border: 1.5px solid transparent;
}

/* Tags inside table cells need extra spacing */
.protocol-table .tag,
.dose-table .tag {
  margin: 4px 0;
  display: inline-block;
}

.tag.orange {
  background: #fffbeb;
  color: #d97706;
  border-color: #fde68a;
}

[data-theme="dark"] .tag.orange {
  background: rgba(245, 158, 11, 0.15);
  color: #fbbf24;
  border-color: rgba(245, 158, 11, 0.3);
}

.tag.red {
  background: #fef2f2;
  color: #dc2626;
  border-color: #fecaca;
}

[data-theme="dark"] .tag.red {
  background: rgba(239, 68, 68, 0.15);
  color: #f87171;
  border-color: rgba(239, 68, 68, 0.3);
}

.tag.green {
  background: #f0fdf4;
  color: #059669;
  border-color: #bbf7d0;
}

[data-theme="dark"] .tag.green {
  background: rgba(16, 185, 129, 0.15);
  color: #34d399;
  border-color: rgba(16, 185, 129, 0.3);
}

.tag.blue {
  background: #eff6ff;
  color: #2563eb;
  border-color: #bfdbfe;
}

[data-theme="dark"] .tag.blue {
  background: rgba(59, 130, 246, 0.15);
  color: #60a5fa;
  border-color: rgba(59, 130, 246, 0.3);
}

.tag.purple {
  background: #faf5ff;
  color: #7c3aed;
  border-color: #e9d5ff;
}

[data-theme="dark"] .tag.purple {
  background: rgba(139, 92, 246, 0.15);
  color: #a78bfa;
  border-color: rgba(139, 92, 246, 0.3);
}

/* Info Cards - Clean Highlighted Design */
.info-card {
  background: #f8fafc;
  border: 1.5px solid #e2e8f0;
  border-left: 4px solid #667eea;
  border-radius: 8px;
  padding: 20px 24px;
  margin: 20px 0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  transition: box-shadow 0.2s ease;
  position: relative;
}

[data-theme="dark"] .info-card {
  background: #374151;
  border-color: #4b5563;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.info-card:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
}

[data-theme="dark"] .info-card:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.info-card.warning,
.info-card.orange {
  background: #fffbeb;
  border-left-color: #f59e0b;
}

[data-theme="dark"] .info-card.warning,
[data-theme="dark"] .info-card.orange {
  background: rgba(245, 158, 11, 0.1);
}

.info-card.danger,
.info-card.red {
  background: #fef2f2;
  border-left-color: #ef4444;
}

[data-theme="dark"] .info-card.danger,
[data-theme="dark"] .info-card.red {
  background: rgba(239, 68, 68, 0.1);
}

.info-card.success,
.info-card.green {
  background: #f0fdf4;
  border-left-color: #10b981;
}

[data-theme="dark"] .info-card.success,
[data-theme="dark"] .info-card.green {
  background: rgba(16, 185, 129, 0.1);
}

.info-card.blue,
.info-card.cyan {
  background: #eff6ff;
  border-left-color: #3b82f6;
}

[data-theme="dark"] .info-card.blue,
[data-theme="dark"] .info-card.cyan {
  background: rgba(59, 130, 246, 0.1);
}

.info-card.purple {
  background: #faf5ff;
  border-left-color: #8b5cf6;
}

[data-theme="dark"] .info-card.purple {
  background: rgba(139, 92, 246, 0.1);
}

.info-card-title {
  font-size: 15.5px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text);
  letter-spacing: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.info-card-text {
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.75;
  letter-spacing: 0;
}

/* Quick Actions */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.quick-action {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.quick-action:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.quick-action-icon {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-elevated);
}

.quick-action-icon svg {
  width: 20px;
  height: 20px;
  color: var(--text-secondary);
}

.quick-action-text {
  font-size: 13px;
  font-weight: 600;
}

/* ============================================
   Responsive Design
   ============================================ */
@media (max-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .prescription-grid {
    grid-template-columns: repeat(2, minmax(280px, 320px));
    justify-content: start;
  }

  .quick-actions {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  :root {
    --sidebar-width: 240px;
  }

  .sidebar {
    transform: translateX(-100%);
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .main {
    margin-left: 0;
  }

  .mobile-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .header {
    padding: 16px 20px;
  }

  .header-left h1 {
    font-size: 20px;
  }

  .header-actions {
    width: 100%;
    justify-content: stretch;
  }

  .header-actions .btn {
    flex: 1;
  }

  .content {
    padding: var(--content-padding-sm);
  }

  .welcome-card {
    padding: 24px;
  }

  .welcome-card .time {
    position: static;
    display: block;
    margin-top: 12px;
  }

  .stats-grid,
  .quick-actions {
    grid-template-columns: 1fr;
  }

  .prescription-grid {
    grid-template-columns: 1fr;
    justify-content: start;
  }

  .checklist-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .status-bar {
    flex-direction: column;
    align-items: stretch;
  }

  .btn-actions {
    width: 100%;
  }

  .btn-actions .btn {
    flex: 1;
  }
}

@media (max-width: 480px) {
  .header-left h1 {
    font-size: 18px;
  }

  .welcome-card h2 {
    font-size: 22px;
  }

  .stat-value {
    font-size: 24px;
  }

  .protocol-table {
    font-size: 12px;
  }

  .protocol-table th,
  .protocol-table td {
    padding: 8px 12px;
  }
}

/* Overlay for mobile sidebar */
.overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 99;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.overlay.active {
  display: block;
  opacity: 1;
}

/* ============================================
   Loading States
   ============================================ */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* ============================================
   Scrollbar Styling
   ============================================ */
::-webkit-scrollbar {
  width: 0px;
  height: 0px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: transparent;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: transparent;
}

/* Hide scrollbar for Firefox */
* {
  scrollbar-width: none;
}

/* Hide scrollbar for IE, Edge */
* {
  -ms-overflow-style: none;
}

/* ============================================
   Protocol Sections & Dividers
   ============================================ */
.protocol-section {
  margin-bottom: 28px;
  padding: 20px 0;
}

.protocol-section:last-child {
  margin-bottom: 0;
}

.protocol-section-title {
  font-size: 14px;
  font-weight: 700;
  color: #475569;
  margin-bottom: 16px;
  margin-top: 32px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  display: flex;
  align-items: center;
  gap: 12px;
  position: relative;
  padding: 10px 0 10px 16px;
  background: #f8fafc;
  border-left: 3px solid var(--card-accent, #667eea);
  border-radius: 4px;
  border: 1px solid #e2e8f0;
  border-left-width: 3px;
}

[data-theme="dark"] .protocol-section-title {
  color: #cbd5e1;
  background: #374151;
  border-color: #4b5563;
}

.protocol-section {
  margin: 28px 0;
}

.protocol-section:first-child {
  margin-top: 0;
}

.divider {
  height: 1px;
  background: #e2e8f0;
  margin: 32px 0;
  border: 0;
}

[data-theme="dark"] .divider {
  background: #4b5563;
}

/* ============================================
   Dose Tables (HTML Table Support)
   ============================================ */
.dose-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin: 24px 0;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
  table-layout: fixed;
  background: var(--bg-card);
}

.dose-table th,
.dose-table td {
  padding: 24px 28px;
  text-align: left;
  border-bottom: 1px solid rgba(99, 102, 241, 0.08);
  font-size: 14.5px;
  line-height: 2;
  vertical-align: top;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.dose-table th {
  background: linear-gradient(
    180deg,
    rgba(99, 102, 241, 0.08) 0%,
    rgba(99, 102, 241, 0.04) 100%
  );
  font-weight: 700;
  font-size: 11.5px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--accent);
  border-bottom: 2px solid rgba(99, 102, 241, 0.2);
  border-right: 1px solid rgba(99, 102, 241, 0.1);
  position: sticky;
  top: 0;
  z-index: 10;
  white-space: normal;
  padding: 20px 28px;
}

.dose-table th:last-child {
  border-right: none;
}

.dose-table td {
  color: var(--text);
  background: var(--bg-card);
  border-right: 1px solid rgba(99, 102, 241, 0.06);
}

.dose-table td:last-child {
  border-right: none;
}

.dose-table tr:last-child td {
  border-bottom: none;
}

.dose-table tbody tr {
  border-left: 3px solid transparent;
  transition: all 0.2s ease;
}

.dose-table tbody tr:nth-child(even) {
  background: rgba(99, 102, 241, 0.01);
}

.dose-table tbody tr:hover {
  border-left-color: var(--accent);
  background: rgba(99, 102, 241, 0.02);
}

.dose-table td strong {
  color: var(--text);
  font-weight: 600;
  font-size: 15px;
  line-height: 1.5;
}

/* Responsive dose tables */
@media (max-width: 1600px) {
  .dose-table th,
  .dose-table td {
    padding: 18px 20px;
    font-size: 14px;
  }

  .dose-table th {
    padding: 16px 20px;
  }
}

@media (max-width: 1400px) {
  .dose-table th,
  .dose-table td {
    padding: 16px 18px;
    font-size: 13.5px;
  }

  .dose-table th {
    padding: 15px 18px;
  }

  .dose-table td strong {
    font-size: 14px;
  }
}

@media (max-width: 1200px) {
  .dose-table th,
  .dose-table td {
    padding: 14px 16px;
    font-size: 13px;
  }

  .dose-table th {
    padding: 14px 16px;
  }

  .dose-table td strong {
    font-size: 13.5px;
  }
}

@media (max-width: 992px) {
  .dose-table {
    min-width: 1000px;
    display: table;
  }

  .dose-table th,
  .dose-table td {
    padding: 12px;
    font-size: 11.5px;
  }
}

@media (max-width: 768px) {
  .dose-table {
    min-width: 900px;
  }

  .dose-table th,
  .dose-table td {
    padding: 12px 14px;
    font-size: 12px;
  }

  .dose-table th {
    padding: 12px 14px;
  }

  .dose-table td strong {
    font-size: 12.5px;
  }
}

/* Info Cards: unified styles live earlier in the file */

/* ============================================
   Definition Cards
   ============================================ */
.definitions-grid {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.definition-card {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 20px;
  border: 1px solid var(--border);
}

.definition-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.definition-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.definition-icon.new {
  background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
}

.definition-icon.repeat {
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
}

.definition-icon.transfer {
  background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
}

.definition-icon.pue {
  background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
}

.definition-icon.ctp {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
}

.definition-icon.switch {
  background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
}

.definition-icon svg {
  width: 18px;
  height: 18px;
  stroke: white;
  stroke-width: 2;
}

.definition-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.definition-acronym {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  background: var(--bg-elevated);
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: 6px;
  font-family: "JetBrains Mono", monospace;
}

.definition-content {
  flex: 1;
}

.definition-text {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.55;
}

.definition-text strong {
  color: var(--text);
  font-weight: 600;
}

/* ============================================
   Global Responsive Enhancements
   ============================================ */

/* Ensure left alignment and proper spacing on all screen sizes */
@media (min-width: 1024px) {
  .protocol-tabs {
    margin-left: 0;
  }

  .protocol-card {
    margin-left: 0;
  }

  .protocol-tab-content {
    margin-left: 0;
  }
}

@media (max-width: 1600px) {
  .protocol-card,
  .info-card {
    padding: 28px;
  }

  .protocol-title {
    font-size: 17px;
  }

  .protocol-text {
    font-size: 13.5px;
  }

  .protocol-tab {
    padding: 16px 28px;
    font-size: 14.5px;
    gap: 11px;
  }

  .protocol-tab svg {
    width: 19px;
    height: 19px;
  }
}

@media (max-width: 1400px) {
  .protocol-card,
  .info-card {
    padding: 24px;
  }

  .protocol-title {
    font-size: 16px;
  }

  .protocol-text {
    font-size: 13.5px;
  }
}

@media (max-width: 1200px) {
  .content {
    padding: 20px;
  }

  .protocol-card,
  .info-card {
    padding: 22px;
  }

  .protocol-card {
    margin-bottom: 20px;
  }

  .protocol-title {
    font-size: 15.5px;
  }

  .protocol-tabs {
    gap: 10px;
  }

  .protocol-tab {
    padding: 15px 26px;
    font-size: 14px;
    gap: 10px;
  }

  .protocol-tab svg {
    width: 18px;
    height: 18px;
  }
}

@media (max-width: 992px) {
  .content {
    padding: 18px;
  }

  .protocol-card,
  .info-card {
    padding: 20px;
  }

  .protocol-title {
    font-size: 15px;
  }

  .protocol-tabs {
    gap: 8px;
  }

  .protocol-tab {
    padding: 14px 24px;
    font-size: 13.5px;
    gap: 10px;
  }

  .protocol-tab svg {
    width: 18px;
    height: 18px;
  }

  .accordion summary {
    font-size: 14.5px;
    padding: 18px 20px;
  }

  .accordion-body {
    padding: 20px;
  }
}

@media (max-width: 768px) {
  .content {
    padding: 16px;
  }

  .protocol-card,
  .info-card {
    padding: 18px;
  }

  .protocol-title {
    font-size: 14.5px;
  }

  .protocol-text {
    font-size: 13px;
  }

  .accordion summary {
    font-size: 14px;
    padding: 16px 18px;
  }

  .accordion-body {
    padding: 18px;
  }

  .info-card-title {
    font-size: 13.5px;
  }

  .info-card-text {
    font-size: 13px;
  }

  .protocol-tabs {
    gap: 8px;
    margin-bottom: 36px;
  }

  .protocol-tab {
    padding: 13px 22px;
    font-size: 13px;
    gap: 9px;
  }

  .protocol-tab svg {
    width: 17px;
    height: 17px;
  }
}

@media (max-width: 480px) {
  .content {
    padding: 14px;
  }

  .protocol-card,
  .info-card {
    padding: 16px;
  }

  .protocol-title {
    font-size: 12.5px;
  }

  .protocol-text {
    font-size: 12px;
  }

  .accordion summary {
    font-size: 12px;
    padding: 10px 14px;
  }

  .table-wrapper {
    margin: 16px 0;
  }

  .protocol-tabs {
    gap: 6px;
    margin-bottom: 32px;
  }

  .protocol-tab {
    padding: 12px 20px;
    font-size: 12.5px;
    gap: 8px;
  }

  .protocol-tab svg {
    width: 16px;
    height: 16px;
  }
}

/* ============================================
   Print Styles
   ============================================ */
@media print {
  .sidebar,
  .header-actions,
  .mobile-toggle,
  .theme-toggle,
  .status-bar {
    display: none !important;
  }

  .main {
    margin-left: 0 !important;
  }

  .page {
    display: block !important;
  }
}

    </style>
</head>
  <body data-theme="dark">
    <div class="app">
      <!-- Sidebar Navigation -->
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <div class="logo-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
              </svg>
            </div>
            <div class="logo-text-container">
              <span class="logo-text">GLP-1 Portal</span>
            </div>
          </div>
        </div>

        <div class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <div class="nav-item active" data-page="dashboard">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1" />
                <rect x="14" y="3" width="7" height="7" rx="1" />
                <rect x="14" y="14" width="7" height="7" rx="1" />
                <rect x="3" y="14" width="7" height="7" rx="1" />
              </svg>
              Dashboard
            </div>
            <div class="nav-item" data-page="checklists">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4" />
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" />
              </svg>
              Checklists
              <span class="badge">5</span>
            </div>
            <div class="nav-item" data-page="transfer">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 1l4 4-4 4" />
                <path d="M3 11V9a4 4 0 014-4h14" />
                <path d="M7 23l-4-4 4-4" />
                <path d="M21 13v2a4 4 0 01-4 4H3" />
              </svg>
              Transfer Patients
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-title">Protocols</div>
            <div class="nav-item" data-page="proto-core">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
              </svg>
              Core Checks
            </div>
            <div class="nav-item" data-page="proto-scr">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l7 4v6c0 5-3 9-7 10-4-1-7-5-7-10V6l7-4z" />
                <path d="M9 12l2 2 4-5" />
              </svg>
              SCR Screening
            </div>
            <div class="nav-item" data-page="proto-pue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12h6M12 9v6" />
                <circle cx="12" cy="12" r="10" />
              </svg>
              Previous Use Evidence
            </div>
            <div class="nav-item" data-page="proto-titration">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20V10M18 20V4M6 20v-4" />
              </svg>
              Titration & Gap
            </div>
            <div class="nav-item" data-page="proto-weight">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18M3 12h18" />
                <circle cx="12" cy="12" r="9" />
              </svg>
              Weight Monitoring
            </div>
            <div class="nav-item" data-page="proto-switching">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 3l4 4-4 4M20 7H4M8 21l-4-4 4-4M4 17h16" />
              </svg>
              Switching & Side Effects
            </div>
            <div class="nav-item" data-page="proto-reviews">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 6v6l4 2" />
              </svg>
              6 Month Reviews
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-title">Reference</div>
            <div class="nav-item" data-page="definitions">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z" />
              </svg>
              Definitions
            </div>
            <div class="nav-item" data-page="consultation">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4" />
                <rect x="3" y="4" width="18" height="16" rx="2" />
              </svg>
              Consultation Questions
            </div>
            <div class="nav-item" data-page="contraindications">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" />
              </svg>
              Contraindications
            </div>
            <div class="nav-item" data-page="titration-guide">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20V10M18 20V4M6 20v-4" />
              </svg>
              Titration Guide
            </div>
            <div class="nav-item" data-page="rejections">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
              </svg>
              Rejection Reasons
            </div>
            <div class="nav-item" data-page="tags">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"
                />
                <line x1="7" y1="7" x2="7.01" y2="7" />
              </svg>
              Tags Reference
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-title">Version</div>
            <a href="old-glp.html" class="nav-item nav-link" target="_blank">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              Old Version
              <svg
                class="external-link"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6" />
                <polyline points="15 3 21 3 21 9" />
                <line x1="10" y1="14" x2="21" y2="3" />
              </svg>
            </a>
          </div>
        </div>

        <button class="mobile-toggle" id="mobileToggle" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        </button>
      </nav>

      <!-- Main Content -->
      <main class="main" id="mainContent">
        <header class="header">
          <div class="header-left">
            <h1 id="page-title">Prescribing Dashboard</h1>
            <p id="page-subtitle">Select a prescription type to begin safety checks</p>
          </div>
          <div class="header-right">
            <div class="search-container">
              <svg
                class="search-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8" />
                <path d="M21 21l-4.35-4.35" />
              </svg>
              <input
                type="text"
                id="globalSearch"
                class="search-input"
                placeholder="Search conditions, medications, BMI, protocols..."
                aria-label="Global search"
              />
              <div
                id="occurrenceControls"
                class="occurrence-controls"
                style="display: none"
              >
                <span id="occurrenceCount" class="occurrence-count">0/0</span>
                <button id="prevOccurrence" class="occurrence-nav" title="Previous">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="15 18 9 12 15 6" />
                  </svg>
                </button>
                <button id="nextOccurrence" class="occurrence-nav" title="Next">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="9 18 15 12 9 6" />
                  </svg>
                </button>
              </div>
              <button
                class="search-clear"
                id="searchClear"
                aria-label="Clear search"
                style="display: none"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
              </button>
            </div>
            <div class="theme-toggle-wrapper">
              <select id="fontSelector" class="font-selector" aria-label="Select font">
                <option value="Poppins">Poppins</option>
                <option value="Inter">Inter</option>
                <option value="Outfit">Outfit</option>
                <option value="Roboto">Roboto</option>
                <option value="Manrope">Manrope</option>
              </select>
              <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
              </button>
            </div>
          </div>
        </header>

        <div class="content" id="contentArea">
          <!-- Content will be loaded dynamically -->
        </div>
      </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div class="overlay" id="overlay"></div>
  <script>
// ============================================
// State Management
// ============================================
const AppState = {
  currentPage: "dashboard",
  currentChecklist: null,
  theme: localStorage.getItem("theme") || "dark",
  font: localStorage.getItem("font") || "Manrope",
  checklists: {
    starting: { total: 21, checks: {} },
    stepup: { total: 20, checks: {} },
    repeat: { total: 34, checks: {} },
    "transfer-above": { total: 18, checks: {} },
    "transfer-below": { total: 21, checks: {} },
  },
};

// ============================================
// Utility Functions
// ============================================
const Utils = {
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  formatDateTime() {
    const now = new Date();
    const options = {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    };
    return now.toLocaleDateString("en-GB", options);
  },

  saveState() {
    localStorage.setItem("appState", JSON.stringify(AppState.checklists));
  },

  loadState() {
    const saved = localStorage.getItem("appState");
    if (saved) {
      try {
        AppState.checklists = JSON.parse(saved);
      } catch (e) {
        console.error("Failed to load saved state:", e);
      }
    }
  },
};

// ============================================
// Theme Management
// ============================================
const ThemeManager = {
  init() {
    this.applyTheme(AppState.theme);
    this.applyFont(AppState.font);

    const themeToggle = document.getElementById("themeToggle");
    if (themeToggle) {
      themeToggle.addEventListener("click", () => {
        const newTheme = AppState.theme === "dark" ? "light" : "dark";
        this.applyTheme(newTheme);
      });
    }

    const fontSelector = document.getElementById("fontSelector");
    if (fontSelector) {
      fontSelector.value = AppState.font;
      fontSelector.addEventListener("change", (e) => {
        this.applyFont(e.target.value);
      });
    }
  },

  applyTheme(theme) {
    document.body.setAttribute("data-theme", theme);
    AppState.theme = theme;
    localStorage.setItem("theme", theme);

    const themeToggle = document.getElementById("themeToggle");
    if (themeToggle) {
      themeToggle.setAttribute("data-theme", theme);
    }
  },

  applyFont(font) {
    document.body.style.fontFamily = `"${font}", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
    AppState.font = font;
    localStorage.setItem("font", font);
  },
};

// ============================================
// Search Management
// ============================================
const SearchManager = {
  searchData: [],
  resultsContainer: null,
  allTabsTextIndex: null,
  latestFindSummary: null,
  pendingNavigation: null,

  globalFindState: {
    terms: [],
    marks: [],
    index: -1,
  },

  localFindState: {
    terms: [],
    marks: [],
    index: -1,
  },

  init() {
    this.buildSearchIndex();
    const searchInput = document.getElementById("globalSearch");
    const searchClear = document.getElementById("searchClear");

    const prevOccurrence = document.getElementById("prevOccurrence");
    const nextOccurrence = document.getElementById("nextOccurrence");

    if (searchInput) {
      searchInput.addEventListener(
        "input",
        Utils.debounce((e) => this.handleGlobalQuery(e.target.value), 220)
      );

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          this.clearSearch();
          return;
        }

        // Ctrl+F style navigation in current tab
        if (e.key === "Enter") {
          e.preventDefault();
          if (e.shiftKey) {
            this.gotoOccurrence(-1, "global");
          } else {
            this.gotoOccurrence(1, "global");
          }
        }
      });
    }

    if (searchClear) {
      searchClear.addEventListener("click", () => this.clearSearch());
    }

    if (prevOccurrence) {
      prevOccurrence.addEventListener("click", () => this.gotoOccurrence(-1, "global"));
    }
    if (nextOccurrence) {
      nextOccurrence.addEventListener("click", () => this.gotoOccurrence(1, "global"));
    }

    // Close search results when clicking outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".search-container")) {
        this.hideResults();
      }
    });
  },

  // Runs both: (1) structured navigation search (dropdown), and (2) Ctrl+F-style highlight within current tab.
  handleGlobalQuery(rawQuery) {
    this.handleSearch(rawQuery);
    this.runFind(rawQuery, {
      mode: "global",
      scopeEl: document.getElementById("contentArea"),
      controls: {
        controlsId: "occurrenceControls",
        countId: "occurrenceCount",
      },
      highlightClass: "find-highlight--global",
    });
  },

  getQueryTerms(rawQuery) {
    if (!rawQuery) return [];

    // Split on common separators (including new lines) but keep multi-word phrases intact.
    return rawQuery
      .toLowerCase()
      .split(/[,;\.\-\/\|\n\r]+/)
      .map((t) => t.trim())
      .filter((t) => t.length > 1);
  },

  buildAllTabsTextIndex() {
    // Cache the plain text for each page so we can count matches "across the whole website".
    const titles = {
      dashboard: "Prescribing Dashboard",
      checklists: "Safety Checklists",
      transfer: "Transfer Assessment",
      "proto-core": "Core Checks Protocol",
      "proto-scr": "SCR Screening",
      "proto-pue": "Previous Use Evidence",
      "proto-titration": "Titration & Gap Treatment",
      "proto-weight": "Weight Monitoring",
      "proto-switching": "Switching & Side Effects",
      "proto-reviews": "6 Month Reviews",
      consultation: "Consultation Questions",
      definitions: "Definitions",
      contraindications: "Contraindications",
      "titration-guide": "Titration Guide",
      rejections: "Rejection Reasons",
      tags: "Tags Reference",
    };

    const pageIds = Object.keys(titles);
    const index = [];

    const htmlToText = (html) => {
      const div = document.createElement("div");
      div.innerHTML = html || "";
      return (div.innerText || "").replace(/\s+/g, " ").trim();
    };

    const getHtml = (pageId) => {
      // Mirrors ContentManager.loadPage switch, without touching the DOM.
      switch (pageId) {
        case "dashboard":
          return ContentManager.getDashboardContent();
        case "checklists":
          return ContentManager.getChecklistsContent();
        case "transfer":
          return ContentManager.getTransferContent();
        case "proto-core":
          return ContentManager.getProtocolContent("core");
        case "proto-scr":
          return ContentManager.getProtocolContent("scr");
        case "proto-pue":
          return ContentManager.getProtocolContent("pue");
        case "proto-titration":
          return ContentManager.getProtocolContent("titration");
        case "proto-weight":
          return ContentManager.getProtocolContent("weight");
        case "proto-switching":
          return ContentManager.getProtocolContent("switching");
        case "proto-reviews":
          return ContentManager.getProtocolContent("reviews");
        case "consultation":
          return ContentManager.getConsultationContent();
        case "definitions":
          return ContentManager.getDefinitionsContent();
        case "contraindications":
          return ContentManager.getContraindicationsContent();
        case "titration-guide":
          return ContentManager.getTitrationGuideContent();
        case "rejections":
          return ContentManager.getRejectionsContent();
        case "tags":
          return ContentManager.getTagsContent();
        default:
          return "";
      }
    };

    pageIds.forEach((pageId) => {
      try {
        const html = getHtml(pageId);
        index.push({
          pageId,
          title: titles[pageId] || pageId,
          text: htmlToText(html),
        });
      } catch (e) {
        // If any page generator throws, skip it rather than breaking the whole search.
      }
    });

    this.allTabsTextIndex = index;
  },

  computeAllTabsCounts(terms) {
    if (!terms || terms.length === 0) {
      return { total: 0, perPage: [] };
    }

    if (!this.allTabsTextIndex) {
      this.buildAllTabsTextIndex();
    }

    const countInText = (text, term) => {
      if (!text || !term) return 0;
      const re = new RegExp(this.escapeRegex(term), "gi");
      const m = text.match(re);
      return m ? m.length : 0;
    };

    const perPage = (this.allTabsTextIndex || [])
      .map((p) => {
        const count = terms.reduce((acc, t) => acc + countInText(p.text, t), 0);
        return { pageId: p.pageId, title: p.title, count };
      })
      .filter((p) => p.count > 0)
      .sort((a, b) => b.count - a.count);

    const total = perPage.reduce((acc, p) => acc + p.count, 0);
    return { total, perPage };
  },

  clearHighlightsInScope(scopeEl, highlightClass) {
    if (!scopeEl) return;
    scopeEl.querySelectorAll(`mark.find-highlight.${highlightClass}`).forEach((m) => {
      m.replaceWith(document.createTextNode(m.textContent || ""));
    });
  },

  highlightTermsInScope(scopeEl, terms, highlightClass) {
    if (!scopeEl || !terms || terms.length === 0) return [];

    const createdMarks = [];

    const shouldSkipNode = (node) => {
      if (!node || !node.parentElement) return true;
      const p = node.parentElement;
      if (p.closest(".search-container")) return true;
      if (p.closest(".search-results")) return true;
      if (p.closest(".local-search-container")) return true;
      if (p.closest("script, style, textarea, input, select")) return true;
      if (p.closest("mark.find-highlight")) return true;
      return false;
    };

    const wrapMatchesInTextNode = (textNode, term) => {
      const text = textNode.nodeValue;
      if (!text) return;

      const re = new RegExp(this.escapeRegex(term), "gi");
      const matches = [...text.matchAll(re)];
      if (matches.length === 0) return;

      const frag = document.createDocumentFragment();
      let lastIndex = 0;
      matches.forEach((m) => {
        const start = m.index;
        const end = start + m[0].length;

        if (start > lastIndex) {
          frag.appendChild(document.createTextNode(text.slice(lastIndex, start)));
        }

        const mark = document.createElement("mark");
        mark.className = `find-highlight ${highlightClass}`;
        mark.textContent = text.slice(start, end);
        frag.appendChild(mark);
        createdMarks.push(mark);

        lastIndex = end;
      });

      if (lastIndex < text.length) {
        frag.appendChild(document.createTextNode(text.slice(lastIndex)));
      }

      textNode.replaceWith(frag);
    };

    // Apply each term separately to keep the logic simple.
    terms.forEach((term) => {
      const walker = document.createTreeWalker(scopeEl, NodeFilter.SHOW_TEXT, {
        acceptNode: (node) => {
          if (!node.nodeValue || !node.nodeValue.trim()) {
            return NodeFilter.FILTER_REJECT;
          }
          if (shouldSkipNode(node)) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        },
      });

      const nodes = [];
      while (walker.nextNode()) nodes.push(walker.currentNode);
      nodes.forEach((n) => wrapMatchesInTextNode(n, term));
    });

    return createdMarks;
  },

  updateOccurrenceUI(mode) {
    const state = mode === "local" ? this.localFindState : this.globalFindState;
    const controlsId =
      mode === "local" ? "localOccurrenceControls" : "occurrenceControls";
    const countId = mode === "local" ? "localOccurrenceCount" : "occurrenceCount";

    const controlsEl = document.getElementById(controlsId);
    const countEl = document.getElementById(countId);

    const total = state.marks.length;
    if (!controlsEl || !countEl) return;

    if (total === 0) {
      controlsEl.style.display = "none";
      countEl.textContent = "0/0";
      return;
    }

    controlsEl.style.display = "flex";
    const current = state.index >= 0 ? state.index + 1 : 0;

    let suffix = "";
    if (
      mode === "global" &&
      this.latestFindSummary &&
      typeof this.latestFindSummary.allTabsTotal === "number"
    ) {
      suffix = `  all ${this.latestFindSummary.allTabsTotal}`;
    }

    countEl.textContent = `${current}/${total}${suffix}`;
  },

  setActiveOccurrence(mode) {
    const state = mode === "local" ? this.localFindState : this.globalFindState;
    const activeClass =
      mode === "local" ? "find-highlight--active-local" : "find-highlight--active-global";
    const baseClass =
      mode === "local" ? "find-highlight--local" : "find-highlight--global";

    state.marks.forEach((m) => m.classList.remove(activeClass));

    if (!state.marks.length || state.index < 0) {
      this.updateOccurrenceUI(mode);
      return;
    }

    const mark = state.marks[state.index];
    if (mark) {
      mark.classList.add(activeClass);
      // Ensure base class is present (in case the DOM got re-rendered)
      if (!mark.classList.contains(baseClass)) mark.classList.add(baseClass);
      mark.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    this.updateOccurrenceUI(mode);
  },

  gotoOccurrence(direction, mode = "global") {
    const state = mode === "local" ? this.localFindState : this.globalFindState;
    if (!state.marks.length) {
      this.updateOccurrenceUI(mode);
      return;
    }

    const total = state.marks.length;
    if (state.index < 0) state.index = 0;
    state.index = (state.index + direction + total) % total;
    this.setActiveOccurrence(mode);
  },

  runFind(rawQuery, { mode, scopeEl, controls, highlightClass }) {
    const state = mode === "local" ? this.localFindState : this.globalFindState;
    const terms = this.getQueryTerms(rawQuery);

    // Clear existing highlights of the same mode
    this.clearHighlightsInScope(scopeEl, highlightClass);

    state.terms = terms;
    state.marks = [];
    state.index = -1;

    if (!terms.length) {
      this.updateOccurrenceUI(mode);
      return;
    }

    state.marks = this.highlightTermsInScope(scopeEl, terms, highlightClass);
    state.index = state.marks.length ? 0 : -1;
    this.setActiveOccurrence(mode);
  },

  buildSearchIndex() {
    this.searchData = [
      // Contraindications - Absolute
      {
        title: "Pancreatitis",
        context:
          "Including acute or chronic pancreatic insufficiency - REJECT immediately",
        page: "contraindications",
        sectionId: "gastrointestinal-contraindication",
        category: "Absolute Contraindication",
        keywords: ["pancreatitis", "pancreatic", "insufficiency", "acute", "chronic"],
      },
      {
        title: "Eating Disorders",
        context:
          "Anorexia nervosa, Bulimia nervosa, Binge Eating Disorder (BED), ARFID - REJECT",
        page: "contraindications",
        sectionId: "psychiatric-contraindication",
        category: "Absolute Contraindication",
        keywords: [
          "eating disorder",
          "anorexia",
          "bulimia",
          "binge eating",
          "bed",
          "arfid",
          "anorexia nervosa",
          "bulimia nervosa",
        ],
      },
      {
        title: "Type 1 Diabetes",
        context: "Insulin-dependent diabetes mellitus (IDDM) - REJECT",
        page: "contraindications",
        sectionId: "diabetes-contraindication",
        category: "Absolute Contraindication",
        keywords: [
          "type 1 diabetes",
          "t1d",
          "iddm",
          "insulin dependent",
          "diabetes mellitus",
        ],
      },
      {
        title: "Liver Cirrhosis",
        context: "Liver cirrhosis - REJECT immediately",
        page: "contraindications",
        sectionId: "renal-hepatic-contraindication",
        category: "Absolute Contraindication",
        keywords: ["liver cirrhosis", "cirrhosis", "hepatic", "liver"],
      },
      {
        title: "Liver Transplant",
        context: "Liver transplant - REJECT immediately",
        page: "contraindications",
        sectionId: "renal-hepatic-contraindication",
        category: "Absolute Contraindication",
        keywords: ["liver transplant", "transplant", "hepatic transplant"],
      },
      {
        title: "Endocrine Disorders",
        context:
          "Acromegaly, Cushing's syndrome, Addison's disease, Congenital Adrenal Hyperplasia - REJECT",
        page: "contraindications",
        sectionId: "thyroid-contraindication",
        category: "Absolute Contraindication",
        keywords: [
          "endocrine",
          "acromegaly",
          "cushing",
          "addison",
          "adrenal hyperplasia",
          "cushings",
          "addisons",
        ],
      },
      {
        title: "Ulcerative Colitis",
        context: "Ulcerative Colitis - REJECT",
        page: "contraindications",
        sectionId: "gastrointestinal-contraindication",
        category: "Absolute Contraindication",
        keywords: ["ulcerative colitis", "uc", "colitis", "ibd", "inflammatory bowel"],
      },
      {
        title: "Crohn's Disease",
        context: "Crohn's disease - REJECT",
        page: "contraindications",
        sectionId: "gastrointestinal-contraindication",
        category: "Absolute Contraindication",
        keywords: ["crohns", "crohn", "ibd", "inflammatory bowel disease"],
      },
      {
        title: "Gastroparesis",
        context: "Delayed gastric emptying - REJECT",
        page: "contraindications",
        sectionId: "gastrointestinal-contraindication",
        category: "Absolute Contraindication",
        keywords: ["gastroparesis", "delayed gastric emptying", "gastric emptying"],
      },
      {
        title: "MEN2",
        context: "Multiple Endocrine Neoplasia type 2 - REJECT",
        page: "contraindications",
        sectionId: "thyroid-contraindication",
        category: "Absolute Contraindication",
        keywords: [
          "men2",
          "men 2",
          "multiple endocrine neoplasia",
          "endocrine neoplasia",
        ],
      },
      {
        title: "Medullary Thyroid Cancer",
        context: "Medullary thyroid cancer - REJECT",
        page: "contraindications",
        sectionId: "thyroid-contraindication",
        category: "Absolute Contraindication",
        keywords: ["medullary thyroid", "thyroid cancer", "mtc", "medullary cancer"],
      },
      {
        title: "Pregnancy",
        context: "Currently pregnant, breastfeeding, or trying to conceive - REJECT",
        page: "contraindications",
        sectionId: "pregnancy-contraindication",
        category: "Absolute Contraindication",
        keywords: [
          "pregnancy",
          "pregnant",
          "breastfeeding",
          "lactating",
          "conceive",
          "ttc",
        ],
      },

      // Medications
      {
        title: "Insulin",
        context: "On repeat medication list or within last 3 months - REJECT",
        page: "contraindications",
        sectionId: "insulin-diabetic-meds",
        category: "Medication",
        keywords: ["insulin", "diabetes medication"],
      },
      {
        title: "Oral Diabetic Medications",
        context:
          "Sulfonylureas (Diamicron, Daonil, Rastin), SGLT2 inhibitors (Jardiance, Forxiga, Invokana), DPP-4 inhibitors (Januvia, Galvus, Trajenta), Thiazolidinediones (Actos)",
        page: "contraindications",
        sectionId: "insulin-diabetic-meds",
        category: "Medication",
        keywords: [
          "diabetic medication",
          "sulfonylureas",
          "diamicron",
          "gliclazide",
          "daonil",
          "glibenclamide",
          "rastin",
          "tolbutamide",
          "sglt2",
          "jardiance",
          "empagliflozin",
          "forxiga",
          "dapagliflozin",
          "invokana",
          "canagliflozin",
          "dpp-4",
          "dpp4",
          "januvia",
          "sitagliptin",
          "galvus",
          "vildagliptin",
          "trajenta",
          "linagliptin",
          "actos",
          "pioglitazone",
        ],
      },
      {
        title: "Narrow Therapeutic Index Medications",
        context:
          "Amiodarone, Carbamazepine, Ciclosporin, Clozapine, Digoxin, Fenfluramine, Lithium, Mycophenolate, Oral methotrexate, Phenobarbital, Phenytoin, Somatrogon, Tacrolimus, Theophylline, Warfarin",
        page: "contraindications",
        sectionId: "narrow-therapeutic-medications",
        category: "Medication",
        keywords: [
          "narrow therapeutic index",
          "nti",
          "amiodarone",
          "carbamazepine",
          "ciclosporin",
          "cyclosporine",
          "clozapine",
          "digoxin",
          "fenfluramine",
          "lithium",
          "mycophenolate",
          "methotrexate",
          "phenobarbital",
          "phenytoin",
          "somatrogon",
          "tacrolimus",
          "theophylline",
          "warfarin",
        ],
      },
      {
        title: "Orlistat",
        context:
          "Alli, Xenical - REJECT if GLP prescription issued <1 month after Orlistat",
        page: "contraindications",
        sectionId: "orlistat",
        category: "Medication",
        keywords: ["orlistat", "alli", "xenical", "weight loss medication"],
      },

      // Time-Sensitive Conditions
      {
        title: "Bariatric Surgery",
        context:
          "RYGB, Sleeve Gastrectomy, Lap-Band, BPD/DS, OAGB, gastric balloon - REJECT if <12 months",
        page: "contraindications",
        sectionId: "bariatric-surgery",
        category: "Time-Sensitive",
        keywords: [
          "bariatric",
          "bariatric surgery",
          "rygb",
          "gastric bypass",
          "sleeve gastrectomy",
          "lap band",
          "gastric band",
          "bpd/ds",
          "oagb",
          "gastric balloon",
          "weight loss surgery",
        ],
      },
      {
        title: "Cholecystectomy",
        context: "Gallbladder removal - REJECT if <12 months",
        page: "contraindications",
        sectionId: "cholecystectomy",
        category: "Time-Sensitive",
        keywords: ["cholecystectomy", "gallbladder removal", "gallbladder surgery"],
      },
      {
        title: "Cholelithiasis / Cholecystitis",
        context:
          "Gallstones or gallbladder inflammation - need cholecystectomy confirmation",
        page: "contraindications",
        sectionId: "gallstones-cholecystitis",
        category: "Clinical Details Required",
        keywords: [
          "cholelithiasis",
          "cholecystitis",
          "gallstones",
          "gallbladder",
          "gallbladder inflammation",
        ],
      },
      {
        title: "Heart Failure",
        context: "REJECT if Stage IV - email patient for cardiology letter (Macro 4)",
        page: "contraindications",
        sectionId: "heart-failure",
        category: "Clinical Details Required",
        keywords: [
          "heart failure",
          "hf",
          "cardiac failure",
          "congestive heart failure",
          "chf",
        ],
      },
      {
        title: "Chronic Kidney Disease",
        context: "REJECT if eGFR <30 or Stage 4 - request eGFR (Macro 5)",
        page: "contraindications",
        sectionId: "chronic-kidney-disease",
        category: "Clinical Details Required",
        keywords: [
          "chronic kidney disease",
          "ckd",
          "renal impairment",
          "egfr",
          "kidney disease",
          "renal disease",
        ],
      },
      {
        title: "Cancer",
        context: "Excluding MEN2/medullary thyroid - request oncology letter (Macro 3)",
        page: "contraindications",
        sectionId: "cancer-assessment",
        category: "Patient Assessment",
        keywords: ["cancer", "malignancy", "oncology", "tumor", "carcinoma", "neoplasm"],
      },
      {
        title: "Dementia / Cognitive Impairment",
        context: "Assess safety at home and ability to use medication (Macro 7)",
        page: "contraindications",
        sectionId: "dementia-assessment",
        category: "Patient Assessment",
        keywords: [
          "dementia",
          "cognitive impairment",
          "alzheimers",
          "memory loss",
          "confusion",
        ],
      },
      {
        title: "Chronic Malabsorption",
        context: "REJECT if formal diagnosis confirmed (Macro 8)",
        page: "contraindications",
        sectionId: "malabsorption-assessment",
        category: "Patient Assessment",
        keywords: ["malabsorption", "chronic malabsorption", "absorption disorder"],
      },
      {
        title: "Depression / Anxiety",
        context: "REJECT if acutely unwell <3 months or new antidepressant (Macro 9)",
        page: "contraindications",
        sectionId: "depression-anxiety-assessment",
        category: "Patient Assessment",
        keywords: [
          "depression",
          "anxiety",
          "mental health",
          "psychiatric",
          "antidepressant",
          "ssri",
          "snri",
        ],
      },
      {
        title: "Suicidal Ideation",
        context: "REJECT if <12 months - active suicidal thoughts (Macro 9)",
        page: "contraindications",
        sectionId: "suicidal-ideation-assessment",
        category: "Patient Assessment",
        keywords: ["suicidal", "suicide", "self harm", "suicidal ideation"],
      },
      {
        title: "Alcohol Abuse",
        context: "REJECT if current dependence or <12 months (Macro 10)",
        page: "contraindications",
        sectionId: "alcohol-abuse-assessment",
        category: "Patient Assessment",
        keywords: [
          "alcohol",
          "alcohol abuse",
          "alcohol dependence",
          "alcoholism",
          "substance abuse",
        ],
      },

      // BMI & Weight
      {
        title: "BMI Requirements",
        context:
          "New patients: BMI 30 (or 27 with comorbidity). Transfer patients: different thresholds apply",
        page: "proto-weight",
        category: "Weight Protocol",
        keywords: ["bmi", "body mass index", "weight", "obesity", "overweight"],
      },
      {
        title: "Weight Verification",
        context:
          "Photo ID + scale photo required for new patients. Check date, visibility, matching details",
        page: "proto-weight",
        category: "Weight Protocol",
        keywords: [
          "weight verification",
          "weight photo",
          "scale photo",
          "id verification",
        ],
      },

      // SCR
      {
        title: "SCR Screening",
        context: "Summary Care Record - check for contraindications using scraping tool",
        page: "proto-scr",
        category: "SCR Protocol",
        keywords: [
          "scr",
          "summary care record",
          "nhs record",
          "scraping tool",
          "medical record",
        ],
      },
      {
        title: "SCR Permission",
        context: "Patient must grant permission to view SCR - use Macro 11 if missing",
        page: "proto-scr",
        category: "SCR Protocol",
        keywords: ["scr permission", "permission to view", "consent"],
      },

      // Titration
      {
        title: "Dose Titration",
        context: "Starting dose, step-up schedule, maintenance dose guidance",
        page: "titration-guide",
        category: "Titration",
        keywords: [
          "titration",
          "dose",
          "dosing",
          "starting dose",
          "step up",
          "maintenance dose",
          "dose escalation",
        ],
      },
      {
        title: "Gap in Treatment",
        context: "Rules for restarting after treatment breaks - depends on gap length",
        page: "proto-titration",
        category: "Titration",
        keywords: [
          "gap",
          "treatment gap",
          "missed dose",
          "restart",
          "break in treatment",
        ],
      },

      // PUE
      {
        title: "Previous Use Evidence",
        context: "Documentation required for transfer patients claiming prior GLP-1 use",
        page: "proto-pue",
        category: "Transfer Protocol",
        keywords: [
          "pue",
          "previous use",
          "prior use",
          "evidence",
          "transfer patient",
          "proof of use",
        ],
      },
    ];
  },

  handleSearch(query) {
    const searchClear = document.getElementById("searchClear");

    if (!query || query.trim().length < 2) {
      this.hideResults();
      if (searchClear) searchClear.style.display = "none";

      // Also clear Ctrl+F style highlights
      const scopeEl = document.getElementById("contentArea");
      this.clearHighlightsInScope(scopeEl, "find-highlight--global");
      this.globalFindState.terms = [];
      this.globalFindState.marks = [];
      this.globalFindState.index = -1;
      this.updateOccurrenceUI("global");
      this.latestFindSummary = null;
      return;
    }

    if (searchClear) searchClear.style.display = "flex";

    // Parse multiple terms - split by common separators (incl. new lines)
    const terms = this.getQueryTerms(query);

    const results = this.search(terms);

    const allTabs = this.computeAllTabsCounts(terms);
    const currentPageId = AppState.currentPage || "";
    const currentTabCount = (allTabs.perPage || []).find(
      (p) => p.pageId === currentPageId
    )
      ? (allTabs.perPage || []).find((p) => p.pageId === currentPageId).count
      : 0;
    this.latestFindSummary = {
      currentTabCount,
      allTabsTotal: allTabs.total,
      perPage: allTabs.perPage || [],
      rawQuery: query,
    };

    this.displayResults(results, query);
  },

  search(terms) {
    const allResults = [];

    terms.forEach((term) => {
      this.searchData.forEach((item) => {
        let score = 0;
        const termLower = term.toLowerCase();

        // Exact title match - highest priority
        if (item.title.toLowerCase() === termLower) {
          score += 100;
        }
        // Title contains term
        else if (item.title.toLowerCase().includes(termLower)) {
          score += 50;
        }

        // Check keywords
        item.keywords.forEach((keyword) => {
          if (keyword === termLower) {
            score += 80;
          } else if (keyword.includes(termLower) || termLower.includes(keyword)) {
            score += 30;
          }
        });

        // Context match
        if (item.context.toLowerCase().includes(termLower)) {
          score += 20;
        }

        // Fuzzy match for common medical term variations
        const fuzzyScore = this.fuzzyMatch(termLower, item.title.toLowerCase());
        score += fuzzyScore;

        if (score > 0) {
          allResults.push({
            ...item,
            score,
            matchedTerm: term,
          });
        }
      });
    });

    // Deduplicate and sort by score
    const uniqueResults = [];
    const seen = new Set();

    allResults
      .sort((a, b) => b.score - a.score)
      .forEach((result) => {
        const key = `${result.title}-${result.page}`;
        if (!seen.has(key)) {
          seen.add(key);
          uniqueResults.push(result);
        }
      });

    return uniqueResults.slice(0, 10); // Top 10 results
  },

  fuzzyMatch(term, target) {
    // Simple fuzzy matching for typos and variations
    if (term.length < 3) return 0;

    const termChars = term.split("");
    let matchIndex = 0;
    let score = 0;

    for (let char of termChars) {
      const index = target.indexOf(char, matchIndex);
      if (index !== -1) {
        score += 1;
        matchIndex = index + 1;
      }
    }

    return score >= term.length * 0.7 ? score * 2 : 0;
  },

  displayResults(results, originalQuery) {
    if (!this.resultsContainer) {
      this.resultsContainer = document.createElement("div");
      this.resultsContainer.className = "search-results";
      document.querySelector(".search-container").appendChild(this.resultsContainer);
    }

    const summary = this.latestFindSummary;
    const summaryLine = summary
      ? `<div class="search-results-subheader">This tab: <strong>${summary.currentTabCount}</strong>  All tabs: <strong>${summary.allTabsTotal}</strong></div>`
      : "";

    const tabMatches =
      summary && summary.perPage && summary.perPage.length
        ? `
        <div class="search-results-tabs">
          <div class="search-results-tabs-title">Matches by tab</div>
          ${summary.perPage
            .slice(0, 8)
            .map(
              (p) => `
                <button class="search-tab-match" data-page="${p.pageId}" type="button">
                  <span class="search-tab-match-title">${p.title}</span>
                  <span class="search-tab-match-count">${p.count}</span>
                </button>
              `
            )
            .join("")}
        </div>
      `
        : "";

    if (results.length === 0) {
      this.resultsContainer.innerHTML = `
        ${summaryLine}
        ${tabMatches}
        <div class="search-no-results">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
          </svg>
          <div style="font-weight: 600; margin-bottom: 4px;">No results found</div>
          <div style="font-size: 13px;">Try different keywords or check spelling</div>
        </div>
      `;
      this.resultsContainer.classList.add("active");

      // Attach tab-match click handlers even when there are no structured results
      this.resultsContainer
        .querySelectorAll(".search-tab-match[data-page]")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const pageId = btn.dataset.page;
            this.pendingNavigation = { pageId, sectionId: null, rawQuery: originalQuery };
            NavigationManager.goToPage(pageId);
            this.hideResults();
          });
        });
      return;
    }

    const resultsHTML = `
      <div class="search-results-header">${results.length} result${
      results.length !== 1 ? "s" : ""
    } found</div>
      ${summaryLine}
      ${tabMatches}
      ${results.map((result) => this.createResultHTML(result, originalQuery)).join("")}
    `;

    this.resultsContainer.innerHTML = resultsHTML;
    this.resultsContainer.classList.add("active");

    // Add click handlers
    this.resultsContainer
      .querySelectorAll(".search-result-item")
      .forEach((item, index) => {
        item.addEventListener("click", () => {
          const result = results[index];
          this.pendingNavigation = {
            pageId: result.page,
            sectionId: result.sectionId || null,
            rawQuery: originalQuery,
          };

          NavigationManager.goToPage(result.page);
          // Keep the query in the search box (Ctrl+F behavior), just close dropdown.
          this.hideResults();
        });
      });

    // Tab match click handlers
    this.resultsContainer
      .querySelectorAll(".search-tab-match[data-page]")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const pageId = btn.dataset.page;
          this.pendingNavigation = { pageId, sectionId: null, rawQuery: originalQuery };
          NavigationManager.goToPage(pageId);
          this.hideResults();
        });
      });
  },

  createResultHTML(result, query) {
    const highlightedTitle = this.highlightText(result.title, query);
    const highlightedContext = this.highlightText(result.context, query);

    return `
      <div class="search-result-item">
        <div class="search-result-title">${highlightedTitle}</div>
        <div class="search-result-context">${highlightedContext}</div>
        <span class="search-result-badge">${result.category}</span>
      </div>
    `;
  },

  highlightText(text, query) {
    if (!query) return text;

    const terms = this.getQueryTerms(query);

    let highlightedText = text;

    terms.forEach((term) => {
      const regex = new RegExp(`(${this.escapeRegex(term)})`, "gi");
      highlightedText = highlightedText.replace(regex, "<mark>$1</mark>");
    });

    return highlightedText;
  },

  escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\

    <script src="app.js"></script>
  ");
  },

  hideResults() {
    if (this.resultsContainer) {
      this.resultsContainer.classList.remove("active");
    }
  },

  clearSearch() {
    const searchInput = document.getElementById("globalSearch");
    const searchClear = document.getElementById("searchClear");
    const scopeEl = document.getElementById("contentArea");

    // Clear global highlights
    this.clearHighlightsInScope(scopeEl, "find-highlight--global");
    this.globalFindState.terms = [];
    this.globalFindState.marks = [];
    this.globalFindState.index = -1;
    this.updateOccurrenceUI("global");

    if (searchInput) searchInput.value = "";
    if (searchClear) searchClear.style.display = "none";
    this.hideResults();
  },

  // Called after ContentManager renders a page
  onPageRendered(pageId) {
    // If the global search box has a query, re-apply Ctrl+F highlights on the new content
    const searchInput = document.getElementById("globalSearch");
    const raw = searchInput ? searchInput.value : "";
    const scopeEl = document.getElementById("contentArea");
    if (raw && raw.trim().length >= 2) {
      this.runFind(raw, {
        mode: "global",
        scopeEl,
        controls: { controlsId: "occurrenceControls", countId: "occurrenceCount" },
        highlightClass: "find-highlight--global",
      });
    }

    // Set up contraindications local search when that page is shown
    if (pageId === "contraindications") {
      this.initContraindicationsLocalSearch();
    }

    // If navigation was triggered by search, scroll to the target section (if any)
    if (this.pendingNavigation && this.pendingNavigation.pageId === pageId) {
      const { sectionId } = this.pendingNavigation;
      if (sectionId) {
        setTimeout(() => {
          const section = document.getElementById(sectionId);
          if (section) {
            section.scrollIntoView({ behavior: "smooth", block: "start" });
            section.style.animation = "highlight-pulse 2s ease-in-out";
            setTimeout(() => {
              section.style.animation = "";
            }, 2000);
          }
        }, 80);
      }
      this.pendingNavigation = null;
    }
  },

  initContraindicationsLocalSearch() {
    const input = document.getElementById("contraindicationsSearch");
    const clearBtn = document.getElementById("localSearchClear");
    const prevBtn = document.getElementById("localPrevOccurrence");
    const nextBtn = document.getElementById("localNextOccurrence");
    const scopeEl = document.getElementById("contentArea");

    if (!input || input.dataset.initialized === "true") {
      return;
    }
    input.dataset.initialized = "true";

    const run = (rawQuery) => {
      // Clear global highlights when local search is used, to prevent nested marks.
      this.clearHighlightsInScope(scopeEl, "find-highlight--global");
      this.globalFindState.terms = [];
      this.globalFindState.marks = [];
      this.globalFindState.index = -1;
      this.updateOccurrenceUI("global");

      this.runFind(rawQuery, {
        mode: "local",
        scopeEl,
        controls: {
          controlsId: "localOccurrenceControls",
          countId: "localOccurrenceCount",
        },
        highlightClass: "find-highlight--local",
      });

      if (clearBtn) {
        clearBtn.style.display = rawQuery && rawQuery.trim().length ? "flex" : "none";
      }
    };

    input.addEventListener(
      "input",
      Utils.debounce((e) => run(e.target.value), 180)
    );
    input.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        e.preventDefault();
        input.value = "";
        run("");
        if (clearBtn) clearBtn.style.display = "none";
        return;
      }
      if (e.key === "Enter") {
        e.preventDefault();
        if (e.shiftKey) this.gotoOccurrence(-1, "local");
        else this.gotoOccurrence(1, "local");
      }
    });

    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        input.value = "";
        run("");
        clearBtn.style.display = "none";
      });
    }

    if (prevBtn)
      prevBtn.addEventListener("click", () => this.gotoOccurrence(-1, "local"));
    if (nextBtn) nextBtn.addEventListener("click", () => this.gotoOccurrence(1, "local"));
  },
};

// ============================================
// Navigation Management
// ============================================
const NavigationManager = {
  init() {
    document.querySelectorAll(".nav-item[data-page]").forEach((item) => {
      item.addEventListener("click", () => this.goToPage(item.dataset.page));
    });

    const mobileToggle = document.getElementById("mobileToggle");
    const overlay = document.getElementById("overlay");

    if (mobileToggle) {
      mobileToggle.addEventListener("click", () => this.toggleMobileSidebar());
    }

    if (overlay) {
      overlay.addEventListener("click", () => this.closeMobileSidebar());
    }

    this.goToPage("dashboard");
  },

  goToPage(pageId) {
    AppState.currentPage = pageId;

    document.querySelectorAll(".nav-item").forEach((item) => {
      item.classList.toggle("active", item.dataset.page === pageId);
    });

    this.updateHeader(pageId);
    ContentManager.loadPage(pageId);
    this.closeMobileSidebar();
  },

  updateHeader(pageId) {
    const titles = {
      dashboard: [
        "Prescribing Dashboard",
        "Select a prescription type to begin safety checks",
      ],
      checklists: ["Safety Checklists", "Complete all required checks before signing"],
      transfer: [
        "Transfer Patient Checks",
        "New to MedExpress but has previous GLP-1 use",
      ],
      "proto-core": ["Core Checks Protocol", "Essential verification requirements"],
      "proto-scr": [
        "SCR Screening",
        "Pre-prescription SCR checks, outcomes, decision-making, macros and documentation",
      ],
      "proto-pue": ["Previous Use Evidence", "Requirements for transfer patients"],
      "proto-titration": ["Titration & Gap Treatment", "Dose escalation rules"],
      "proto-weight": ["Weight Monitoring", "Weight change thresholds"],
      "proto-switching": ["Switching & Side Effects", "Medication changes"],
      "proto-reviews": ["6 Month Reviews", "Review requirements"],
      consultation: ["Consultation Questions", "Required questions and expected answers"],
      definitions: ["Definitions", "Patient classifications"],
      contraindications: ["Contraindications", "Absolute and relative contraindications"],
      "titration-guide": ["Titration Guide", "Dose equivalence and gap adjustments"],
      rejections: ["Rejection Reasons", "Manual rejection reasons and when to use them"],
      tags: ["Tags Reference", "Common tags and usage"],
    };

    const [title, subtitle] = titles[pageId] || ["Page", "Loading..."];
    const titleEl = document.getElementById("page-title");
    const subtitleEl = document.getElementById("page-subtitle");
    if (titleEl) titleEl.textContent = title;
    if (subtitleEl) subtitleEl.textContent = subtitle;
  },

  toggleMobileSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    if (!sidebar || !overlay) return;
    sidebar.classList.toggle("open");
    overlay.classList.toggle("active");
  },

  closeMobileSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    if (!sidebar || !overlay) return;
    sidebar.classList.remove("open");
    overlay.classList.remove("active");
  },
};

// ============================================
// Content Management
// ============================================
const ContentManager = {
  loadPage(pageId) {
    const contentArea = document.getElementById("contentArea");
    if (!contentArea) return;

    setTimeout(() => {
      let content = "";

      switch (pageId) {
        case "dashboard":
          content = this.getDashboardContent();
          break;
        case "checklists":
          content = this.getChecklistsContent();
          break;
        case "transfer":
          content = this.getTransferContent();
          break;
        case "proto-core":
          content = this.getProtocolContent("core");
          break;
        case "proto-scr":
          content = this.getProtocolContent("scr");
          break;
        case "proto-pue":
          content = this.getProtocolContent("pue");
          break;
        case "proto-titration":
          content = this.getProtocolContent("titration");
          break;
        case "proto-weight":
          content = this.getProtocolContent("weight");
          break;
        case "proto-switching":
          content = this.getProtocolContent("switching");
          break;
        case "proto-reviews":
          content = this.getProtocolContent("reviews");
          break;
        case "consultation":
          content = this.getConsultationContent();
          break;
        case "definitions":
          content = this.getDefinitionsContent();
          break;
        case "contraindications":
          content = this.getContraindicationsContent();
          break;
        case "titration-guide":
          content = this.getTitrationGuideContent();
          break;
        case "rejections":
          content = this.getRejectionsContent();
          break;
        case "tags":
          content = this.getTagsContent();
          break;
        default:
          content = "<p>Page not found</p>";
      }

      contentArea.innerHTML = content;
      this.attachEventListeners(pageId);

      if (typeof SearchManager !== "undefined" && SearchManager.onPageRendered) {
        SearchManager.onPageRendered(pageId);
      }
    }, 50);
  },

  getDashboardContent() {
    return `
            <div class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
                Select Prescription Type
            </div>

            <div class="prescription-grid">
                <div class="prescription-card" data-type="starting">
                    <div class="prescription-icon starter">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <h3>New Order  Starter Dose</h3>
                    <p>New patients beginning GLP-1 treatment for the first time</p>
                    <div class="checks-count">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/></svg>
                      21 checks required
                    </div>
                </div>

                <div class="prescription-card" data-type="stepup">
                    <div class="prescription-icon stepup">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                    </div>
                    <h3>New Order  Continuation Dose</h3>
                    <p>Existing patients titrating to a higher dose</p>
                    <div class="checks-count">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/></svg>
                        9 checks required
                    </div>
                </div>

                <div class="prescription-card" data-type="repeat">
                    <div class="prescription-icon repeat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg>
                    </div>
                    <h3>Simple Repeats</h3>
                    <p>Existing patients ordering same dose (maintenance)</p>
                    <div class="checks-count">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/></svg>
                        12 checks required
                    </div>
                </div>
            </div>
        `;
  },

  getChecklistsContent() {
    return `
            <div class="checklist-panel active" id="checklist-starting">
                <div class="checklist-header">
                    <div class="checklist-title">
                        <h2>Starting Dose Checklist</h2>
                        <span class="type-badge starter">New Patient</span>
                    </div>
                    <div class="progress-ring">
                        <div class="progress-circle">
                            <svg width="64" height="64">
                                <defs>
                                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#22c55e"/>
                                        <stop offset="100%" stop-color="#06b6d4"/>
                                    </linearGradient>
                                </defs>
                                <circle class="bg" cx="32" cy="32" r="27"/>
                                <circle class="progress" cx="32" cy="32" r="27" stroke-dasharray="169.6" stroke-dashoffset="169.6" id="progress-starting"/>
                            </svg>
                <span class="progress-text" id="progress-text-starting">0/21</span>
                        </div>
                        <div class="progress-label">Checks<br>Complete</div>
                    </div>
                </div>

                ${this.getChecklistSections("starting")}

                <div class="status-bar">
                    <div class="status-info">
                        <div class="status-badge pending" id="status-badge-starting">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            <span>Pending</span>
                        </div>
                        <span style="color: var(--text-secondary); font-size: 14px;">Complete all checks to enable signing</span>
                    </div>
                    <div class="btn-actions">
                        <button class="btn btn-reset" data-checklist="starting">Reset</button>
                        <button class="btn btn-sign" id="btn-sign-starting" data-checklist="starting">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            Ready to Sign
                        </button>
                    </div>
                </div>
            </div>
        `;
  },

  getChecklistSections(type) {
    const sections = {
      starting: [
        {
          title: "Consultation & Eligibility",
          icon: "blue",
          checks: [
            {
              id: "s1",
              label: "Read full consultation and patient notes",
              hint: "Check for email updates, eligibility, any contraindications (Appendix 24), or GLP-1 hospitalisation history.",
              linkPage: "contraindications",
              linkLabel: "Open contraindications ",
            },
            {
              id: "s2",
              label: "Confirm age 1874 years (up to 74y 11m)",
              hint: "Check DOB from ID. Outside range  Reject 'Clinically Unsuitable' with refund. No escalation needed.",
              warning: true,
              linkPage: "consultation",
              linkLabel: "Open consultation questions ",
            },
            {
              id: "s3",
              label: "BMI within eligible range (3060, or 2760 with comorbidity)",
              hint: "Comorbidities: prediabetes, diabetes, heart disease, high BP, high cholesterol, sleep apnoea. Max BMI = 60.",
              infoCard: {
                type: "orange",
                title: "BMI Licensing Thresholds",
                content: " BMI 30: Eligible for GLP-1 (standard licensing)\n BMI 27 with comorbidities: Eligible with comorbidity\n BMI <30 (or <27 without comorbidity): Below-licence - requires PUE + starting BMI photo for NEW patients",
                linkPage: "pue",
                linkLabel: "View PUE & Below-Licence BMI Protocol "
              }
            },
            {
              id: "s3b",
              label: "Check ethnicity-adjusted BMI if applicable",
              hint: "Eligible ethnicities  threshold lowered to 27.5. Do not challenge ethnicity even if doesn't match ID.",
            },
            {
              id: "s3c",
              label: "No contraindications or GLP-1-related hospitalisation",
              hint: "If hospitalisation due to GLP-1 confirmed  Reject. If unclear  hold + email patient.",
              danger: true,
            },
          ],
        },
        {
          title: "ID Verification",
          icon: "green",
          checks: [
            {
              id: "s4",
              label: "ID is government-issued, valid, and in date",
              hint: "Passport, driving licence, PASS card. Must show full name, DOB, photo. Can be non-UK if genuine.",
            },
            {
              id: "s5",
              label: "ID matches patient account details",
              hint: "Small mismatches (nickname, DOB day, married name)  correct via Users page before prescribing.",
              warning: true,
            },
            {
              id: "s5b",
              label: "If ID fails: Apply correct tag",
              hint: "1st fail  add 'Failed ID' tag (auto email). 2nd+ fail  send personalised email + 'Pending Customer Response'. Unsure  escalate (Appendix 7).",
            },
          ],
        },
        {
          title: "Photo & Weight Verification",
          icon: "orange",
          checks: [
            {
              id: "s6",
              label: "Compare ID to selfie  confirm same person",
              hint: "Photos also used to verify BMI range. Face must be visible and match ID.",
            },
            {
              id: "s6b",
              label: "Weight verification photo meets requirements",
              hint: "Ideal: patient alone, full-length, face visible, fitted clothing. Accept imperfect if ID match clear & BMI assessable.",
            },
            {
              id: "s6c",
              label: "Photo issues handled correctly",
              hint: "Blurry/covered  'Weight verification failed' tag (once). Genitalia exposed  hold, request new photo, ask CS to delete. Photos don't match BMI  escalate.",
              warning: true,
            },
          ],
        },
        {
          title: "SCR Screening",
          icon: "blue",
          checks: [
            {
              id: "s9",
              label: "SCR checks done AFTER ID & weight verification",
              hint: "Do NOT access SCR until eligibility steps are completed (wrongful access = incident).",
              warning: true,
            },
            {
              id: "s10",
              label: "Review SCR scraping tool outcome",
              hint: "Pass  prescribe without opening SCR. Flagged  open SCR. No person found  follow SCR unavailable guidance.",
              linkPage: "proto-scr",
              linkLabel: "Open SCR Protocol ",
            },
            {
              id: "s11",
              label: "If flagged: review SCR for contraindications",
              hint: "Check Acute/Repeat Meds + Diagnoses + Problems/Issues. Reject for absolute contraindication; email/hold only if more info needed.",
            },
            {
              id: "s12",
              label: "Document SCR outcome in patient record",
              hint: "Notes: 'SCR pass' / 'SCR checked no contraindication' / 'SCR unavailable' / 'limited SCR' / 'contraindication found'.",
            },
          ],
        },
        {
          title: "GP Details",
          icon: "purple",
          checks: [
            {
              id: "s7",
              label: "GP is UK NHS surgery and verified",
              hint: "Green tick = validated. No tick  validate via Google/NHS ODS. Cannot validate  'Incomplete GP details' tag (auto email).",
            },
            {
              id: "s7b",
              label: "GP address is UK-based",
              hint: "Non-UK GP  tag 'Incomplete GP details', remove Prescriber Review, email for UK GP. No UK GP = reject.",
              warning: true,
            },
            {
              id: "s7c",
              label: "Minor GP errors corrected (if applicable)",
              hint: "Small corrections (name/house number) can be fixed directly by prescriber. Record the change.",
            },
          ],
        },
        {
          title: "Final Verification",
          icon: "green",
          checks: [
            {
              id: "s8",
              label: "Confirm order is in correct queue",
              hint: "'GLP1s  New orders, starter dose, screened / ready to be prescribed' (CC will have done initial screening).",
            },
            {
              id: "s8b",
              label: "Check for Assisted Prescribing flag",
              hint: "If flagged, apply all above checks + follow Assisted Prescribe SOP for extra steps.",
            },
            {
              id: "s8c",
              label: "All checks passed  safe to prescribe starter dose",
              hint: "Document that all prescribing checks in section 4.3 have been met before signing.",
            },
          ],
        },
      ],
      "transfer-above": [
        {
          title: "Order Identification & Common Checks",
          icon: "blue",
          checks: [
            {
              id: "ta1",
              label: "Confirm order is in Transfer Continuation queue",
              hint: "Queue: 'GLP1s  New orders, continuation dose, screened / ready to be prescribed'. Patient is new to MedExpress but has had GLP-1 elsewhere.",
            },
            {
              id: "ta2",
              label: "Read full consultation and patient notes",
              hint: "Check for email updates, contraindications, GLP-1 hospitalisation history. If unclear, tag 'Pending Customer Response' and email ALL missing points.",
              linkPage: "contraindications",
              linkLabel: "Open contraindications ",
            },
            {
              id: "ta3",
              label: "Age 1874, ID valid and matches account",
              hint: "ID can be expired for continuation (still first MedExpress order). Small mismatches  correct via Users page.",
            },
            {
              id: "ta4",
              label: "Confirm UK NHS GP (green tick or validated)",
              hint: "Validate via Google/NHS ODS if no tick. Correct small errors if needed.",
            },
          ],
        },
        {
          title: "BMI & Photo Verification",
          icon: "green",
          checks: [
            {
              id: "ta5",
              label: "Confirm BMI is ABOVE licence threshold",
              hint: "BMI 30, or 2730 with comorbidity, or 27.5 with eligible ethnicity. Max 60. This is for ABOVE licence transfers.",
            },
            {
              id: "ta6",
              label: "Current weight verification photos acceptable",
              hint: "Full-length, fitted clothing, face visible, consistent with stated BMI. ID matches selfie.",
            },
          ],
        },
        {
          title: "Previous Use Evidence (PUE)",
          icon: "orange",
          checks: [
            {
              id: "ta7",
              label: "PUE document shows: name, drug, dose, date, regulated provider",
              hint: "Acceptable: dispatch note, prescription, dispensing label. Order confirmation ALONE is NOT enough. NHS/registered pharmacy/clinic.",
              linkPage: "pue",
              linkLabel: "Open PUE Protocol ",
            },
            {
              id: "ta8",
              label: "PUE date is within past 6 months",
              hint: "Evidence must be within 6 months for step-up/maintenance request.",
            },
            {
              id: "ta9",
              label: "If PUE <2 weeks old: plan to send macro",
              hint: "Approve but send 'Clinical: PUE <2 Weeks Old' macro instructing patient NOT to start until current course complete.",
              warning: true,
            },
            {
              id: "ta10",
              label: "If PUE missing/inadequate: email + hold",
              hint: "Email via 'Clinical: Evidence missing information'. Add 'Pending Customer Response'. Without valid PUE  starter dose only.",
              warning: true,
            },
          ],
        },
        {
          title: "Dose & Timing Assessment",
          icon: "purple",
          checks: [
            {
              id: "ta11",
              label: "Requested dose fits gap-in-treatment guidance",
              hint: "Use PUE date + dose to check against Visual gap tables / Appendix 20 & 23.",
              linkPage: "titration",
              linkLabel: "Open Titration & Gap ",
            },
            {
              id: "ta12",
              label: "If switching GLP-1 drug: apply switching guidance",
              hint: "Use Visual Flow 2, Switching SOP, and dose equivalents table (Appendix 20). Complex cases  escalate.",
              linkPage: "switching",
              linkLabel: "Open Switching Protocol ",
            },
          ],
        },
        {
          title: "Hospitalisation & NHS Checks",
          icon: "blue",
          checks: [
            {
              id: "ta13",
              label: "No GLP-1-related hospitalisation",
              hint: "If hospitalisation indicated  hold + email to clarify. If confirmed GLP-1 related  REJECT.",
              danger: true,
            },
            {
              id: "ta14",
              label: "Patient NOT currently on NHS GLP-1",
              hint: "Current NHS treatment  NOT eligible for MedExpress. Stopped NHS treatment  NHS prescription can be used as PUE.",
              danger: true,
            },
          ],
        },
        {
          title: "SCR Screening",
          icon: "orange",
          checks: [
            {
              id: "ta15",
              label: "SCR checks done AFTER eligibility verified",
              hint: "Do NOT access SCR until eligibility steps are completed.",
              warning: true,
            },
            {
              id: "ta16",
              label: "Review SCR scraping tool outcome",
              hint: "Pass  prescribe without opening SCR. Flagged  open SCR. No person found  follow SCR unavailable guidance.",
              linkPage: "proto-scr",
              linkLabel: "Open SCR Protocol ",
            },
            {
              id: "ta17",
              label: "Document SCR outcome in patient record",
              hint: "Notes: 'SCR pass' / 'SCR checked no contraindication' / 'SCR unavailable' / 'contraindication found'.",
            },
          ],
        },
        {
          title: "Final Decision",
          icon: "green",
          checks: [
            {
              id: "ta18",
              label: "All checks passed  safe to prescribe continuation",
              hint: "Document: 'Transfer continuation  BMI above licence, PUE within 6 months and dose aligned with gap/titration guidance'.",
            },
          ],
        },
      ],
      "transfer-below": [
        {
          title: "Order Identification & Common Checks",
          icon: "blue",
          checks: [
            {
              id: "tb1",
              label: "Confirm order is in Transfer Continuation queue",
              hint: "Queue: 'GLP1s  New orders, continuation dose, screened / ready to be prescribed'. Patient is new to MedExpress but has had GLP-1 elsewhere.",
            },
            {
              id: "tb2",
              label: "Read full consultation and patient notes",
              hint: "Check for email updates, contraindications, GLP-1 hospitalisation history. If unclear, tag 'Pending Customer Response' and email ALL missing points.",
              linkPage: "contraindications",
              linkLabel: "Open contraindications ",
            },
            {
              id: "tb3",
              label: "Age 1874, ID valid and matches account",
              hint: "ID can be expired for continuation. Small mismatches  correct via Users page.",
            },
            {
              id: "tb4",
              label: "Confirm UK NHS GP (green tick or validated)",
              hint: "Validate via Google/NHS ODS if no tick. Correct small errors if needed.",
            },
          ],
        },
        {
          title: "BMI Verification (Below Licence)",
          icon: "green",
          checks: [
            {
              id: "tb5",
              label: "Confirm BMI is BELOW licence but 25",
              hint: "BMI below 30 (or 27 without comorbidity). Below-licence transfers need BOTH proof of supply AND previous BMI photo.",
              warning: true,
            },
            {
              id: "tb6",
              label: "Current weight verification photos acceptable",
              hint: "Full-length, fitted clothing, face visible, consistent with current BMI. ID matches selfie.",
            },
          ],
        },
        {
          title: "Previous Use Evidence (PUE) Document",
          icon: "orange",
          checks: [
            {
              id: "tb7",
              label: "PUE document shows: name, drug, dose, date, regulated provider",
              hint: "Dispatch note, prescription, or dispensing label. Order confirmation ALONE is NOT enough. NHS/registered pharmacy/clinic.",
              linkPage: "pue",
              linkLabel: "Open PUE Protocol ",
            },
            {
              id: "tb8",
              label: "PUE date is within past 6 months",
              hint: "Evidence must be within 6 months for continuation request.",
            },
            {
              id: "tb9",
              label: "If PUE fails: email via 'Evidence missing information'",
              hint: "Explain what's wrong, what's needed. Add 'Pending Customer Response'. Below-licence with no valid PUE = NOT eligible.",
              warning: true,
            },
          ],
        },
        {
          title: "Previous BMI Photo (REQUIRED for Below Licence)",
          icon: "purple",
          checks: [
            {
              id: "tb10",
              label: "Previous BMI photo provided",
              hint: "REQUIRED for below-licence transfers. Must prove they met licence BMI when starting GLP-1.",
              danger: true,
            },
            {
              id: "tb11",
              label: "Photo taken within 30 days of starting GLP-1",
              hint: "Must be from when they started with previous provider, not current photos.",
            },
            {
              id: "tb12",
              label: "Photo quality: full-length, well-lit, fitted clothing",
              hint: "Must support that they met licence BMI at start and are not clearly underweight.",
            },
            {
              id: "tb13",
              label: "If previous BMI photo fails: apply correct tag",
              hint: "Use 'previous BMI verification failed' tag (NOT 'Weight verification failed'). Email explaining why photo failed.",
              warning: true,
            },
          ],
        },
        {
          title: "Dose & Timing Assessment",
          icon: "blue",
          checks: [
            {
              id: "tb14",
              label: "Requested dose fits gap-in-treatment guidance",
              hint: "Use PUE date + dose to check against Visual gap tables / Appendix 20 & 23.",
              linkPage: "titration",
              linkLabel: "Open Titration & Gap ",
            },
            {
              id: "tb15",
              label: "If PUE <2 weeks old: plan to send macro",
              hint: "Approve but send 'Clinical: PUE <2 Weeks Old' macro instructing patient NOT to start until current course complete.",
            },
          ],
        },
        {
          title: "Hospitalisation & NHS Checks",
          icon: "orange",
          checks: [
            {
              id: "tb16",
              label: "No GLP-1-related hospitalisation",
              hint: "If hospitalisation indicated  hold + email to clarify. If confirmed GLP-1 related  REJECT.",
              danger: true,
            },
            {
              id: "tb17",
              label: "Patient NOT currently on NHS GLP-1",
              hint: "Current NHS treatment  NOT eligible. Stopped NHS treatment  NHS prescription can be used as PUE.",
              danger: true,
            },
          ],
        },
        {
          title: "SCR Screening",
          icon: "green",
          checks: [
            {
              id: "tb18",
              label: "SCR checks done AFTER eligibility verified",
              hint: "Do NOT access SCR until eligibility steps are completed.",
              warning: true,
            },
            {
              id: "tb19",
              label: "Review SCR scraping tool outcome + document",
              hint: "Pass  prescribe. Flagged  open SCR. Document outcome in patient record.",
              linkPage: "proto-scr",
              linkLabel: "Open SCR Protocol ",
            },
          ],
        },
        {
          title: "Final Decision",
          icon: "purple",
          checks: [
            {
              id: "tb20",
              label: "BOTH PUE document AND previous BMI photo acceptable",
              hint: "If either fails and cannot be corrected  patient is NOT eligible for MedExpress GLP-1 at below-licence BMI. Do NOT offer starter dose.",
              danger: true,
            },
            {
              id: "tb21",
              label: "All checks passed  safe to prescribe continuation",
              hint: "Document: 'Transfer continuation  below licence, PUE and starting-BMI photo requirements both met'.",
            },
          ],
        },
      ],
      repeat: [
        {
          title: "Step 1: Patient Confirmation & Basic Safety",
          icon: "blue",
          checks: [
            {
              id: "r1",
              label: "Confirm REPEAT GLP-1 patient (previous MedExpress GLP-1 prescribed and dispatched)",
              hint: "Order will be in repeat queue (not screened by Customer Care). Patient has had same GLP-1 before.",
              warning: true,
            },
            {
              id: "r2",
              label: "Age 1874 years confirmed",
              hint: "Age must be 1874. If outside range  Reject 'Clinically Unsuitable' with refund, no escalation needed.",
              danger: true,
              infoCard: {
                type: "warning",
                title: "Age Eligibility",
                content: "Age <18 or >74  Automatic rejection with refund using 'Clinically Unsuitable'."
              }
            },
            {
              id: "r3",
              label: "ID verified (can be expired for repeats, must show full name, DOB, photo match)",
              hint: "For repeats, expired ID is acceptable. Must be official ID with photo matching account. Small discrepancies (nickname, day of DOB, married name)  correct via Users page before issuing.",
            },
            {
              id: "r4",
              label: "Consultation read in full and reviewed for new contraindications",
              hint: "Check for pregnancy, new serious disease, incomplete/unclear info. If incomplete  email patient, tag Pending Customer Response, send only one email covering all issues.",
              linkPage: "contraindications",
              linkLabel: "View contraindications ",
            },
            {
              id: "r5",
              label: "UK NHS GP confirmed and validated",
              hint: "Small details differ but surgery clearly valid  correct and prescribe. If GP cannot be validated or non-UK  tag 'Incomplete GP details', remove Prescriber Review, email to request UK NHS GP, do NOT prescribe until provided.",
              warning: true,
            },
          ],
        },
        {
          title: "Step 2: BMI, Ethnicity & Photos (Repeat Rules)",
          icon: "blue",
          checks: [
            {
              id: "r6",
              label: "Check return purchase timeframe and apply correct BMI threshold",
              hint: "Minimum BMI for ongoing treatment: 21 kg/m. Timeframe determines eligibility rules.",
              warning: true,
              infoCard: {
                type: "orange",
                title: "BMI Thresholds for Repeat Patients",
                content: " Return <6 months: BMI 21 (PUE only if dose not aligned with gap rules)\n Return 612 months: BMI 25 (PUE if dose not aligned with gap rules)\n Return >12 months: Must meet full licensing BMI (30+ or 27+ with comorbidity/ethnicity)",
                linkPage: "pue",
                linkLabel: "View PUE Protocol "
              }
            },
            {
              id: "r7",
              label: "If return <6 months: BMI 21 acceptable",
              hint: "May prescribe down to BMI 21. PUE needed only if dose not in line with gap rules.",
            },
            {
              id: "r8",
              label: "If return 612 months: BMI 25 required",
              hint: "May prescribe only if BMI 25. PUE needed if dose not aligned with gap rules.",
            },
            {
              id: "r9",
              label: "If return >12 months: Full licensing BMI required (30+ or 27+ with comorbidity/ethnicity)",
              hint: "Treat as new patient. Must meet BMI 30+ or 27+ with comorbidity or qualifying ethnicity.",
              danger: true,
            },
            {
              id: "r10",
              label: "Ethnicity-adjusted BMI applied correctly if applicable",
              hint: "Certain ethnicities lower threshold to 27.5 (system allows from BMI 27.5). Do NOT question ethnicity if doesn't align with ID. If materially affects eligibility (BMI<30) and causes concern  escalate on Jira 'Weight  other/BMI questions'.",
            },
            {
              id: "r11",
              label: "Photos reviewed: ID match and BMI range validated",
              hint: "Use photos to validate ID match and BMI range. Follow photo scenarios below.",
              infoCard: {
                type: "orange",
                title: "Photo Scenarios for Repeats",
                content: " Borderline BMI but safe: Continue treatment per previous decision (maintain continuity). Do NOT request new photo or apply Weight verification failed.\n Clearly underweight: Send macro 'Repeat Customer Weight/Height Verification' requesting GP verified height/weight, then escalate.\n Blurred/face covered/ID mismatch (genuine mistake): May request new photos following Weight verification failed process.",
                linkPage: "weight-monitoring",
                linkLabel: "View Weight Monitoring "
              }
            },
          ],
        },
        {
          title: "Step 3: Titration Check (All Repeat Orders)",
          icon: "green",
          checks: [
            {
              id: "r12",
              label: "Check 'Has the patient titrated correctly?' for every repeat",
              hint: "Wegovy/Mounjaro: monthly titration. Nevolat: weekly titration (0.6mg increments up to 3mg max).",
              linkPage: "titration",
              linkLabel: "View Titration Guide ",
            },
            {
              id: "r13",
              label: "Scenario 3A: Normal upwards titration (previous 8 weeks, one step higher)",
              hint: "All checks OK  Prescribe next dose. Document: 'Simple titration repeat'.",
              infoCard: {
                type: "green",
                title: "Scenario 3A: Normal Upwards Titration",
                content: "Previous order within 8 weeks + requested dose one step higher + all other checks pass  Prescribe and document as 'Simple titration repeat'."
              }
            },
            {
              id: "r14",
              label: "Scenario 3B: Same dose or going down in strength",
              hint: "If no other issues  Prescribe, then send macro 'Clinical: Did not titrate up / Went down in strength (GLP1)'. Safe to step down >1 dose. Do NOT hold if otherwise safe. Don't repeat macro if already sent and patient has reasonable explanation.",
              infoCard: {
                type: "orange",
                title: "Scenario 3B: Same/Lower Dose",
                content: "Patient orders same or lower dose  Prescribe if safe, send macro advising contact if support needed. Safe to step down by >1 dose. Don't resend macro if already sent + reasonable explanation (good response, manageable side effects, affordability)."
              }
            },
            {
              id: "r15",
              label: "Scenario 3C: Apparent skipped dose (including 1-pen/2-pen patterns)",
              hint: "System shows dose X steps lower/higher. Check full order history and dates including pen quantities. If dates of higher-dose pens (ignoring interim lower order) would still make patient eligible within normal titration spacing  may be acceptable.",
              danger: true,
              infoCard: {
                type: "orange",
                title: "Scenario 3C: Skipped Dose",
                content: "If still appears skipped after review  Send macro 'Clinical: Evidence request  Skipped Dose (GLP1)'. Offer 2 options: (1) Amend to correct dose per titration, (2) Provide evidence of missing dose from another provider (PUE). Tag Pending Customer Response and hold. If justification/PUE acceptable (cost, trial, accident, stock)  prescribe higher dose. If not  change to correct dose, email explanation.",
                linkPage: "titration",
                linkLabel: "View Titration Protocol "
              }
            },
          ],
        },
        {
          title: "Step 4: Gap in Treatment Check",
          icon: "orange",
          checks: [
            {
              id: "r16",
              label: "Check 'Is there a gap between their orders?' for ALL repeat orders",
              hint: "Patients with >8 weeks gap automatically get 'Long treatment gap' tag. Use order date (not injection date) to measure gap.",
              warning: true,
              infoCard: {
                type: "orange",
                title: "Gap Rules Summary",
                content: " 8 weeks: Normal repeat, may titrate up\n >8 to 12 weeks: Continue last tolerated dose up to max restarting dose (see Appendix 23)\n Up to 6 months (BMI 21) or up to 12 months (BMI 25): Use gap guidance tables for safe restarting dose\n >12 months: Treat as restart, must meet full licensing BMI",
                linkPage: "titration",
                linkLabel: "View Gap Treatment Protocol "
              }
            },
            {
              id: "r17",
              label: "Gap 8 weeks: Normal repeat (may titrate up to next dose)",
              hint: "Treat as normal simple repeat if all other checks pass.",
            },
            {
              id: "r18",
              label: "Gap >8 to 12 weeks: Continue last tolerated dose up to max restarting dose",
              hint: "Use Appendix 23 for multi-pen orders. If ordered higher than allowed  Amend order to appropriate restarting dose + email explanation, OR hold with Pending Customer Response to discuss options.",
            },
            {
              id: "r19",
              label: "Gap up to 6 months (BMI 21) or up to 12 months (BMI 25)",
              hint: "Confirm BMI meets threshold. Use gap-in-treatment visual tables to pick safe restarting dose (often last tolerated or lower). If requested dose above guidance  adjust or hold + email. Ensure weight change and side-effect checks still pass.",
              warning: true,
            },
            {
              id: "r20",
              label: "Gap >12 months: Treat as restart (full licensing BMI required)",
              hint: "Must meet BMI 30+ or 27+ with comorbidity/ethnicity. If not  reject as clinically unsuitable. If meets  treat like new start (starter dose) and document.",
              danger: true,
            },
          ],
        },
        {
          title: "Step 5: Weight Change Thresholds",
          icon: "purple",
          checks: [
            {
              id: "r21",
              label: "Check 'Is their weight gain within the 7% threshold?'",
              hint: "Weight gain since last MedExpress order must be <7%. If 7%  use Appendix 12 guidance for tailored advice. Consider maintain/reduce/pause. Large weight gain should NOT be routine repeat.",
              warning: true,
              infoCard: {
                type: "orange",
                title: "Weight Gain >7% Threshold",
                content: "Weight gain 7% since last order  Use Appendix 12 for guidance. Options: maintain current dose, reduce dose, or pause treatment. Very large gains require clinical judgement or escalation.",
                linkPage: "weight-monitoring",
                linkLabel: "View Weight Monitoring "
              }
            },
            {
              id: "r22",
              label: "Check 'Is their weight loss within the 10% threshold?'",
              hint: "Weight loss since last MedExpress order must be <10%. If 10%  use Appendix 13 guidance. Very large weight loss should NOT be routine repeat; escalation expected.",
              warning: true,
              infoCard: {
                type: "orange",
                title: "Weight Loss >10% Threshold",
                content: "Weight loss 10% since last order  Use Appendix 13 for guidance. Very large weight loss requires clinical judgement or escalation. Not a routine repeat.",
                linkPage: "weight-monitoring",
                linkLabel: "View Weight Monitoring "
              }
            },
          ],
        },
        {
          title: "Step 6: Side Effects & Hospitalisation",
          icon: "red",
          checks: [
            {
              id: "r23",
              label: "Check 'Has the patient experienced side effects?' and review PUE notes",
              hint: "Review for any adverse effects. Check hospitalisation specifically.",
              linkPage: "contraindications",
              linkLabel: "View contraindications ",
            },
            {
              id: "r24",
              label: "Non-serious side effects: Continue with advice/dose adjustment",
              hint: "No hospitalisation + no major safety concern  May continue at same or lower dose. Provide side-effect advice using macros if needed.",
            },
            {
              id: "r25",
              label: "Hospitalisation linked to GLP-1: REJECT immediately",
              hint: "If consultation/PUE mentions hospitalisation  Place on hold and email to clarify. If patient confirms hospitalisation DUE TO GLP-1  REJECT order. Patient NOT eligible for further MedExpress GLP-1 treatment.",
              danger: true,
              infoCard: {
                type: "red",
                title: "GLP-1 Hospitalisation = Permanent Exclusion",
                content: "Any confirmed hospitalisation due to GLP-1 (pancreatitis, severe gastroparesis, severe dehydration, allergic reaction)  Patient is permanently ineligible for MedExpress GLP-1 treatment. Reject order immediately.",
                linkPage: "contraindications",
                linkLabel: "View Contraindications "
              }
            },
          ],
        },
        {
          title: "Step 7: Periodic Review (PR) Requirements",
          icon: "purple",
          checks: [
            {
              id: "r26",
              label: "Check if Periodic Review (PR) is due for this repeat patient",
              hint: "Wegovy/Mounjaro: PR at 6, 12, 18 months from first GLP-1 course (any provider) if weight loss <5%. Nevolat: 4-month check-in if weight loss <5%. PR clock resets when switching GLP-1 products.",
              warning: true,
              infoCard: {
                type: "purple",
                title: "Periodic Review (PR) Rules",
                content: " Wegovy/Mounjaro: PR required at 6, 12, 18 months if overall weight loss <5%\n Nevolat: 4-month check-in if weight loss <5%\n PR 'clock' resets when patient switches GLP-1 product (e.g., Mounjaro  Wegovy)\n Do NOT continue routine repeats until PR completed if due",
                linkPage: "reviews",
                linkLabel: "View 6 Month Reviews "
              }
            },
            {
              id: "r27",
              label: "If PR due and not completed: Follow Periodic Review SOP",
              hint: "Generally do NOT continue routine repeats until review is done. If PR outcome is to continue  proceed with all simple-repeat checks.",
            },
          ],
        },
        {
          title: "Step 8: Final Decision & Documentation",
          icon: "purple",
          checks: [
            {
              id: "r28",
              label: "APPROVE: All checks passed (consultation, ID, GP, BMI/gap, titration, weight, side effects, PR)",
              hint: "Issue prescription. Document: 'Simple repeat  correct titration, BMI and weight change within SOP thresholds, no contraindications or PR due'.",
            },
            {
              id: "r29",
              label: "HOLD: Use appropriate tag (Pending Customer Response, Long treatment gap, Incomplete GP details)",
              hint: "Send ONE email covering all missing information. Do not send multiple CRMs.",
            },
            {
              id: "r30",
              label: "ESCALATE: Use escalated tag and remove Prescriber Review when uncertain",
              hint: "Escalate for: BMI/photo safety concerns, ethnicity/BMI concerns, complex PUE/titration, unusual side-effect patterns. Follow Appendix 7 escalation process.",
            },
            {
              id: "r31",
              label: "REJECT: Age outside 1874, BMI rules not met, confirmed GLP-1 hospitalisation, no acceptable UK GP, contraindications",
              hint: "Use correct rejection reason from Appendix 16. Clearly document why. Reject for: age, BMI (cannot be resolved with PUE), GLP-1 hospitalisation, no UK GP, contraindications in Appendix 24.",
              danger: true,
            },
          ],
        },
      ],
      stepup: [
        {
          title: "Order Type Identification",
          icon: "blue",
          checks: [
            {
              id: "c1",
              label: "Identify if this is a NEW order or continuation",
              hint: "NEW order: patient has never received GLP-1 from MedExpress before. Continuation: patient already receiving treatment.",
              warning: true,
            },
            {
              id: "c2",
              label: "If NEW order: verify this is continuation dose, not starter",
              hint: "New orders for continuation dose must meet transfer criteria (PUE + BMI documentation if below-licence).",
              danger: true,
            },
          ],
        },
        {
          title: "BMI Verification (All Continuation Orders)",
          icon: "blue",
          checks: [
            {
              id: "c3",
              label: "Current BMI documented and calculated correctly",
              hint: "Verify height and weight measurements. Calculate BMI = weight(kg) / height(m).",
            },
            {
              id: "c4",
              label: "For ABOVE-licence BMI (30, or 27 with comorbidity): standard continuation criteria apply",
              hint: "Comorbidities: prediabetes, diabetes, heart disease, high BP, high cholesterol, sleep apnoea. These patients can continue as normal.",
            },
            {
              id: "c5",
              label: "For BELOW-licence BMI (<30, or <27 without comorbidity): PUE required for NEW orders only",
              hint: "If this is a NEW order (transfer patient) with below-licence BMI  PUE document AND starting BMI photo required. If continuation from existing MedExpress patient  PUE NOT required.",
              danger: true,
            },
          ],
        },
        {
          title: "PUE Requirements (NEW Orders Below-Licence Only)",
          icon: "orange",
          checks: [
            {
              id: "c6",
              label: "PUE document provided and acceptable",
              hint: "Must show: patient name, medication name, dose, prescriber details, date. Must be from legitimate prescriber.",
              danger: true,
            },
            {
              id: "c7",
              label: "Previous BMI photo provided showing STARTING BMI was above licence threshold",
              hint: "Photo must show BMI 30 (or 27 with comorbidity) at treatment start. If photo unavailable or shows below-licence  patient NOT eligible.",
              danger: true,
            },
            {
              id: "c8",
              label: "BOTH PUE and starting BMI photo requirements met",
              hint: "If either requirement fails  patient cannot receive below-licence continuation via MedExpress. Reject order.",
              danger: true,
            },
          ],
        },
        {
          title: "Dose Titration & Safety",
          icon: "green",
          checks: [
            {
              id: "c9",
              label: "Requested dose follows appropriate titration schedule",
              hint: "Review previous doses. Titration should follow manufacturer guidance (typically 4-week intervals).",
            },
            {
              id: "c10",
              label: "Check for any treatment gaps",
              hint: "Gap >90 days may require clinical review. Gap >180 days requires restart from starter dose.",
              warning: true,
            },
            {
              id: "c11",
              label: "No recent hospitalisations related to GLP-1",
              hint: "Check for: pancreatitis, severe gastroparesis, severe dehydration, allergic reaction. Any GLP-1 hospitalisation = permanent exclusion.",
              danger: true,
              linkPage: "contraindications",
              linkLabel: "View contraindications ",
            },
          ],
        },
        {
          title: "SCR Screening & Contraindications",
          icon: "red",
          checks: [
            {
              id: "c12",
              label: "SCR screening completed (if applicable)",
              hint: "Review Summary Care Record for relevant medical history, medications, allergies.",
            },
            {
              id: "c13",
              label: "No new contraindications identified",
              hint: "Check Appendix 24 for absolute and relative contraindications. Any new contraindications  escalate to senior clinician.",
              danger: true,
              linkPage: "contraindications",
              linkLabel: "View contraindications ",
            },
            {
              id: "c14",
              label: "No concerning drug interactions",
              hint: "Pay special attention to: insulin, sulfonylureas, warfarin, other diabetes medications.",
              warning: true,
            },
          ],
        },
        {
          title: "Clinical Review & Documentation",
          icon: "purple",
          checks: [
            {
              id: "c15",
              label: "Weight loss progress documented (if applicable)",
              hint: "Review weight trend. Minimum 5% weight loss expected after 6 months for continuation.",
            },
            {
              id: "c16",
              label: "Side effects reviewed and manageable",
              hint: "Common side effects: nausea, vomiting, diarrhea, constipation. Should improve with time. Severe/persistent  escalate.",
            },
            {
              id: "c17",
              label: "Patient consultation/review completed within last 12 months",
              hint: "All continuation patients need valid consultation within 12 months. If >12 months  new consultation required.",
              warning: true,
            },
          ],
        },
        {
          title: "Final Decision",
          icon: "purple",
          checks: [
            {
              id: "c18",
              label: "All eligibility criteria met",
              hint: "Confirm: BMI appropriate, no contraindications, safe dose progression, valid consultation.",
            },
            {
              id: "c19",
              label: "Clinical notes updated with decision rationale",
              hint: "Document: current BMI, dose justification, any PUE requirements met (if applicable), next review due.",
            },
            {
              id: "c20",
              label: "All checks passed  safe to prescribe continuation dose",
              hint: "Final confirmation that continuation prescription is clinically appropriate and safe to dispense.",
            },
          ],
        },
      ],
    };

    const sectionData = sections[type] || [];
    return sectionData
      .map(
        (section) => `
            <div class="checklist-section">
                <div class="section-header">
                    <div class="section-header-icon ${section.icon}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/></svg>
                    </div>
                    <span>${section.title}</span>
                </div>
                ${section.checks
                  .map(
                    (check) => `
                    <div class="check-item" data-id="${
                      check.id
                    }" data-checklist="${type}" data-accent="${section.icon}">
                        <div class="checkbox">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="check-content">
                            <div class="check-label">${check.label}</div>
                            <div class="check-hint ${
                              check.danger ? "danger" : check.warning ? "warning" : ""
                            }">${check.hint}</div>
                            ${
                              check.linkPage
                                ? `<a class="check-link" href="#" data-page="${
                                    check.linkPage
                                  }">${check.linkLabel || "View protocol "}</a>`
                                : ""
                            }
                            ${
                              check.infoCard
                                ? `<div class="info-card ${check.infoCard.type || 'blue'}" style="margin-top: 12px;">
                                    <div class="info-card-title">${check.infoCard.title}</div>
                                    <div class="info-card-text" style="white-space: pre-line;">${check.infoCard.content}</div>
                                    ${
                                      check.infoCard.linkPage
                                        ? `<a class="check-link" href="#" data-page="${check.infoCard.linkPage}" style="margin-top: 8px; display: inline-block;">${check.infoCard.linkLabel || "View protocol "}</a>`
                                        : ""
                                    }
                                   </div>`
                                : ""
                            }
                        </div>
                    </div>
                `
                  )
                  .join("")}
            </div>
        `
      )
      .join("");
  },

  getProtocolContent(type) {
    return `
            <div class="protocol-page">
                <div class="back-btn" data-page="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    Back to Dashboard
                </div>
                <div class="protocol-page-header">
                  <h1 class="page-h1">${this.getProtocolTitle(type)}</h1>
                  <p class="page-lead">${this.getProtocolSubtitle(type)}</p>
                </div>
                ${this.getProtocolCards(type)}
            </div>
        `;
  },

  getProtocolTitle(type) {
    const titles = {
      core: "Core Checks Protocol",
      scr: "SCR Screening Protocol",
      pue: "Previous Use Evidence",
      titration: "Titration & Gap Treatment",
      weight: "Weight Monitoring",
      switching: "Switching & Side Effects",
      reviews: "6 Month Reviews",
    };
    return titles[type] || "Protocol";
  },

  getProtocolSubtitle(type) {
    const subtitles = {
      core: "Essential verification requirements for all prescriptions",
      scr: "How to use SCR + scraping tool to identify contraindications and document decisions",
      pue: "Requirements for transfer patients and skipped doses",
      titration: "Dose escalation and gap adjustment rules",
      weight: "Weight gain and loss thresholds",
      switching: "Medication changes and side effect management",
      reviews: "Review requirements for continuing treatment after 6 months",
    };
    return subtitles[type] || "";
  },

  getProtocolCards(type) {
    switch (type) {
      case "core":
        return this.getCoreProtocolCards();
      case "scr":
        return this.getSCRProtocolCards();
      case "pue":
        return this.getPUEProtocolCards();
      case "titration":
        return this.getTitrationProtocolCards();
      case "weight":
        return this.getWeightProtocolCards();
      case "switching":
        return this.getSwitchingProtocolCards();
      case "reviews":
        return this.getReviewsProtocolCards();
      default:
        return '<div class="protocol-card"><div class="protocol-text">Protocol content not found.</div></div>';
    }
  },

  getSCRProtocolCards() {
    return `
      <div class="scr-protocol">
        <!-- SCR Tabs -->
        <div class="protocol-tabs">
          <button class="protocol-tab active" data-tab="workflow">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
            </svg>
            Workflow & Steps
          </button>
          <button class="protocol-tab" data-tab="checking">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="16" rx="2"/>
              <path d="M8 8h8M8 12h8M8 16h8"/>
            </svg>
            Checking SCR
          </button>
          <button class="protocol-tab" data-tab="outcomes">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <path d="M12 9v4"/>
              <path d="M12 17h.01"/>
            </svg>
            Outcomes & Actions
          </button>
          <button class="protocol-tab" data-tab="documentation">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
              <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
            </svg>
            Documentation
          </button>
        </div>

        <!-- Tab 1: Workflow & Steps -->
        <div class="protocol-tab-content active" data-tab-content="workflow">

        <div class="protocol-hero">
          <div class="protocol-hero-title">SCR workflow  quick view</div>
          <div class="protocol-hero-subtitle">
            Use SCR as an <strong>independent safety verification</strong> step before prescribing GLP1s.
            <strong>Do not</strong> use SCR to verify BMI/biometrics or WeightRelated CoMorbidities (WRCM).
          </div>

          <div class="scr-flow">
            <div class="scr-flow-card green">
              <div class="scr-flow-top">
                <span class="scr-chip green">Step 1</span>
                <span class="scr-flow-title">Eligibility first</span>
              </div>
              <div class="scr-flow-text">Confirm ID + weight verification + questionnaire eligibility <strong>before</strong> SCR.</div>
            </div>
            <div class="scr-flow-card blue">
              <div class="scr-flow-top">
                <span class="scr-chip blue">Step 2</span>
                <span class="scr-flow-title">Scraping tool</span>
              </div>
              <div class="scr-flow-text">Pass  prescribe (no need to open SCR). Flagged  open SCR. No person found  follow SCR unavailable guidance.</div>
            </div>
            <div class="scr-flow-card orange">
              <div class="scr-flow-top">
                <span class="scr-chip orange">Step 3</span>
                <span class="scr-flow-title">Decision</span>
              </div>
              <div class="scr-flow-text">Absolute contraindication  reject. Needs more info  email patient (one email with all questions) + hold.</div>
            </div>
            <div class="scr-flow-card purple">
              <div class="scr-flow-top">
                <span class="scr-chip purple">Step 4</span>
                <span class="scr-flow-title">Document</span>
              </div>
              <div class="scr-flow-text">Use consistent notes (examples below). Wrongful access  PSI.</div>
            </div>
          </div>
        </div>

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
              </svg>
            </div>
            When to check SCR (and in what order)
          </div>
          <ul class="protocol-list">
            <li><strong>New patients:</strong> after ID + weight verification and questionnaire eligibility checks, proceed to SCR pathway.</li>
            <li><strong>Repeat patients (when eligible for SCR checks):</strong> still confirm eligibility (ID/BMI), then review SCR, then complete usual clinical checks (dose/type, gaps, tags).</li>
            <li><strong>One email rule:</strong> if anything needs clarification (SCR + PUE/dose issues + tags), send <strong>one single email</strong> containing <strong>every question</strong> needed to decide.</li>
          </ul>
          <div class="info-card red" style="margin-top: 12px;">
            <div class="info-card-title">Wrongful SCR access = incident</div>
            <div class="info-card-text">Entering SCR <strong>before</strong> ID + weight verification is an incident  complete a PSI. Accidental wrong-patient SCR access is also a PSI.</div>
          </div>
          <div class="info-card blue" style="margin-top: 12px;">
            <div class="info-card-title">Repeat rejections</div>
            <div class="info-card-text">If a <strong>repeat</strong> order is rejected based on SCR information, complete a PSI using "Patient provided incorrect information - SCR confirmed".</div>
          </div>
        </div>

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
              </svg>
            </div>
            Scraping tool outcomes (what to do)
          </div>
          <div class="scr-outcomes">
            <div class="scr-outcome-card green">
              <div class="scr-outcome-title"><span class="scr-chip green">PASS</span> No keyword match</div>
              <div class="scr-outcome-text">Valid for 6 months. <strong>Prescribe without opening SCR.</strong> Document "SCR pass".</div>
            </div>
            <div class="scr-outcome-card orange">
              <div class="scr-outcome-title"><span class="scr-chip orange">FLAGGED</span> Keyword match</div>
              <div class="scr-outcome-text"><strong>Open SCR</strong> to determine: absolute contraindication vs needs more information.</div>
            </div>
            <div class="scr-outcome-card purple">
              <div class="scr-outcome-title"><span class="scr-chip purple">NO RECORD</span> No person found</div>
              <div class="scr-outcome-text">Follow SCR unavailable guidance: document, proceed per questionnaire. <strong>Do not</strong> hold or email purely due to missing SCR.</div>
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 1 -->

        <!-- Tab 2: Checking SCR -->
        <div class="protocol-tab-content" data-tab-content="checking">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon orange">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l9 4v6c0 5-3.8 9.7-9 10-5.2-.3-9-5-9-10V6l9-4z"/>
                <path d="M12 8v4"/>
                <path d="M12 16h.01"/>
              </svg>
            </div>
            Permission to view SCR
          </div>
          <div class="protocol-text">If a patient has not granted permission to view SCR (legacy orders placed before permission was mandatory):</div>
          <ul class="protocol-list">
            <li>Email the patient using <strong>Macro 11</strong> (template below).</li>
            <li>If permission is granted over email: document permission + link to Zendesk ticket, then proceed to check SCR on NHS site.</li>
            <li>If permission is not granted: <strong>reject</strong> the order.</li>
          </ul>
        </div>

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/>
                <path d="M8 8h8M8 12h8M8 16h8"/>
              </svg>
            </div>
            If flagged: how to enter & review SCR
          </div>
          <div class="scr-two-col">
            <div>
              <div class="protocol-section-title">Accessing SCR</div>
              <ol class="protocol-ol">
                <li>Open SCR via NHS Spine Services (or open NHS site button in interface).</li>
                <li>Login with HeliosX email + password.</li>
                <li>Enter the 6-digit verification code (Authenticator app).</li>
                <li>Select the appropriate role, then Continue to Find patient.</li>
              </ol>
            </div>
            <div>
              <div class="protocol-section-title">Searching & reviewing</div>
              <ol class="protocol-ol">
                <li>Use Advanced search.</li>
                <li>Enter Gender, First name, Last name, DOB (single date).</li>
                <li>Find patient  verify demographics (address if multiple matches).</li>
                <li>Enter record  Clinical tab  confirm permission to view.</li>
                <li>Review: Acute meds, Repeat meds, Diagnoses, Problems/Issues.</li>
              </ol>
            </div>
          </div>

          <details class="accordion">
            <summary>SCR not available / limited  what to do</summary>
            <div class="accordion-body">
              <div class="table-wrapper">
                <table class="protocol-table">
                  <tr><th style="width: 35%;">Scenario</th><th>Prescriber action</th></tr>
                <tr><td><strong>SCR available</strong></td><td>Proceed with SCR review, document outcome, and act accordingly.</td></tr>
                <tr><td><strong>SCR not available</strong></td><td>Document SCR unavailable. Proceed based on questionnaire/standard SOP. <strong>Do not</strong> hold the order. <strong>Do not</strong> email patient purely due to missing SCR.</td></tr>
                <tr><td><strong>SCR available but limited</strong></td><td>Document SCR checked but limited. Proceed per standard SOP. Do not hold unless specific information is required about a condition/medication.</td></tr>
              </table>
              <div class="protocol-text" style="margin-top: 10px;">Common reasons: recently registered NHS patient, mismatched demographics, outside England (Wales/Scotland/NI), opted out/limited, GP practice not fully enabled, not registered with GP, enhanced privacy.</div>
            </div>
          </details>
        </div>

        </div>
        <!-- End Tab 2 -->

        <!-- Tab 3: Outcomes & Actions -->
        <div class="protocol-tab-content" data-tab-content="outcomes">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon red">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                <path d="M12 9v4"/>
                <path d="M12 17h.01"/>
              </svg>
            </div>
            Decision-making (flagged SCR)
          </div>
          <div class="protocol-text">If the scraping tool flags a keyword, open SCR and decide between: <strong>absolute contraindication</strong> (reject) vs <strong>needs further information</strong> (email + hold) vs <strong>escalate</strong> if uncertain.</div>

          <details class="accordion">
            <summary>Absolute contraindications  reject immediately</summary>
            <div class="accordion-body">
              <div class="protocol-text"><strong>Table 1:</strong> If any of these conditions are present, <strong>reject the prescription immediately</strong>. No further information needed.</div>
              <div class="table-wrapper">
                <table class="protocol-table">
                <tr><th>Condition</th><th>Action</th></tr>
                <tr><td><strong> Pancreatitis</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">Including acute or chronic pancreatic insufficiency</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Eating Disorders</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;"> Anorexia nervosa<br> Bulimia nervosa<br> Binge Eating Disorder (BED)<br> Avoidant/Restrictive Food Intake Disorder (ARFID)</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Type 1 Diabetes</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">Aka Insulin-dependent diabetes mellitus (IDDM)</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Liver Cirrhosis</strong></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Liver Transplant</strong></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Endocrine Disorders</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">Acromegaly, Cushing's, Addison's, congenital adrenal hyperplasia</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Ulcerative Colitis</strong></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Crohn's Disease</strong></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Gastroparesis</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">Delayed gastric emptying</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Multiple Endocrine Neoplasia type 2 (MEN2)</strong></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Medullary Thyroid Cancer</strong></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Oral Diabetic Medication</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">On repeat medication list  See detailed list below</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Medication with Narrow Therapeutic Index</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">On repeat medication list  See detailed list below</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Insulin</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">On repeat medication list</span></td><td><span class="decision-reject">REJECT</span></td></tr>
                <tr><td><strong> Thyroid Disease</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">For <strong>Nevolat</strong> prescriptions ONLY</span></td><td><span class="decision-reject">REJECT</span></td></tr>
              </table>
              </div>

              <div class="protocol-section-title" style="margin-top: 20px;">Oral diabetic medications (reject if on repeat list)</div>
              <div class="scr-two-col">
                <div>
                  <strong>Sulfonylureas:</strong>
                  <ul class="protocol-list">
                    <li>Diamicron [gliclazide]</li>
                    <li>Daonil [glibenclamide]</li>
                    <li>Rastin [tolbutamide]</li>
                  </ul>
                  <strong>SGLT2 inhibitors:</strong>
                  <ul class="protocol-list">
                    <li>Jardiance [empagliflozin]</li>
                    <li>Forxiga [dapagliflozin]</li>
                    <li>Invokana [canagliflozin]</li>
                  </ul>
                </div>
                <div>
                  <strong>DPP-4 inhibitors:</strong>
                  <ul class="protocol-list">
                    <li>Januvia [sitagliptin]</li>
                    <li>Galvus [vildagliptin]</li>
                    <li>Trajenta [linagliptin]</li>
                  </ul>
                  <strong>Thiazolidinediones:</strong>
                  <ul class="protocol-list">
                    <li>Actos [pioglitazone]</li>
                  </ul>
                </div>
              </div>

              <div class="protocol-section-title" style="margin-top: 20px;">Narrow Therapeutic Index medications (reject if on repeat list)</div>
              <div class="scr-two-col">
                <div>
                  <ul class="protocol-list">
                    <li>Amiodarone</li>
                    <li>Carbamazepine</li>
                    <li>Ciclosporin</li>
                    <li>Clozapine</li>
                    <li>Digoxin</li>
                    <li>Fenfluramine</li>
                    <li>Lithium</li>
                  </ul>
                </div>
                <div>
                  <ul class="protocol-list">
                    <li>Mycophenolate mofetil</li>
                    <li><strong>Oral</strong> methotrexate</li>
                    <li>Phenobarbital</li>
                    <li>Phenytoin</li>
                    <li>Somatrogon</li>
                    <li>Tacrolimus</li>
                    <li>Theophylline</li>
                    <li>Warfarin</li>
                  </ul>
                </div>
              </div>
            </div>
          </details>

          <details class="accordion">
            <summary>Table 2: Time-sensitive conditions  workflow with macros</summary>
            <div class="accordion-body">
              <div class="protocol-text"><strong>Table 2:</strong> When timing information is needed, use appropriate macro. Reject when timing falls within contraindication window.</div>
              <div class="table-wrapper">
                <table class="protocol-table">
                <tr>
                  <th>Condition</th>
                  <th>Timeframe</th>
                  <th>Macro</th>
                  <th>Before Emailing</th>
                  <th>After Patient Response</th>
                </tr>
                <tr>
                  <td><strong> Bariatric Surgery</strong><br><span style=\"font-size: 0.85em; color: var(--text-muted); font-style: italic;\">RYGB  Sleeve  Gastric Band  BPD/DS  Mini Bypass  Gastric balloon</span></td>
                  <td><span style=\"font-weight: 700; color: var(--danger); font-size: 14px;\">&lt;12 months</span></td>
                  <td><a href=\"#macro-1\" class=\"tag blue\">Macro 1</a></td>
                  <td><div class=\"checklist-item\">Check SCR for surgery date</div><div class=\"checklist-item\">If timing unclear  hold + email</div><div class=\"checklist-item\">Add tag: <span class=\"tag orange\">Pending Customer Response</span></div></td>
                  <td><span class=\"decision-reject\">REJECT</span> if &lt;12 months<br><br><span class=\"decision-prescribe\">PRESCRIBE</span> if 12 months</td>
                </tr>
                <tr>
                  <td><strong> Cholecystectomy</strong><br><span style=\"font-size: 0.85em; color: var(--text-muted); font-style: italic;\">(gallbladder removal)</span></td>
                  <td><span style=\"font-weight: 700; color: var(--danger); font-size: 14px;\">&lt;12 months</span></td>
                  <td><a href=\"#macro-1\" class=\"tag blue\">Macro 1</a></td>
                  <td><div class=\"checklist-item\">Check SCR for surgery date</div><div class=\"checklist-item\">If timing unclear  hold + email</div><div class=\"checklist-item\">Add tag: <span class=\"tag orange\">Pending Customer Response</span></div></td>
                  <td><span class=\"decision-reject\">REJECT</span> if &lt;12 months<br><br><span class=\"decision-prescribe\">PRESCRIBE</span> if 12 months</td>
                </tr>
                <tr>
                  <td><strong> Insulin</strong></td>
                  <td><span style=\"font-weight: 700; color: var(--danger); font-size: 14px;\">&lt;3 months</span><br><strong style=\"color: var(--danger);\">OR</strong><br><span style=\"font-weight: 700; color: var(--danger);\">On repeat list</span></td>
                  <td><a href=\"#macro-1\" class=\"tag blue\">Macro 1</a></td>
                  <td><div class=\"checklist-item\">Check acute meds (last 3 months)</div><div class=\"checklist-item\">Check repeat medication list</div><div class=\"checklist-item\">If on repeat list  <strong>reject immediately</strong></div><div class=\"checklist-item\">If timing unclear  hold + email</div></td>
                  <td><span class=\"decision-reject\">REJECT</span> if prescribed within 3 months or on repeat list</td>
                </tr>
                <tr>
                  <td><strong> Oral Diabetic Meds</strong><br><span style=\"font-size: 0.85em; color: var(--text-muted); font-style: italic;\">Sulfonylureas  SGLT2 inhibitors  DPP-4 inhibitors  Thiazolidinediones</span></td>
                  <td><span style=\"font-weight: 700; color: var(--danger); font-size: 14px;\">&lt;3 months</span><br><strong style=\"color: var(--danger);\">OR</strong><br><span style=\"font-weight: 700; color: var(--danger);\">On repeat list</span></td>
                  <td><a href=\"#macro-1\" class=\"tag blue\">Macro 1</a></td>
                  <td><div class=\"checklist-item\">Check acute meds (last 3 months)</div><div class=\"checklist-item\">Check repeat medication list</div><div class=\"checklist-item\">If on repeat list  <strong>reject immediately</strong></div><div class=\"checklist-item\">If timing unclear  hold + email</div></td>
                  <td><span class=\"decision-reject\">REJECT</span> if prescribed within 3 months or on repeat list</td>
                </tr>
                <tr>
                  <td><strong> Narrow Therapeutic Index Meds</strong><br><span style=\"font-size: 0.85em; color: var(--text-muted); font-style: italic;\">Amiodarone  Carbamazepine  Ciclosporin  Clozapine  Digoxin  Lithium  Warfarin  Others</span></td>
                  <td><span style=\"font-weight: 700; color: var(--danger); font-size: 14px;\">&lt;3 months</span><br><strong style=\"color: var(--danger);\">OR</strong><br><span style=\"font-weight: 700; color: var(--danger);\">On repeat list</span></td>
                  <td><a href=\"#macro-1\" class=\"tag blue\">Macro 1</a></td>
                  <td><div class=\"checklist-item\">Check acute meds (last 3 months)</div><div class=\"checklist-item\">Check repeat medication list</div><div class=\"checklist-item\">If on repeat list  <strong>reject immediately</strong></div><div class=\"checklist-item\">If timing unclear  hold + email</div></td>
                  <td><span class=\"decision-reject\">REJECT</span> if prescribed within 3 months or on repeat list</td>
                </tr>
                <tr>
                  <td><strong> Orlistat</strong><br><span style=\"font-size: 0.85em; color: var(--text-muted); font-style: italic;\">Alli  Xenical</span></td>
                  <td><span style=\"font-weight: 700; color: var(--danger); font-size: 14px;\">&lt;1 month</span></td>
                  <td><a href=\"#macro-1\" class=\"tag blue\">Macro 1</a></td>
                  <td><div class=\"checklist-item\">Check SCR for recent Orlistat</div><div class=\"checklist-item\">If timing unclear  hold + email</div><div class=\"checklist-item\">Add tag: <span class=\"tag orange\">Pending Customer Response</span></div></td>
                  <td><span class=\"decision-reject\">REJECT</span> if &lt;1 month<br><br><em style=\"color: var(--text-muted); font-size: 0.9em;\">Concurrent use contraindicated</em></td>
                </tr>
              </table>
              <div class="info-card warning" style="margin-top: 12px;">
                <div class="info-card-title">Transfer edge case</div>
                <div class="info-card-text">If GLP1 is flagged for a transfer patient with PUE within the last month, follow up using main SOP (macro PUE &lt;2 Weeks Old) rather than rejecting.</div>
              </div>
            </div>
          </details>

          <details class="accordion">
            <summary>Table 3: Clinical details needed  macros & decision pathway</summary>
            <div class="accordion-body">
              <div class="protocol-text"><strong>Table 3:</strong> When clinical details are needed to make a prescribing decision.</div>
              <div class="table-wrapper">
                <table class="protocol-table">
                <tr>
                  <th>Condition</th>
                  <th>Macro</th>
                  <th>Before Emailing</th>
                  <th>Information to Request</th>
                  <th>After Patient Response</th>
                </tr>
                <tr>
                  <td><strong> Cholelithiasis</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">(gallstones)</span></td>
                  <td><a href="#macro-2" class="tag blue">Macro 2</a></td>
                  <td><div class="checklist-item">Check SCR for cholecystectomy evidence</div><div class="checklist-item">If no evidence  hold + email</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Ask if patient had cholecystectomy (gallbladder removal surgery)</td>
                  <td><span class="decision-reject">REJECT</span> if no cholecystectomy<br><br><span class="decision-prescribe">PRESCRIBE</span> if cholecystectomy confirmed</td>
                </tr>
                <tr>
                  <td><strong> Cholecystitis</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">(gallbladder inflammation)</span></td>
                  <td><a href="#macro-2" class="tag blue">Macro 2</a></td>
                  <td><div class="checklist-item">Check SCR for cholecystectomy evidence</div><div class="checklist-item">If no evidence  hold + email</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Ask if patient had cholecystectomy (gallbladder removal surgery)</td>
                  <td><span class="decision-reject">REJECT</span> if no cholecystectomy<br><br><span class="decision-prescribe">PRESCRIBE</span> if cholecystectomy confirmed</td>
                </tr>
                <tr>
                  <td><strong> Heart Failure (HF)</strong></td>
                  <td><a href="#macro-4" class="tag blue">Macro 4</a></td>
                  <td><div class="checklist-item">Check SCR for HF stage</div><div class="checklist-item">If stage unclear  hold + email</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Request latest cardiology letter stating:<br> HF stage, OR<br> Confirmation if fit for GLP-1</td>
                  <td><span class="decision-reject">REJECT</span> if Stage IV<br><br><span class="decision-prescribe">PRESCRIBE</span> if Stage I, II, or III</td>
                </tr>
                <tr>
                  <td><strong> Chronic Kidney Disease (CKD)</strong></td>
                  <td><a href="#macro-5" class="tag blue">Macro 5</a></td>
                  <td><div class="checklist-item">Check SCR for eGFR or CKD stage</div><div class="checklist-item">If eGFR/stage unclear  hold + email</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Request:<br> Most recent eGFR result, OR<br> Latest specialist letter with CKD details</td>
                  <td><span class="decision-reject">REJECT</span> if eGFR &lt;30 or Stage 4/5<br><br><span class="decision-prescribe">PRESCRIBE</span> if eGFR 30 or Stage 1/2/3</td>
                </tr>
              </table>
              </div>
            </div>
          </details>

          <details class="accordion">
            <summary>Conditions requiring patient assessment (Macros 3 / 6 / 7 / 8 / 9 / 10)</summary>
            <div class="accordion-body">
              <div class="protocol-text"><strong>Table 4:</strong> Additional conditions that require gathering information from the patient to determine safety and prescribing decision.</div>
              <div class="table-wrapper">
                <table class="protocol-table">
                <tr><th>Condition</th><th>Macro</th><th>Before Emailing</th><th>Information to Request</th><th>After Patient Response</th></tr>
                <tr>
                  <td><strong> Any Cancer Diagnosis</strong><br><span style="font-size: 0.85em; color: var(--text-muted); font-style: italic;">(excluding MEN2 or medullary thyroid cancer)</span></td>
                  <td><a href="#macro-3" class="tag blue">Macro 3</a></td>
                  <td><div class="checklist-item">Check SCR for cancer type and timeline</div><div class="checklist-item">Always require patient input</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Ask if:<br> Currently under oncology care?<br> Cancer in remission?<br> Request discharge/latest oncology letter</td>
                  <td><span class="decision-reject">REJECT</span> if active cancer/undergoing treatment<br><br><span class="decision-clinical">CLINICAL DECISION</span> if in remission (review oncology letter)</td>
                </tr>
                <tr>
                  <td><strong> Pregnancy</strong></td>
                  <td><a href="#macro-6" class="tag blue">Macro 6</a></td>
                  <td><div class="checklist-item">Always require confirmation</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Ask if currently:<br> Pregnant?<br> Breastfeeding?<br> Trying to conceive?</td>
                  <td><span class="decision-reject">REJECT</span> if pregnant, breastfeeding, or trying to conceive<br><br><span class="decision-prescribe">PRESCRIBE</span> if none of the above</td>
                </tr>
                <tr>
                  <td><strong> Dementia / Cognitive Impairment</strong></td>
                  <td><a href="#macro-7" class="tag blue">Macro 7</a></td>
                  <td><div class="checklist-item">Always require patient/carer input</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Ask:<br> Safe to use medication at home?<br> Support available?<br> Ability to self-administer?</td>
                  <td><span class="decision-clinical">CLINICAL DECISION</span> based on:<br> Patient's ability to take medication safely<br> Support network around patient</td>
                </tr>
                <tr>
                  <td><strong> Chronic Malabsorption</strong></td>
                  <td><a href="#macro-8" class="tag blue">Macro 8</a></td>
                  <td><div class="checklist-item">Always require confirmation</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Ask if patient has formal diagnosis of chronic malabsorption</td>
                  <td><span class="decision-reject">REJECT</span> if formal diagnosis confirmed<br><br><span class="decision-prescribe">PRESCRIBE</span> if no formal diagnosis</td>
                </tr>
                <tr>
                  <td><strong> Depression or Anxiety</strong><br><br><span style="font-size: 0.85em; color: var(--danger); font-weight: 600;"> Contraindication: acutely mentally unwell</span></td>
                  <td><a href="#macro-9" class="tag blue">Macro 9</a></td>
                  <td><div class="checklist-item">Check SCR entry date</div><div class="checklist-item">Check antidepressant start/dose change dates</div><div class="checklist-item">If &lt;3 months  hold + email</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Request confirmation of:<br> When condition added to SCR<br> Any new antidepressants or dose changes in last 3 months</td>
                  <td><span class="decision-reject">REJECT</span> if entry &lt;3 months old OR new antidepressant/dose increase in last 3 months<br><br><span class="decision-prescribe">PRESCRIBE</span> if 3 months</td>
                </tr>
                <tr>
                  <td><strong> Active Suicidal Ideation</strong></td>
                  <td><a href="#macro-9" class="tag blue">Macro 9</a></td>
                  <td><div class="checklist-item">Check SCR entry date</div><div class="checklist-item">If &lt;12 months  hold + email</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Request confirmation of when suicidal ideation was added to SCR</td>
                  <td><span class="decision-reject">REJECT</span> if &lt;12 months<br><br><span class="decision-prescribe">PRESCRIBE</span> if 12 months</td>
                </tr>
                <tr>
                  <td><strong> Current Alcohol Abuse or Dependence</strong></td>
                  <td><a href="#macro-10" class="tag blue">Macro 10</a></td>
                  <td><div class="checklist-item">Check SCR entry date</div><div class="checklist-item">If &lt;12 months or "current"  hold + email</div><div class="checklist-item">Add tag: <span class="tag orange">Pending Customer Response</span></div></td>
                  <td>Request confirmation of:<br> When alcohol abuse was added to SCR<br> Current alcohol use status</td>
                  <td><span class="decision-reject">REJECT</span> if &lt;12 months or current abuse<br><br><span class="decision-prescribe">PRESCRIBE</span> if 12 months and no current abuse</td>
                </tr>
              </table>
              </div>

              <div class="protocol-section-title" style="margin-top: 20px;">Cancer assessment (Macro 3)</div>
              <div class="protocol-text">For any cancer diagnosis (excluding MEN2 or medullary thyroid cancer), ask the patient:</div>
              <ul class="protocol-list">
                <li>Are they under a specialist / currently undergoing treatment from an oncology team?</li>
                <li>Is the cancer in remission? Have they been discharged from oncology?</li>
                <li>Ask for discharge letter / latest oncology letter.</li>
              </ul>
            </div>
          </details>
        </div>

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon purple">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
              </svg>
            </div>
            Escalations (when and how)
          </div>
          <div class="protocol-text"><strong>Escalate when:</strong></div>
          <ul class="protocol-list">
            <li>You gathered further information using macros but are still unsure of the prescribing decision.</li>
            <li>You see SCR information and arent sure if its a contraindication to GLP1s.</li>
            <li>You received an email response but arent sure if it indicates a contraindication.</li>
          </ul>
          <div class="protocol-text"><strong>Actions:</strong></div>
          <ol class="protocol-ol">
            <li>Add a note to the customers account.</li>
            <li>Create a Jira escalation ticket using option SCR query.</li>
            <li>Change tag from prescriber review to escalated.</li>
          </ol>
        </div>

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon red">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18"/>
                <path d="M6 6l12 12"/>
              </svg>
            </div>
            Rejecting prescriptions (especially repeat patients)
          </div>
          <div class="protocol-text">If rejecting a repeat patient after several months of prescribing, use <strong>Macro 12</strong>. If patients reply unhappy, senior pharmacists may call using these principles:</div>
          <ul class="protocol-list">
            <li><strong>Lead with empathy</strong> (I can hear you are frustrated).</li>
            <li><strong>Explain through safety</strong> (protection not restriction).</li>
            <li>Keep it simple, direct, reassuring (not defensive).</li>
            <li>Offer a path forward (signpost GP/alternatives).</li>
            <li>Maintain boundaries calmly; no exceptions if unsafe.</li>
          </ul>
        </div>

        </div>
        <!-- End Tab 3 -->

        <!-- Tab 4: Documentation -->
        <div class="protocol-tab-content" data-tab-content="documentation">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
              </svg>
            </div>
            Documentation  copy-ready examples
          </div>

          <div class="scr-copy-row"><div class="scr-copy-title">SCR pass (scraping tool)</div><button class="btn btn-secondary copy-btn" data-copy-target="scr-doc-pass">Copy</button></div>
          <pre id="scr-doc-pass" class="macro-box">SCR pass - no contraindications to GLP1s\n\nPatient ID and Weight verification photo reviewed, eligible for medication according to information provided and no contraindications flagged by scrapping tool. Prescription issued.</pre>

          <div class="scr-copy-row"><div class="scr-copy-title">Flagged, then clear on SCR</div><button class="btn btn-secondary copy-btn" data-copy-target="scr-doc-clear">Copy</button></div>
          <pre id="scr-doc-clear" class="macro-box">SCR checked - no contraindications to GLP1s\n\nPatient ID and Weight verification photo reviewed, eligible for medication according to information provided and no contraindications found on SCR consultation. Prescription issued.</pre>

          <div class="scr-copy-row"><div class="scr-copy-title">Absolute contraindication</div><button class="btn btn-secondary copy-btn" data-copy-target="scr-doc-abs">Copy</button></div>
          <pre id="scr-doc-abs" class="macro-box">SCR checked [reason for contra-indication] [date noted in SCR]\n\nPatient ID and Weight verification photo reviewed, not eligible for medication according to information found on SCR consultation. Contraindication found - [e.g. history of pancreatitis].</pre>

          <div class="scr-copy-row"><div class="scr-copy-title">Further information needed</div><button class="btn btn-secondary copy-btn" data-copy-target="scr-doc-more">Copy</button></div>
          <pre id="scr-doc-more" class="macro-box">SCR checked - further information needed - email sent [add zendesk link]\n\nTag changed from prescriber review to awaiting customer response.</pre>

          <div class="scr-copy-row"><div class="scr-copy-title">SCR unavailable / limited</div><button class="btn btn-secondary copy-btn" data-copy-target="scr-doc-unavail">Copy</button></div>
          <pre id="scr-doc-unavail" class="macro-box">SCR unavailable\n\nProceed according to standard prescription SOP. No hold/email purely for missing SCR.</pre>
          <pre class="macro-box" style="margin-top: 10px;">SCR checked but limited - no contraindications to GLP1 found\n\nProceed according to standard prescription SOP. Hold only if specific information is required about a condition/medication.</pre>
        </div>

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon orange">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l9 4v6c0 5-3.8 9.7-9 10-5.2-.3-9-5-9-10V6l9-4z"/>
              </svg>
            </div>
            Email templates (Macros)
          </div>
          <div class="protocol-text">Use these when additional information is required or when permission/rejection messaging is needed.</div>
          ${this.getSCRMacroAccordions()}
        </div>

        </div>
        <!-- End Tab 4 -->

      </div>
    `;
  },

  getSCRMacroAccordions() {
    return `
      <details class="accordion">
        <summary>Macro 1  Request for further information (timing/details)</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 1</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-1">Copy</button></div>
          <pre id="macro-1" class="macro-box">Subject: Request for Further Information About Your Medical History\n\nDear [Patients Name],\n\nI can see from your records that you have had [X condition listed on Table 2]. Could you please provide us with a bit more information about when this occurred and any relevant details you feel may be important?\n\nYour response will help us ensure that we have an accurate and up-to-date understanding of your medical history when reviewing your request.\n\nThank you for your time, and please let us know if you have any questions.\n\nKind regards,\n[Your Name]\n[Your Role]\n[Organisation Name]</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 2  Previous gallbladder problems</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 2</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-2">Copy</button></div>
          <pre id="macro-2" class="macro-box">Subject: Follow-Up on Your Medical History\n\nDear [Patient Name],\n\nFrom your records, I can see you have had a gallbladder problem noted. Could you please confirm if you have had a cholecystectomy (gallbladder removal surgery) following this, and if so, when the surgery took place?\n\nThis information will help us ensure your medical history is accurate and up to date.\n\nKind regards,\n[Your Name]\n[Your Role]\n[Organisation Name]</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 3  Previous cancer diagnosis</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 3</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-3">Copy</button></div>
          <pre id="macro-3" class="macro-box">Subject: Follow-Up on Your Medical History\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nWe would be grateful if you could provide us with some further details about your medical history:\n Have you ever had a cancer diagnosis (excluding MEN2 or medullary thyroid cancer)? Are you currently on, or awaiting, any treatment such as surgery, chemotherapy, or radiotherapy?\n Is the cancer in remission?\n Have you been discharged from the oncology team? If so, please send a copy of your discharge letter or your most recent letter from the Oncology team.\n\nThank you for choosing MedExpress to support you on your weight loss journey. Your response will help us make sure we have an accurate and up-to-date understanding of your medical history.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 4  Heart failure information</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 4</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-4">Copy</button></div>
          <pre id="macro-4" class="macro-box">Subject: Request for Information on Heart Failure Diagnosis\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nWe can see a coded diagnosis of heart failure in your records. To ensure we have the most accurate and up-to-date information about your condition, could you please provide us with:\n A copy of your most recent cardiology letter, or\n Any additional details regarding your diagnosis that you feel are relevant.\n\nThank you for choosing MedExpress to support you on your weight loss journey. Your response will help us provide the best possible care.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 5  CKD diagnosis</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 5</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-5">Copy</button></div>
          <pre id="macro-5" class="macro-box">Subject: Request for Information on CKD Diagnosis\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nWe can see a diagnosis of chronic kidney disease (CKD) noted in your records. To ensure we have the most accurate and up-to-date information about your condition, could you please provide us with:\n Your most recent eGFR result, and/or\n A copy of the latest letter from your specialist with further details about your CKD.\n\nThank you for choosing MedExpress to support you on your weight loss journey. Your response will help us provide the best possible care.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 6  Pregnancy</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 6</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-6">Copy</button></div>
          <pre id="macro-6" class="macro-box">Subject: Follow-Up on Your Current Status\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nTo help us provide the most appropriate care, could you please confirm your current status regarding the following:\n Are you currently pregnant?\n Are you breastfeeding?\n Are you trying to conceive?\n\nYour response will ensure we have accurate and up-to-date information for your care.\nThank you for choosing MedExpress to support you on your weight loss journey.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 7  Dementia</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 7</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-7">Copy</button></div>
          <pre id="macro-7" class="macro-box">Subject: Follow-Up on Your Care and Support\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nWe can see that dementia is noted in your records. To help us understand your needs and provide the best support, could you please let us know:\n How you manage at home on a day-to-day basis?\n Whether you have any help or support at home?\n\nThank you for choosing MedExpress to support you on your weight loss journey. Your response will help us ensure we have the most accurate and up-to-date information.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 8  Chronic malabsorption</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 8</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-8">Copy</button></div>
          <pre id="macro-8" class="macro-box">Subject: Request for Information on Chronic Malabsorption\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nWe can see a note of chronic malabsorption in your records. To ensure we have accurate and up-to-date information about your condition, could you please provide us with:\n Evidence of a formal diagnosis, or\n A letter from your specialist with further details regarding your condition.\n\nThank you for choosing MedExpress to support you on your weight loss journey. Your response will help us provide the best possible care.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 9  Mental health</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 9</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-9">Copy</button></div>
          <pre id="macro-9" class="macro-box">Subject: Follow-Up on Your Mental Health\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nWe can see depression or anxiety noted in your records. To help us provide the best care and support, could you please provide some information regarding:\n How your mood has been recently.\n Whether your mood has changed in the past few weeks or months.\n If you have had any thoughts of self-harm.\n If you have had any thoughts of ending your life.\n\nIf you are currently experiencing thoughts of self-harm or ending your life, please contact your GP or local crisis services immediately. In the UK, you can also contact Samaritans on 116 123.\n\nThank you for choosing MedExpress to support you on your weight loss journey. Your response will help us ensure we have the most accurate and up-to-date information.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 10  Alcohol abuse</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 10</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-10">Copy</button></div>
          <pre id="macro-10" class="macro-box">Subject: Follow-Up on Alcohol Use\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nWe can see alcohol abuse or dependence noted in your records. To help us understand your situation and provide the best support, could you please provide some information regarding:\n How much you are currently drinking.\n Whether you have ever felt that you ought to cut down on your drinking.\n Whether you get annoyed by criticism of your drinking.\n Whether you ever feel guilty about your drinking.\n Whether you ever take an early-morning drink (eye-opener) to get the day started or to relieve a hangover.\n\nThank you for choosing MedExpress to support you on your weight loss journey. Your response will help us ensure we have the most accurate and up-to-date information.\n\nKind regards,\n&lt;&lt;Your Name&gt;&gt;\n&lt;&lt;Your Role&gt;&gt;\n&lt;&lt;Organisation Name&gt;&gt;</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 11  Patient has not granted permission to view SCR</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 11</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-11">Copy</button></div>
          <pre id="macro-11" class="macro-box">Email Subject: Update Regarding Access to Summary Care Records (SCR)\n\nDear &lt;&lt;Patient Name&gt;&gt;,\n\nThank you for your recent order.\n\nWe wanted to let you know about an important change to our prescribing process. Unfortunately, we are now unable to prescribe medication if access to the Summary Care Record (SCR) is declined. Access to the SCR is essential to ensure that we prescribe safely and in accordance with clinical guidance.\n\nIt appears that you have not granted us access to your SCR. If you would like to review this decision or have any questions about what the SCR is, we would be happy to provide more information.\n\nIf you wish to change your mind and allow us access to your SCR, we would be happy to move forward with your prescription. However, if you choose not to grant access, we will need to reject your prescription request, and you will receive a full refund.\n\nPlease let us know how you would like to proceed.\n\nKind regards,\nMedExpress Clinical Team\n\n---\nIf patient grants permission: document permission obtained over email + add Zendesk link, then proceed to check SCR on NHS site.\nIf patient does not grant permission: reject the order.</pre>
        </div>
      </details>

      <details class="accordion">
        <summary>Macro 12  Rejection email for repeat patients</summary>
        <div class="accordion-body">
          <div class="scr-copy-row"><div class="scr-copy-title">Macro 12</div><button class="btn btn-secondary copy-btn" data-copy-target="macro-12">Copy</button></div>
          <pre id="macro-12" class="macro-box">Email Subject: An important update on your treatment plan\n\nHi &lt;&lt;Patient Name&gt;&gt;,\n\nWere getting in touch to let you know that, following an updated review of your medical records, were no longer able to prescribe weight loss treatments such as Wegovy, Mounjaro or Nevolat.\nThis means your current order will be automatically cancelled and refunded.\n\nThis decision is based on new information from your Summary Care Record (SCR), which is a national database that includes details like your current medication, allergies, any diagnoses or medical conditions and previous reactions to medicines. Reviewing your SCR is a new step weve introduced to further improve the safety of our service.\n\nDuring these checks, we noted [add information about contraindication(s) found].\n\nFor your safety, please stop using your injectable treatment and take any remaining pens to your local pharmacy for safe disposal.\n\nWe understand this news may be disappointing, but your safety is our top priority. If youd like to speak with one of our clinicians about this update, just reply to this email. Well get back to you as soon as possible.\n\nYou can also discuss your weight management options with your GP for more personalised support.\n\nKind regards,\nMedExpress Clinical Team</pre>
        </div>
      </details>
    `;
  },

  getCoreProtocolCards() {
    return `
      <!-- Core Checks Tabs -->
      <div class="protocol-tabs">
        <button class="protocol-tab active" data-tab="consultation">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
          </svg>
          Consultation Review
        </button>
        <button class="protocol-tab" data-tab="identity">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="16" rx="2"/>
            <circle cx="15" cy="10" r="2"/>
          </svg>
          Identity & Age
        </button>
        <button class="protocol-tab" data-tab="biometric">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v18M3 12h18"/>
            <circle cx="12" cy="12" r="9"/>
          </svg>
          BMI & Photo
        </button>
        <button class="protocol-tab" data-tab="gp">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
            <path d="M9 22V12h6v10"/>
          </svg>
          GP Details
        </button>
      </div>

      <!-- Tab 1: Consultation Review -->
      <div class="protocol-tab-content active" data-tab-content="consultation">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
            </svg>
          </div>
          Consultation Answers
        </div>
        <div class="protocol-text">
          <strong>What to check:</strong> Read all consultation answers and check patient notes for any email updates from the patient.
        </div>
        <div class="protocol-text">
          Transfer patients are asked about <strong>hospitalisation due to side effects</strong>. If they confirm hospitalisation, <strong>reject the order</strong>.
        </div>
        <div class="protocol-section" style="margin-top: 16px;">
          <div class="protocol-section-title">If Further Information Required</div>
          <div class="protocol-text">
            Add tag <span class="tag orange">Pending Customer Response</span> and email the patient using appropriate macro.
          </div>
        </div>
      </div>

      </div>
      <!-- End Tab 1 -->

      <!-- Tab 2: Identity & Age -->
      <div class="protocol-tab-content" data-tab-content="identity">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="16" rx="2"/>
              <circle cx="15" cy="10" r="2"/>
            </svg>
          </div>
          ID Verification
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Requirements for Valid ID</div>
          <ul class="protocol-list">
            <li><strong>Full name, DoB, and photo</strong> must be visible and match account</li>
            <li>Must be from <strong>official governmental organisation</strong> (UK or overseas acceptable)</li>
            <li>Pass Cards and other formal ID may be accepted</li>
            <li><strong>First orders:</strong> ID must be in date</li>
            <li><strong>Repeat orders:</strong> Expired ID is acceptable</li>
          </ul>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">If ID Fails (New Patient)</div>
          <div class="protocol-text">
            Add <span class="tag red">Failed ID</span> tag (triggers auto email in 5 minutes). Remove <span class="tag blue">Prescriber Review</span> tag.
          </div>
          <div class="info-card red" style="margin-top: 12px;">
            <div class="info-card-title">Important</div>
            <div class="info-card-text">
              <strong>Don't use Failed ID tag more than once.</strong> If already used, send personalised email and add <span class="tag orange">Pending Customer Response</span> instead.
            </div>
          </div>
        </div>
      </div>

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
          </div>
          Age Verification
        </div>
        <div class="protocol-text">
          Patient must be <strong>1874 years old (inclusive)</strong>.
        </div>
        <div class="protocol-text">
          If outside this range, reject with code <strong>"Clinically Unsuitable"</strong>. No escalation needed for age rejections, even if prescriber is in probation period.
        </div>
      </div>

      </div>
      <!-- End Tab 2 -->

      <!-- Tab 3: BMI & Photo -->
      <div class="protocol-tab-content" data-tab-content="biometric">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 3v18M3 12h18"/>
              <circle cx="12" cy="12" r="9"/>
            </svg>
          </div>
          BMI Requirements
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Starting Treatment (New Patients)</div>
          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Patient Type</th>
                <th>Minimum BMI</th>
                <th>Maximum BMI</th>
              </tr>
              <tr>
                <td><strong>Without comorbidities</strong></td>
                <td>30 kg/m</td>
                <td rowspan="3">60 kg/m</td>
              </tr>
              <tr>
                <td><strong>With comorbidities</strong> (prediabetes, diabetes, heart disease, high BP, high cholesterol, sleep apnoea)</td>
                <td>27 kg/m</td>
              </tr>
              <tr>
                <td><strong>BAME patients</strong></td>
                <td>27.5 kg/m</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Repeat Patients (Minimum BMI 21)</div>
          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Gap Since Last Order</th>
                <th>Minimum BMI</th>
              </tr>
              <tr>
                <td>&lt;6 months gap</td>
                <td><strong>21 kg/m</strong></td>
              </tr>
              <tr>
                <td>612 months gap</td>
                <td><strong>25 kg/m</strong></td>
              </tr>
              <tr>
                <td>&gt;12 months gap</td>
                <td><strong>Must meet licence threshold</strong> (27-30 kg/m)</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="info-card green" style="margin-top: 16px;">
          <div class="info-card-title">If Unsure About Patient's BMI</div>
          <div class="info-card-text">
            <strong>Escalate the order.</strong> Add <span class="tag purple">escalated</span> tag and remove <span class="tag blue">Prescriber Review</span> tag.
          </div>
        </div>
      </div>

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="M21 15l-5-5L5 21"/>
            </svg>
          </div>
          Photo Verification
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Photo Must Show</div>
          <ul class="protocol-list">
            <li>Patient alone, <strong>full-length</strong> view, face clearly visible</li>
            <li>No sunglasses or phone covering face</li>
            <li><strong>Fitted clothing</strong> (may accept loose if BMI still validatable)</li>
            <li>Same person as appears in ID photo</li>
          </ul>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">If Photo Fails (New Patient)</div>
          <div class="protocol-text">
            Add <span class="tag red">Weight verification failed</span> tag (triggers auto email in 5 minutes).
          </div>
          <div class="protocol-text">
            If tag already used, send personalised email and add <span class="tag orange">Pending Customer Response</span>.
          </div>
        </div>
        <div class="info-card red" style="margin-top: 12px;">
          <div class="info-card-title"> Inappropriate Photos</div>
          <div class="info-card-text">
            If genitalia is exposed in photo: place order on hold and ask Customer Service to delete the photo. <strong>Never prescribe based on a nude photo.</strong>
          </div>
        </div>
      </div>

      </div>
      <!-- End Tab 3 -->

      <!-- Tab 4: GP Details -->
      <div class="protocol-tab-content" data-tab-content="gp">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
              <path d="M9 22V12h6v10"/>
            </svg>
          </div>
          GP Details
        </div>
        <div class="protocol-text">
          Patient must be registered with a <strong>UK NHS surgery</strong>.
        </div>
        <div class="protocol-text">
          <strong>Green tick</strong> = GP details have been verified by the system. If no tick is shown, validate the GP practice via Google search or NHS ODS Portal.
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">If GP Cannot Be Validated</div>
          <div class="protocol-text">
            Add <span class="tag orange">Incomplete GP details</span> tag (triggers automatic email to patient).
          </div>
        </div>
        <div class="info-card red" style="margin-top: 12px;">
          <div class="info-card-title">GP Outside UK</div>
          <div class="info-card-text">
            Email patient requesting UK GP details. If patient is unable to provide a UK GP, <strong>reject the order</strong>.
          </div>
        </div>
      </div>

      </div>
      <!-- End Tab 4 -->

    `;
  },

  getPUEProtocolCards() {
    return `
      <!-- PUE Tabs -->
      <div class="protocol-tabs">
        <button class="protocol-tab active" data-tab="requirements">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
            <path d="M14 2v6h6"/>
          </svg>
          PUE Requirements
        </button>
        <button class="protocol-tab" data-tab="below-licence">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
          </svg>
          Below-Licence BMI
        </button>
        <button class="protocol-tab" data-tab="failures">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          PUE Failures
        </button>
        <button class="protocol-tab" data-tab="timing">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          Timing Issues
        </button>
      </div>

      <!-- Tab 1: PUE Requirements -->
      <div class="protocol-tab-content active" data-tab-content="requirements">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <path d="M14 2v6h6"/>
            </svg>
          </div>
          When PUE is Required
        </div>
        <div class="protocol-text">
          <strong>Previous Use Evidence (PUE)</strong> is required in the following scenarios:
        </div>
        <ul class="protocol-list">
          <li><strong>Transfer patients</strong>  New to MedExpress but has previously used GLP-1 with another provider</li>
          <li><strong>Skipped doses</strong>  System shows "GLP1 product is X step(s) lower/higher than previous order"</li>
          <li><strong>Step-up or maintenance dose requests</strong> from patients who are new to MedExpress</li>
        </ul>
      </div>

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
            </svg>
          </div>
          What PUE Must Show
        </div>
        <div class="protocol-text">
          Valid Previous Use Evidence must include <strong>all four</strong> of the following:
        </div>
        <div class="table-wrapper">
          <table class="dose-table">
            <tr>
              <th>Requirement</th>
              <th>Details</th>
            </tr>
            <tr>
              <td><strong>1. Patient Name/Email</strong></td>
              <td>Full name (not nickname) OR patient's email address</td>
            </tr>
            <tr>
              <td><strong>2. Medication & Dose</strong></td>
              <td>Specific medication name and dosage prescribed</td>
            </tr>
            <tr>
              <td><strong>3. Date</strong></td>
              <td>Order date, prescription date, OR dispatch date</td>
            </tr>
            <tr>
              <td><strong>4. From Regulated Body</strong></td>
              <td>Must be from a legitimate healthcare provider/pharmacy</td>
            </tr>
          </table>
        </div>
        <div class="info-card red" style="margin-top: 16px;">
          <div class="info-card-title"> Order Confirmation is NOT Acceptable</div>
          <div class="info-card-text">
            PUE must be a <strong>dispatch notification, prescription, or dispensing label</strong>. Simple order confirmations do not qualify. Evidence may be provided over multiple screenshots.
          </div>
        </div>
      </div>
      </div>

      <!-- Tab 2: Below-Licence BMI -->
      <div class="protocol-tab-content" data-tab-content="below-licence">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </div>
          Below-Licence BMI Requirements
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">For Patients with BMI Below Licence</div>
          <div class="protocol-text">
            <strong>Cannot proceed without BOTH PUE AND previous BMI photo.</strong>
          </div>
          <div class="protocol-text">
            If either PUE or previous BMI photo fails requirements, patient is not eligible. Use email template <em>Clinical: Evidence of starting BMI</em>.
          </div>
        </div>
        <div class="divider"></div>
        <div class="protocol-section">
          <div class="protocol-section-title">If Previous BMI Photo Fails</div>
          <div class="protocol-text">
            Add <span class="tag purple">previous BMI verification failed</span> tag and remove <span class="tag blue">prescriber review</span> tag.
          </div>
          <div class="protocol-text">
            Send manual email explaining why the photo doesn't meet requirements.
          </div>
          <div class="info-card" style="margin-top: 12px;">
            <div class="info-card-title">Important Tag Note</div>
            <div class="info-card-text">
              <strong>DO NOT use "Weight verification failed" tag</strong> for previous BMI photos. That tag is only for current weight verification photos.
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- Tab 3: PUE Failures -->
      <div class="protocol-tab-content" data-tab-content="failures">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon red">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
          </div>
          If PUE Doesn't Meet Requirements
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">For Patients with BMI Above Licence</div>
          <div class="protocol-text">
            If PUE cannot be provided, the dose can be <strong>amended to starter dose</strong> by Customer Care team.
          </div>
          <div class="protocol-text">
            Message <strong>ME-Clinical-Communication</strong> Slack channel to request dose amendment.
          </div>
        </div>
        <div class="divider"></div>
        <div class="protocol-section">
          <div class="protocol-section-title">For Patients with BMI Below Licence</div>
          <div class="protocol-text">
            <strong>Cannot proceed without BOTH PUE AND previous BMI photo.</strong>
          </div>
          <div class="protocol-text">
            If either PUE or previous BMI photo fails requirements, patient is not eligible. Use email template <em>Clinical: Evidence of starting BMI</em>.
          </div>
        </div>
      </div>
      </div>

      <!-- Tab 4: Timing Issues -->
      <div class="protocol-tab-content" data-tab-content="timing">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
          </div>
          PUE Less Than 2 Weeks Old
        </div>
        <div class="protocol-text">
          <strong>Action required:</strong> Check the order date on patient's Previous Use Evidence.
        </div>
        <div class="protocol-text">
          If their last order with the previous provider was <strong>less than 2 weeks ago</strong> from their MedExpress order date:
        </div>
        <ul class="protocol-list">
          <li><strong>Prescribe the order</strong> as normal</li>
          <li>Send email using template: <em>Clinical: PUE &lt;2 Weeks Old</em></li>
          <li>Email reminds them to complete their current treatment before starting the MedExpress pen</li>
        </ul>
      </div>
      </div>
    `;
  },

  getTitrationProtocolCards() {
    return `
      <!-- Titration Tabs -->
      <div class="protocol-tabs">
        <button class="protocol-tab active" data-tab="schedules">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20V10M18 20V4M6 20v-4"/>
          </svg>
          Titration Schedules
        </button>
        <button class="protocol-tab" data-tab="skipped">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
          </svg>
          Skipped Doses
        </button>
        <button class="protocol-tab" data-tab="gaps">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          Treatment Gaps
        </button>
        <button class="protocol-tab" data-tab="additional">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
          Additional Pens
        </button>
      </div>

      <!-- Tab 1: Titration Schedules -->
      <div class="protocol-tab-content active" data-tab-content="schedules">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20V10M18 20V4M6 20v-4"/>
            </svg>
          </div>
          Correct Titration
        </div>
        <div class="protocol-text">
          <strong>For patients on 2nd+ order:</strong> Check that patients are titrating up doses as expected.
        </div>
        <div class="protocol-text">
          Titration schedules differ by medication:
        </div>
        <div class="table-wrapper">
          <table class="dose-table">
            <tr>
              <th>Medication</th>
              <th>Titration Schedule</th>
            </tr>
            <tr>
              <td><strong>Mounjaro & Wegovy</strong></td>
              <td>Titrate up <strong>each month</strong></td>
            </tr>
            <tr>
              <td><strong>Nevolat</strong></td>
              <td><strong>Weekly titration</strong>, 0.6mg increments, maximum 3mg</td>
            </tr>
          </table>
        </div>
        <div class="info-card blue" style="margin-top: 16px;">
          <div class="info-card-title">Nevolat Pen Label Instruction</div>
          <div class="info-card-text">
            "Inject once daily under the skin at the same time each day. If switching from another weight loss medication, check your email for dosage instructions."
          </div>
        </div>
      </div>
      </div>

      <!-- Tab 2: Skipped Doses -->
      <div class="protocol-tab-content" data-tab-content="skipped">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            </svg>
          </div>
          Customer Skips a Dose
        </div>
        <div class="protocol-text">
          If patient skips a dose in the titration sequence, use email template: <em>Clinical: Evidence request - Skipped Dose (GLP1)</em>
        </div>
        <div class="protocol-text">
          Patient has <strong>two options</strong>:
        </div>
        <ul class="protocol-list">
          <li><strong>Option 1:</strong> We amend their order to the correct dose per titration guide</li>
          <li><strong>Option 2:</strong> Patient provides evidence they received the missing dose from an alternative provider</li>
        </ul>
        <div class="protocol-text">
          Tag order with <span class="tag orange">Pending Customer Response</span> and wait for patient reply.
        </div>
      </div>

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
          </div>
          Patient Stays Same or Goes Down
        </div>
        <div class="protocol-text">
          If patient stays on same dose or reduces strength: <strong>Prescribe first, then contact afterwards</strong> using template <em>Clinical: Did not titrate up / Went down in strength (GLP1)</em>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Justifiable Reasons (No Need to Re-send Macro)</div>
          <ul class="protocol-list">
            <li>Seeing positive weight loss results at lower dose</li>
            <li>Side effects are minimal and manageable at current dose</li>
            <li>Struggling to afford the increased price of higher doses</li>
          </ul>
        </div>
      </div>
      </div>

      <!-- Tab 3: Treatment Gaps -->
      <div class="protocol-tab-content" data-tab-content="gaps">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon red">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
          </div>
          Gap in Treatment Protocol
        </div>
        <div class="protocol-text">
          Orders with <strong>&gt;8 week gap</strong> automatically receive <span class="tag orange">Long treatment gap</span> tag.
        </div>
        <div class="protocol-text">
          <strong>How to use this table:</strong> Find the gap length since patient's last dose in the left column, then see the maximum dose they can restart on in the right columns.
        </div>
        <div class="table-wrapper">
          <table class="dose-table">
            <tr>
              <th>Gap Length</th>
              <th>Action Required</th>
              <th>Max Restart Dose</th>
            </tr>
            <tr>
              <td><strong>8 weeks</strong></td>
              <td>May titrate up to next dose level</td>
              <td>N/A (normal progression)</td>
            </tr>
            <tr>
              <td><strong>&gt;8 to 12 weeks</strong></td>
              <td>Continue last tolerated dose, up to maximum shown</td>
              <td>
                Wegovy 1mg<br>
                Mounjaro 10mg<br>
                Nevolat 1.8mg
              </td>
            </tr>
            <tr>
              <td><strong>&gt;12 to 24 weeks</strong></td>
              <td>Restart one dose lower than last tolerated</td>
              <td>
                Wegovy 1mg<br>
                Mounjaro 5mg<br>
                Nevolat 1.2mg
              </td>
            </tr>
            <tr>
              <td><strong>&gt;24 weeks</strong></td>
              <td>Restart at lowest dose (if BMI 25)</td>
              <td>
                Wegovy 0.25mg<br>
                Mounjaro 2.5mg<br>
                Nevolat 0.6mg
              </td>
            </tr>
            <tr>
              <td><strong>&gt;12 months</strong></td>
              <td>Restart at lowest dose, must meet new patient criteria</td>
              <td>Starter doses only</td>
            </tr>
          </table>
        </div>
        <div class="protocol-section" style="margin-top: 16px;">
          <div class="protocol-section-title">If Dose Doesn't Meet Gap Criteria</div>
          <div class="protocol-text">
            Patient can either:
          </div>
          <ul class="protocol-list">
            <li>Provide PUE from alternative provider during the gap period, OR</li>
            <li>Consent for us to amend their order to appropriate dose</li>
          </ul>
          <div class="protocol-text">
            Use email template <em>Clinical: Gap in treatment (GLP1)</em> and add <span class="tag orange">Pending Customer Response</span> tag.
          </div>
        </div>
      </div>
      </div>

      <!-- Tab 4: Additional Pens -->
      <div class="protocol-tab-content" data-tab-content="additional">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
          </div>
          Requesting Additional Pens
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Travel Allowance</div>
          <ul class="protocol-list">
            <li><strong>Dose escalation patients:</strong> Maximum 2 extra pens (8 doses total) if going on holiday</li>
            <li><strong>Maintenance dose patients:</strong> Maximum 3 extra pens (12 doses total) if going on holiday</li>
          </ul>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Bundles for BMI 21-25 Patients</div>
          <div class="protocol-text">
            Patients may order 2-3 pens of the same dose. Next order can be placed <strong>2 weeks before pens run out</strong> (e.g., 3-pen bundle = 12 weeks supply, can reorder at week 10).
          </div>
        </div>
        <div class="info-card red" style="margin-top: 12px;">
          <div class="info-card-title">Stock Issues</div>
          <div class="info-card-text">
            DO NOT give multiple doses to match an equivalent (e.g., 25mg instead of 10mg). Redirect patient to stay on same dose until their next dose comes back in stock.
          </div>
        </div>
      </div>
      </div>
    `;
  },

  getWeightProtocolCards() {
    return `
      <!-- Weight Monitoring Tabs -->
      <div class="protocol-tabs">
        <button class="protocol-tab active" data-tab="weight-gain">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19V5M5 12l7-7 7 7"/>
          </svg>
          Weight Gain >7%
        </button>
        <button class="protocol-tab" data-tab="weight-loss">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12l7 7 7-7"/>
          </svg>
          Weight Loss >10%
        </button>
      </div>

      <!-- Tab 1: Weight Gain -->
      <div class="protocol-tab-content active" data-tab-content="weight-gain">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 19V5M5 12l7-7 7 7"/>
            </svg>
          </div>
          Weight Gain Over 7%
        </div>
        <div class="protocol-text">
          <strong>What to check:</strong> Verify that weight gain hasn't exceeded 7% on 2 consecutive orders (outside of 6 month review period).
        </div>
        <div class="protocol-text">
          The email macro <em>MedExpress Order (Action required) - >7% Weight Gain</em> will be automatically sent by the first prescriber who reviews the patient's repeat order.
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">System Tags Explained</div>
          <ul class="protocol-list">
            <li><span class="tag orange">Patient gained weight between orders</span>  <strong>First instance</strong> of &gt;7% weight gain. No action required from prescriber. Order falls into Simple Repeats queue.</li>
            <li><span class="tag red">Patient has two consecutive weight gains</span>  <strong>Second consecutive instance</strong>. Falls into Complex Repeats queue. Order placed on hold until patient responds.</li>
          </ul>
        </div>
      </div>

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
            </svg>
          </div>
          &gt;7% Weight Gain  Tailored Response Guide
        </div>
        <div class="protocol-text">
          <strong>How to use this table:</strong> Review patient's answers to the weight gain questionnaire. Use this table to determine appropriate action based on their responses.
        </div>
        <div class="table-wrapper">
          <table class="dose-table">
            <tr>
              <th style="width: 25%;">Question</th>
              <th style="width: 35%;">When to Approve</th>
              <th style="width: 40%;">Additional Actions / Guidance</th>
            </tr>
          <tr>
            <td><strong>Difficulties injecting?</strong></td>
            <td>Approve if <strong>minor pain</strong> at injection site</td>
            <td>Send <em>Minor SEs - Injection Site Reaction</em> macro with guidance on proper injection technique (ice pack before injection, antihistamine cream)</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Reconsider</strong> if severe pain/swelling</td>
            <td>Refer to GLP1 Knowledge Base. If unsure  escalate via Jira</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Stop treatment</strong> if allergic reaction</td>
            <td>Advise patient to stop injecting and seek medical attention via 111</td>
          </tr>
          <tr>
            <td><strong>How often are you injecting?</strong></td>
            <td>Approve if <strong>occasionally forgetting</strong> doses</td>
            <td>Reinforce importance of maintaining schedule. Suggest setting reminders/alarms on phone</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Hold order</strong> if missed multiple doses or stopped due to side effects</td>
            <td>Consider: (i) lowering dose, or (ii) ceasing medication entirely. If unsure  escalate via Jira</td>
          </tr>
          <tr>
            <td><strong>How is your appetite?</strong></td>
            <td>Approve <strong>regardless of response</strong></td>
            <td>Offer advice on managing hunger: more fibre and protein. Reassure that appetite suppression improves as dose increases</td>
          </tr>
          <tr>
            <td><strong>Exercise routine?</strong></td>
            <td>Approve</td>
            <td>If lack of exercise  encourage physical activity, starting with walking or light home workouts</td>
          </tr>
          <tr>
            <td><strong>Side effects?</strong></td>
            <td>Approve if <strong>mild</strong> side effects (nausea, dizziness)</td>
            <td>Use Side Effects Macros available on prescribing interface and ZenDesk</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Pause treatment</strong> if severe side effects</td>
            <td>Submit PSI via Jira  "Clinically significant Side Effects". Also submit Yellow Card report</td>
          </tr>
          <tr>
            <td><strong>Medical condition or medication changes?</strong></td>
            <td>Approve if new medication has <strong>no known GLP-1 interactions</strong></td>
            <td>Use GLP1 Knowledge Base to check. If condition shows "Reject now"  reject immediately</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Escalate</strong> if condition not in Knowledge Base</td>
            <td>Escalate via Jira if unsure after consulting SOP and Knowledge Base</td>
          </tr>
          <tr>
            <td><strong>Anything else contributing to weight gain?</strong></td>
            <td>Approve</td>
            <td>If stress/holidays/routine changes  provide reassurance. If mental health concerns  consult GLP1 Knowledge Base</td>
          </tr>
        </table>
        <div class="info-card red" style="margin-top: 16px;">
          <div class="info-card-title"> Escalate Immediately When</div>
          <div class="info-card-text">
            Severe pain/swelling at injection site | New medication or diagnosis | Deviating from injection schedule (multiple doses at once, micro-dosing, injecting more/less than once weekly)
          </div>
        </div>
      </div>
      </div>

      <!-- Tab 2: Weight Loss -->
      <div class="protocol-tab-content" data-tab-content="weight-loss">
      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon red">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12l7 7 7-7"/>
            </svg>
          </div>
          Weight Loss Exceeding Threshold
        </div>
        <div class="protocol-text">
          <strong>What to check:</strong> Verify that weight loss since last order doesn't exceed the threshold (outside of 6 month review period).
        </div>
        <div class="protocol-text">
          Email macro <em>MedExpress Order (Action required) - >10% Weight Loss</em> will be sent by the first prescriber who reviews the order.
        </div>
        <div class="protocol-text">
          <strong>How to use this table:</strong> Check order type against maximum allowed weight loss. System automatically adds tag when threshold exceeded.
        </div>
        <div class="table-wrapper">
          <table class="dose-table">
            <tr>
              <th>Order Type</th>
              <th>Maximum Weight Loss Allowed</th>
            </tr>
            <tr>
              <td>Single pen order</td>
              <td><strong>10%</strong></td>
            </tr>
            <tr>
              <td>2 pen bundle</td>
              <td><strong>15%</strong></td>
            </tr>
            <tr>
              <td>3 pen bundle</td>
              <td><strong>20%</strong></td>
            </tr>
          </table>
        </div>
        <div class="protocol-text">
          System adds <span class="tag red">Weight loss between orders exceeds threshold</span> tag. Order is placed on hold until patient responds.
        </div>
      </div>

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
            </svg>
          </div>
          &gt;10% Weight Loss  Tailored Response Guide
        </div>
        <div class="protocol-text">
          <strong>How to use this table:</strong> Review patient's answers to the weight loss questionnaire and follow guidance below for each response.
        </div>
        <div class="table-wrapper">
          <table class="dose-table">
            <tr>
              <th style="width: 30%;">Question</th>
              <th style="width: 35%;">When to Approve</th>
              <th style="width: 35%;">Additional Actions / Guidance</th>
            </tr>
          <tr>
            <td><strong>Side effects? (nausea, vomiting, diarrhoea)</strong></td>
            <td>Approve if <strong>mild</strong> side effects</td>
            <td>Mild SEs are common with GLP-1s. Use Side Effects Macros available on interface</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Raise PSI</strong> if severe side effects</td>
            <td>Submit PSI via Jira  "Clinically significant Side Effects". Submit Yellow Card report</td>
          </tr>
          <tr>
            <td><strong>Medical condition or medication changes?</strong></td>
            <td>Approve if new medication has <strong>no known GLP-1 interactions</strong></td>
            <td>Use GLP1 Knowledge Base. If "Reject now" advice shown  reject immediately</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Escalate</strong> if condition not covered in Knowledge Base</td>
            <td>Escalate via Jira if unsure after checking SOP and Knowledge Base</td>
          </tr>
          <tr>
            <td><strong>Injection frequency & consistency?</strong></td>
            <td>Approve if <strong>occasionally forgetting</strong> doses</td>
            <td>Reinforce importance of consistent schedule. Suggest setting reminders/alarms</td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Hold order</strong> if used multiple doses at same time</td>
            <td>Email with relevant macro. Escalate via Jira. Senior Prescriber decides if PSI required</td>
          </tr>
          <tr>
            <td><strong>Eating recommended daily protein?</strong></td>
            <td>Approve if eating recommended protein but experiencing rapid weight loss</td>
            <td>Reinforce protein importance. General guidance: 0.75-1g protein per kg body weight daily</td>
          </tr>
          <tr>
            <td></td>
            <td>Approve but <strong>contact patient</strong> if NOT meeting protein intake</td>
            <td>Advise on dietary adjustments to prevent muscle mass loss. Calculate their specific requirement</td>
          </tr>
          <tr>
            <td><strong>Signs of dehydration?</strong> (excessive thirst, dry mouth, dark urine, dizziness, fatigue)</td>
            <td><strong>Hold order</strong> and contact patient for more information</td>
            <td>Use side effects macros. Submit PSI via Jira  "Clinically significant Side Effects". Submit Yellow Card</td>
          </tr>
        </table>
        <div class="info-card red" style="margin-top: 16px;">
          <div class="info-card-title"> Stop Treatment When</div>
          <div class="info-card-text">
            Diarrhoea or vomiting while taking oral antibiotics (pause treatment) | Hospitalised due to side effects (stop treatment permanently)
          </div>
        </div>
      </div>
      </div>
    `;
  },

  getSwitchingProtocolCards() {
    return `
      <!-- Switching & Side Effects Tabs -->
      <div class="protocol-tabs">
        <button class="protocol-tab active" data-tab="switching">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 3l4 4-4 4M20 7H4M8 21l-4-4 4-4M4 17h16"/>
          </svg>
          Switching Medications
        </button>
        <button class="protocol-tab" data-tab="contraception">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 9v2M12 15h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Contraception Guidance
        </button>
        <button class="protocol-tab" data-tab="orlistat">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          Orlistat Switching
        </button>
        <button class="protocol-tab" data-tab="side-effects">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          Side Effects
        </button>
      </div>

      <!-- Tab 1: Switching Medications -->
      <div class="protocol-tab-content active" data-tab-content="switching">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 3l4 4-4 4M20 7H4M8 21l-4-4 4-4M4 17h16"/>
            </svg>
          </div>
          Switching Between GLP-1 Medications
        </div>
        <div class="protocol-text">
          Patient does <strong>NOT need to provide a reason</strong> for switching medications. The process depends on whether they're experiencing side effects:
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">No Side Effects = Low Risk</div>
          <div class="protocol-text">
            <strong>Action:</strong> Proceed with prescribing dose equivalent to their last dose as per titration guide.
          </div>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Moderate Side Effects = Low Risk</div>
          <div class="protocol-text">
            <strong>Action:</strong> Can only prescribe dose <strong>equivalent to one step below</strong> their last treatment dose.
          </div>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Severe Side Effects = High Risk</div>
          <div class="protocol-text">
            <strong>Action:</strong> Nurse team must contact patient first before prescribing.
          </div>
          <div class="protocol-text">
            <strong>Only prescribe if:</strong>
          </div>
          <ul class="protocol-list">
            <li>Internal note (NOT critical note) has been left by nurse team, AND</li>
            <li><span class="tag green">Clinical Review</span> tag has been added</li>
          </ul>
          <div class="protocol-text">
            If nurse determines side effects are severe  stop treatment, leave critical note, add Clinical Review tag. In this case, prescriber should reject the order.
          </div>
        </div>
        <div class="divider"></div>
        <div class="protocol-section">
          <div class="protocol-section-title">Switching Workflows by Medication Type</div>
          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Switch Type</th>
                <th>Side Effects Question?</th>
              </tr>
              <tr>
                <td><strong>Mounjaro  Wegovy</strong></td>
                <td> Built-in question in consultation</td>
              </tr>
              <tr>
                <td><strong>Any other switch</strong></td>
                <td> Manually check using macro in Switching SOP</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      </div>
      <!-- End Tab 1 -->

      <!-- Tab 2: Contraception Guidance -->
      <div class="protocol-tab-content" data-tab-content="contraception">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 9v2M12 15h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          Contraception Guidance When Switching
        </div>
        <div class="protocol-text">
          <strong>Important:</strong> If patient is switching between GLP-1 medications, inform them of contraception requirements.
        </div>
        <div class="protocol-text">
          <strong>How to use this table:</strong> Check which medication patient is switching TO, then advise on contraception requirements.
        </div>
        <div class="table-wrapper">
          <table class="dose-table">
            <tr>
              <th>Medication</th>
              <th>Contraception Advice for Oral Contraceptive Users</th>
            </tr>
            <tr>
              <td><strong>Wegovy</strong> (Semaglutide)</td>
              <td>No additional barrier contraception needed with oral contraceptives</td>
            </tr>
            <tr>
              <td><strong>Mounjaro</strong> (Tirzepatide)</td>
              <td>
                <strong>Must use barrier method</strong> (e.g., condoms) alongside oral contraceptives for:<br>
                 <strong>4 weeks after starting</strong> Mounjaro, AND<br>
                 <strong>4 weeks after each dose increase</strong><br>
                <br>
                Reason: Mounjaro impacts oral contraceptive bioavailability. Alternatively, switch to IUD or implant.
              </td>
            </tr>
          </table>
        </div>
      </div>

      </div>
      <!-- End Tab 2 -->

      <!-- Tab 3: Orlistat Switching -->
      <div class="protocol-tab-content" data-tab-content="orlistat">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
          </div>
          Orlistat to GLP-1 Switching
        </div>
        <div class="protocol-text">
          Patients may request to switch from Orlistat to GLP-1 medication.
        </div>
        <div class="protocol-text">
          <strong>Action:</strong> Check patient's order history under "Patient Record" section to verify if they were previously prescribed Orlistat.
        </div>
        <div class="protocol-text">
          If confirmed, proceed with GLP-1 prescription following standard protocols.
        </div>
      </div>

      </div>
      <!-- End Tab 3 -->

      <!-- Tab 4: Side Effects -->
      <div class="protocol-tab-content" data-tab-content="side-effects">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon red">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </div>
          Side Effects Management
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Mild Side Effects</div>
          <div class="protocol-text">
            <strong>Action:</strong> Use side effects macros available on prescribing interface and ZenDesk.
          </div>
          <div class="protocol-text">
            Common mild side effects include: nausea, vomiting, diarrhoea, constipation, injection site reactions.
          </div>
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Severe Side Effects  Required Actions</div>
          <ul class="protocol-list">
            <li><strong>Step 1:</strong> Use severe side effects macros available on prescribing interface</li>
            <li><strong>Step 2:</strong> Submit <strong>Patient Safety Incident (PSI)</strong> via Jira  "Clinically significant Side Effects"  answer "Did these side effects require medical attention?"</li>
            <li><strong>Step 3:</strong> Duty GP will review PSI within 8 working hours</li>
            <li><strong>Step 4:</strong> Submit <strong>Yellow Card report</strong> to MHRA</li>
          </ul>
        </div>
        <div class="info-card red" style="margin-top: 12px;">
          <div class="info-card-title"> All Severe Side Effects Must Be Escalated</div>
          <div class="info-card-text">
            <strong>Every severe side effect</strong> must be raised as a PSI for the Medical Team to review. Do not skip this step.
          </div>
        </div>
      </div>

      </div>
      <!-- End Tab 4 -->
    `;
  },

  getReviewsProtocolCards() {
    return `
      <!-- 6 Month Reviews Tabs -->
      <div class="protocol-tabs">
        <button class="protocol-tab active" data-tab="requirements">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          Review Requirements
        </button>
        <button class="protocol-tab" data-tab="weight-loss">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
          </svg>
          Weight Loss Criteria
        </button>
        <button class="protocol-tab" data-tab="linked-accounts">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
          </svg>
          Linked Accounts
        </button>
      </div>

      <!-- Tab 1: Review Requirements -->
      <div class="protocol-tab-content active" data-tab-content="requirements">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
          </div>
          When 6 Month Reviews Are Required
        </div>
        <div class="protocol-text">
          <strong>Who needs reviews:</strong> Patients at <strong>6, 12, or 18 months</strong> of treatment who have <strong>NOT achieved at least 5% weight loss</strong>.
        </div>
        <div class="protocol-text">
          Orders requiring review are tagged with <span class="tag green">Completed six month review</span>.
        </div>
        <div class="info-card blue" style="margin-top: 12px;">
          <div class="info-card-title">Prescriber Experience Requirement</div>
          <div class="info-card-text">
            Prescribers won't be expected to prescribe 6 month review orders unless they have been prescribing GLP-1 medications for MedExpress for <strong>more than 2 months</strong>.
          </div>
        </div>
      </div>

      </div>
      <!-- End Tab 1 -->

      <!-- Tab 2: Weight Loss Criteria -->
      <div class="protocol-tab-content" data-tab-content="weight-loss">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
            </svg>
          </div>
          Patients with &lt;5% Weight Loss
        </div>
        <div class="protocol-text">
          <strong>Requirement:</strong> Must complete 6-month review questionnaire between their 6th and 10th month of treatment.
        </div>
        <div class="protocol-text">
          Patient has a <strong>3-month window</strong> to complete the review (months 6-9).
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">Timeline & Actions</div>
          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Treatment Period</th>
                <th>Prescriber Action</th>
              </tr>
              <tr>
                <td><strong>Months 6-9</strong></td>
                <td>May still prescribe even if review incomplete</td>
              </tr>
              <tr>
                <td><strong>Month 9 onwards</strong></td>
                <td>If review still not completed  <strong>place order on hold</strong> until questionnaire completed</td>
              </tr>
              <tr>
                <td><strong>Subsequent reviews</strong> (12, 18 months)</td>
                <td>Optional if patient can continue treatment</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
          </div>
          Patients with 5% Weight Loss
        </div>
        <div class="protocol-text">
          <strong>Good news:</strong> Patients who have achieved 5% or more weight loss are <strong>NOT required</strong> to complete the 6-month review questionnaire.
        </div>
        <div class="protocol-text">
          The questionnaire remains <strong>optional</strong> if they wish to complete it at 6-monthly intervals for their own tracking.
        </div>
      </div>

      </div>
      <!-- End Tab 2 -->

      <!-- Tab 3: Linked Accounts -->
      <div class="protocol-tab-content" data-tab-content="linked-accounts">

      <div class="protocol-card">
        <div class="protocol-title">
          <div class="icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
              <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
            </svg>
          </div>
          Linked Accounts (MedExpress & Levity)
        </div>
        <div class="protocol-text">
          Patient may have accounts with both <strong>MedExpress</strong> and <strong>Levity</strong> (historical brand that stopped operations on 1st September 2025).
        </div>
        <div class="protocol-text">
          The system automatically checks for linked accounts across both brands.
        </div>
        <div class="protocol-section">
          <div class="protocol-section-title">If Linked Accounts Are Found</div>
          <ul class="protocol-list">
            <li>Tag order with <span class="tag purple">Linked accounts</span></li>
            <li>Add order URL to Linked Accounts Spreadsheet</li>
            <li>Details visible under "Patient Record" section</li>
          </ul>
        </div>
        <div class="info-card green" style="margin-top: 12px;">
          <div class="info-card-title">Dermatica Accounts  No Action Needed</div>
          <div class="info-card-text">
            If patient also has Dermatica account (skincare), <strong>no action required</strong>. There are no known interactions between GLP-1 medications and skincare products. You can approve without checking Dermatica interface.
          </div>
        </div>
      </div>

      </div>
      <!-- End Tab 3 -->
    `;
  },

  getDefinitionsContent() {
    return `
      <div class="protocol-page">
        <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">Definitions</h1>

        <!-- Definitions Tabs -->
        <div class="protocol-tabs">
          <button class="protocol-tab active" data-tab="patient-types">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
            </svg>
            Patient Types
          </button>
          <button class="protocol-tab" data-tab="terminology">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <path d="M14 2v6h6"/>
            </svg>
            Terminology
          </button>
        </div>

        <!-- Tab 1: Patient Types -->
        <div class="protocol-tab-content active" data-tab-content="patient-types">
        <div class="definitions-grid" style="display: flex; flex-direction: column; gap: 16px;">

          <div class="definition-card">
            <div class="definition-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div class="definition-icon new" style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #34D399 0%, #10B981 100%); display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width: 20px; height: 20px;">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </div>
              <div class="definition-title" style="font-size: 18px; font-weight: 700;">New GLP-1 Patient</div>
            </div>
            <div class="definition-text" style="color: var(--text-secondary); line-height: 1.6;">
              Has <strong>NOT had GLP-1 medications</strong> prescribed and dispatched from MedExpress before. Only sees <strong>starter doses</strong> on the Choose Treatment Page (CTP).
            </div>
          </div>

          <div class="definition-card">
            <div class="definition-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div class="definition-icon repeat" style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%); display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width: 20px; height: 20px;">
                  <path d="M17 2l4 4-4 4M3 11V9a4 4 0 014-4h14M7 22l-4-4 4-4M21 13v2a4 4 0 01-4 4H3"/>
                </svg>
              </div>
              <div class="definition-title" style="font-size: 18px; font-weight: 700;">Repeat GLP-1 Patient</div>
            </div>
            <div class="definition-text" style="color: var(--text-secondary); line-height: 1.6;">
              <strong>HAS had GLP-1 prescribed and dispatched from MedExpress</strong> before. Sees <strong>all available doses</strong> on the Choose Treatment Page (CTP).
            </div>
          </div>

          <div class="definition-card">
            <div class="definition-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div class="definition-icon transfer" style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%); display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width: 20px; height: 20px;">
                  <path d="M16 3h5v5M4 20L21 3M21 16v5h-5"/>
                </svg>
              </div>
              <div class="definition-title" style="font-size: 18px; font-weight: 700;">Transfer Patient</div>
            </div>
            <div class="definition-text" style="color: var(--text-secondary); line-height: 1.6;">
              <strong>New to MedExpress</strong> but has previously used GLP-1 medication from another provider. Must provide <strong>proof of supply</strong>. If BMI below licence, must also provide <strong>previous BMI photo</strong>. <span class="tag red">NHS patients cannot transfer to private.</span>
            </div>
          </div>

          <div class="definition-card">
            <div class="definition-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div class="definition-icon pue" style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #F472B6 0%, #EC4899 100%); display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width: 20px; height: 20px;">
                  <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                  <path d="M14 2v6h6"/>
                </svg>
              </div>
              <div class="definition-title" style="font-size: 18px; font-weight: 700;">Previous Use Evidence <span class="definition-acronym" style="font-size: 11px; font-weight: 600; color: var(--text-muted); background: var(--bg-elevated); padding: 2px 6px; border-radius: 4px; margin-left: 8px;">PUE</span></div>
            </div>
            <div class="definition-text" style="color: var(--text-secondary); line-height: 1.6;">
              Patients <strong>previously treated by MedExpress</strong> who also received GLP-1 from another provider during gaps in treatment. Distinct from Transfer Patients.
            </div>
          </div>

        </div>
        </div>
        <!-- End Tab 1 -->

        <!-- Tab 2: Terminology -->
        <div class="protocol-tab-content" data-tab-content="terminology">
        <div class="definitions-grid" style="display: flex; flex-direction: column; gap: 16px;">

          <div class="definition-card">
            <div class="definition-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div class="definition-icon ctp" style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%); display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width: 20px; height: 20px;">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <path d="M3 9h18M9 21V9"/>
                </svg>
              </div>
              <div class="definition-title" style="font-size: 18px; font-weight: 700;">Choose Treatment Page <span class="definition-acronym" style="font-size: 11px; font-weight: 600; color: var(--text-muted); background: var(--bg-elevated); padding: 2px 6px; border-radius: 4px; margin-left: 8px;">CTP</span></div>
            </div>
            <div class="definition-text" style="color: var(--text-secondary); line-height: 1.6;">
              Webpage displayed after consultation where patient selects their medication and dose. <strong>New patients</strong> only see starter doses. Patients with liver or thyroid disease will <strong>NOT see Nevolat</strong> as an option (only Mounjaro and Wegovy available).
            </div>
          </div>

          <div class="definition-card">
            <div class="definition-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div class="definition-icon switch" style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #FB923C 0%, #F97316 100%); display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width: 20px; height: 20px;">
                  <path d="M16 3l4 4-4 4M20 7H4M8 21l-4-4 4-4M4 17h16"/>
                </svg>
              </div>
              <div class="definition-title" style="font-size: 18px; font-weight: 700;">Switching Patient</div>
            </div>
            <div class="definition-text" style="color: var(--text-secondary); line-height: 1.6;">
              Patient was previously on one GLP-1 medication and has now ordered a <strong>different medication</strong> (e.g., Mounjaro  Wegovy, or Wegovy  Nevolat).
            </div>
          </div>

        </div>
        </div>
        <!-- End Tab 2 -->
      </div>
    `;
  },

  getContraindicationsContent() {
    return `
      <div class="protocol-page">
        <div class="page-header-with-search">
          <h1 style="font-size: 24px; font-weight: 700; margin: 0;">Contraindications</h1>
          <div class="local-search-container">
            <svg class="local-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="M21 21l-4.35-4.35"/>
            </svg>
            <input
              type="text"
              id="contraindicationsSearch"
              class="local-search-input"
              placeholder="Search within contraindications..."
            />
            <div id="localOccurrenceControls" class="occurrence-controls" style="display: none;">
              <span id="localOccurrenceCount" class="occurrence-count">0/0</span>
              <button id="localPrevOccurrence" class="occurrence-nav" title="Previous">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"/>
                </svg>
              </button>
              <button id="localNextOccurrence" class="occurrence-nav" title="Next">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </button>
            </div>
            <button id="localSearchClear" class="search-clear" style="display: none;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="info-card red" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0;">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <path d="M12 9v4M12 17h.01"/>
            </svg>
            <div>
              <strong>DO NOT PRESCRIBE</strong> if patient has ANY of the following absolute contraindications. Reject the consultation immediately.
            </div>
          </div>
        </div>

        <!-- Contraindications Tabs -->
        <div class="protocol-tabs">
          <button class="protocol-tab active" data-tab="absolute">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            Absolute Contraindications
          </button>
          <button class="protocol-tab" data-tab="time-sensitive">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            Time-Sensitive Conditions
          </button>
          <button class="protocol-tab" data-tab="clinical-details">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
            </svg>
            Clinical Details Required
          </button>
          <button class="protocol-tab" data-tab="patient-assessment">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <path d="M20 8v6M23 11h-6"/>
            </svg>
            Patient Assessment Required
          </button>
        </div>

        <!-- Tab 1: Absolute Contraindications -->
        <div class="protocol-tab-content active" data-tab-content="absolute">

        <div class="protocol-card" id="pregnancy-contraindication">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <strong>Pregnancy & Reproduction</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Pregnancy</strong>  confirmed or suspected</li>
            <li><strong>Planning pregnancy</strong>  within next 2 months</li>
            <li><strong>Breastfeeding</strong>  currently breastfeeding</li>
            <li><strong>Inadequate contraception</strong>  sexually active women of childbearing potential must use reliable contraception</li>
          </ul>
        </div>

        <div class="protocol-card" id="diabetes-contraindication">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            <strong>Diabetes & Metabolic Conditions</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Type 1 diabetes</strong></li>
            <li><strong>Diabetic ketoacidosis</strong> (history or current)</li>
            <li><strong>Diabetic retinopathy</strong> (for GLP-1 medications)</li>
          </ul>
        </div>

        <div class="protocol-card" id="thyroid-contraindication">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--accent); flex-shrink: 0;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <strong>Thyroid & Endocrine</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Personal history of medullary thyroid carcinoma (MTC)</strong></li>
            <li><strong>Family history of medullary thyroid carcinoma</strong></li>
            <li><strong>Multiple endocrine neoplasia syndrome type 2 (MEN2)</strong></li>
            <li><strong>History of thyroid cancer</strong> (any type)</li>
          </ul>
        </div>

        <div class="protocol-card" id="gastrointestinal-contraindication">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            <strong>Gastrointestinal</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Active pancreatitis</strong></li>
            <li><strong>History of pancreatitis</strong></li>
            <li><strong>Inflammatory bowel disease</strong> (Crohn's disease, ulcerative colitis)  active or significant history</li>
            <li><strong>Gastroparesis</strong></li>
          </ul>
        </div>

        <div class="protocol-card" id="renal-hepatic-contraindication">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <strong>Renal & Hepatic</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Severe renal impairment</strong>  eGFR &lt;30 mL/min/1.73m</li>
            <li><strong>End-stage renal disease (ESRD)</strong></li>
            <li><strong>Severe hepatic impairment</strong>  decompensated cirrhosis, acute liver failure</li>
          </ul>
        </div>

        <div class="protocol-card" id="allergies-contraindication">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <path d="M12 9v4M12 17h.01"/>
            </svg>
            <strong>Allergies & Previous Reactions</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Known hypersensitivity</strong> to semaglutide, tirzepatide, liraglutide, or any excipients</li>
            <li><strong>Previous severe reaction</strong> to any GLP-1 agonist</li>
          </ul>
        </div>

        <div class="protocol-card" id="psychiatric-contraindication">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--accent); flex-shrink: 0;">
              <path d="M12 2a9 9 0 0 0-9 9c0 4.97 4.03 9 9 9s9-4.03 9-9a9 9 0 0 0-9-9z"/>
              <path d="M12 6v6l4 2"/>
              <path d="M16.5 12c.28 0 .5.22.5.5s-.22.5-.5.5-.5-.22-.5-.5.22-.5.5-.5z"/>
            </svg>
            <strong>Psychiatric & Behavioral</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Active eating disorder</strong>  anorexia nervosa, bulimia nervosa</li>
            <li><strong>Active suicidal ideation</strong></li>
            <li><strong>Severe untreated depression</strong> or psychiatric instability</li>
          </ul>
        </div>

        <div class="protocol-card" id="age-restrictions">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--accent); flex-shrink: 0;">
              <circle cx="12" cy="8" r="7"/>
              <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
            </svg>
            <strong>Age Restrictions</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Under 18 years old</strong>  unless exceptional circumstances with specialist input</li>
            <li><strong>Over 75 years old</strong>  caution required, may need specialist review</li>
          </ul>
        </div>

        <div class="protocol-card" id="other-contraindications">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            <strong>Other Absolute Contraindications</strong>
          </div>
          <ul class="protocol-list">
            <li><strong>Malignancy</strong>  active cancer or recent cancer (within 5 years) except basal cell carcinoma</li>
            <li><strong>Substance abuse</strong>  active drug or alcohol abuse</li>
            <li><strong>Inability to give informed consent</strong></li>
          </ul>
        </div>

        <div class="protocol-card" id="interacting-medications">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <path d="M12 9v4M12 17h.01"/>
            </svg>
            <strong>Interacting Medications</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            Patient must answer <strong>"No"</strong> to the question: "Are you currently taking any of the following medications?" If <strong>Yes</strong> to any  reject consultation.
          </div>
          <ul class="protocol-list">
            <li>Amiodarone</li>
            <li>Carbamazepine</li>
            <li>Ciclosporin</li>
            <li>Clozapine</li>
            <li>Digoxin</li>
            <li>Fenfluramine</li>
            <li>Lithium</li>
            <li>Mycophenolate mofetil</li>
            <li>Oral methotrexate</li>
            <li>Phenobarbital</li>
            <li>Phenytoin</li>
            <li>Somatrogon</li>
            <li>Tacrolimus</li>
            <li>Theophylline</li>
            <li>Warfarin</li>
          </ul>
        </div>

        <div class="info-card blue" style="margin-top: 20px;">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <div>
              <strong>Caution Required (Not Absolute Contraindications):</strong> Moderate renal/hepatic impairment, history of gallbladder disease, cardiovascular disease, hypoglycemia risk (when used with insulin/sulfonylureas), gastrointestinal disease, age &gt;75 years. These require careful assessment but are not automatic rejections.
            </div>
          </div>
        </div>

        <div class="info-card blue" style="margin-top: 20px;">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <div>
              <strong>Caution Required (Not Absolute Contraindications):</strong> Moderate renal/hepatic impairment, history of gallbladder disease, cardiovascular disease, hypoglycemia risk (when used with insulin/sulfonylureas), gastrointestinal disease, age &gt;75 years. These require careful assessment but are not automatic rejections.
            </div>
          </div>
        </div>

        <h2 style="font-size: 22px; font-weight: 700; margin-top: 48px; margin-bottom: 24px; padding-top: 24px; border-top: 2px solid var(--border);">Time-Sensitive Conditions</h2>

        <div class="info-card orange" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <div>
              <strong>Timing Matters:</strong> If timing information is missing, email patient (Macro 1). Reject when timing falls within contraindication window.
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 1 -->

        <!-- Tab 2: Time-Sensitive Conditions -->
        <div class="protocol-tab-content" data-tab-content="time-sensitive">

        <div class="protocol-card" id="bariatric-surgery">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <strong>Bariatric Surgery  12 Month Exclusion</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Time restriction:</strong> &lt;12 months post-surgery = <strong class="tag red">REJECT</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            Surgery types include:
          </div>
          <ul class="protocol-list">
            <li>Roux-en-Y Gastric Bypass (RYGB)</li>
            <li>Sleeve Gastrectomy</li>
            <li>Adjustable Gastric Band (Lap-Band)</li>
            <li>Biliopancreatic Diversion with Duodenal Switch (BPD/DS)</li>
            <li>Mini Gastric Bypass (OAGB  One Anastomosis Gastric Bypass)</li>
            <li>Endoscopic Bariatric Procedures (e.g., gastric balloon)</li>
          </ul>
          <div class="info-card green" style="margin-top: 12px;">
            <div class="info-card-title">Safe to prescribe</div>
            <div class="info-card-text">If surgery was <strong>12 months ago</strong> (more than a year)</div>
          </div>
        </div>

        <div class="protocol-card" id="cholecystectomy">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            <strong>Cholecystectomy (Gallbladder Removal)  12 Month Exclusion</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Time restriction:</strong> &lt;12 months post-surgery = <strong class="tag red">REJECT</strong>
          </div>
          <div class="info-card green" style="margin-top: 12px;">
            <div class="info-card-title">Safe to prescribe</div>
            <div class="info-card-text">If surgery was <strong>12 months ago</strong> (more than a year)</div>
          </div>
        </div>

        <div class="protocol-card" id="insulin-diabetic-meds">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            <strong>Insulin or Oral Diabetic Medications</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong class="tag red">REJECT</strong> if either condition applies:
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Prescribed within the last <strong>3 months as acute</strong></li>
            <li><strong>OR</strong> present on list of <strong>repeat medication</strong></li>
          </ul>

          <div class="protocol-section-title" style="margin-top: 16px;">Oral Diabetic Medications:</div>
          <div class="scr-two-col">
            <div>
              <strong style="color: var(--warning);">Sulfonylureas:</strong>
              <ul class="protocol-list">
                <li>Diamicron [gliclazide]</li>
                <li>Daonil [glibenclamide]</li>
                <li>Rastin [tolbutamide]</li>
              </ul>
              <strong style="color: var(--warning);">SGLT2 inhibitors:</strong>
              <ul class="protocol-list">
                <li>Jardiance [empagliflozin]</li>
                <li>Forxiga [dapagliflozin]</li>
                <li>Invokana [canagliflozin]</li>
              </ul>
            </div>
            <div>
              <strong style="color: var(--warning);">DPP-4 inhibitors:</strong>
              <ul class="protocol-list">
                <li>Januvia [sitagliptin]</li>
                <li>Galvus [vildagliptin]</li>
                <li>Trajenta [linagliptin]</li>
              </ul>
              <strong style="color: var(--warning);">Thiazolidinediones:</strong>
              <ul class="protocol-list">
                <li>Actos [pioglitazone]</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="protocol-card" id="narrow-therapeutic-medications">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <path d="M12 9v4"/>
              <path d="M12 17h.01"/>
            </svg>
            <strong>Narrow Therapeutic Index Medications</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong class="tag red">REJECT</strong> if either condition applies:
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Prescribed within the last <strong>3 months as acute</strong></li>
            <li><strong>OR</strong> present on list of <strong>repeat medication</strong></li>
          </ul>

          <div class="scr-two-col">
            <div>
              <ul class="protocol-list">
                <li><strong>Amiodarone</strong></li>
                <li><strong>Carbamazepine</strong></li>
                <li><strong>Ciclosporin</strong></li>
                <li><strong>Clozapine</strong></li>
                <li><strong>Digoxin</strong></li>
                <li><strong>Fenfluramine</strong></li>
                <li><strong>Lithium</strong></li>
                <li><strong>Mycophenolate mofetil</strong></li>
              </ul>
            </div>
            <div>
              <ul class="protocol-list">
                <li><strong>Oral methotrexate</strong></li>
                <li><strong>Phenobarbital</strong></li>
                <li><strong>Phenytoin</strong></li>
                <li><strong>Somatrogon</strong></li>
                <li><strong>Tacrolimus</strong></li>
                <li><strong>Theophylline</strong></li>
                <li><strong>Warfarin</strong></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="protocol-card" id="orlistat">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <strong>Orlistat (Alli / Xenical)</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong class="tag red">REJECT</strong> if GLP prescription issued <strong>&lt;1 month</strong> after Orlistat
          </div>
          <div class="protocol-text">
            Concurrent use is a contraindication. Patient must be off Orlistat for at least 1 month before starting GLP-1.
          </div>
          <div class="info-card warning" style="margin-top: 12px;">
            <div class="info-card-title">Edge case: Transfer patients with recent PUE</div>
            <div class="info-card-text">Transfer patients will have PUE for the past month. In these cases please <strong>follow up with an email</strong> as per main SOP rather than rejecting. Email macro titled <strong>'PUE &lt;2 Weeks Old'</strong></div>
          </div>
        </div>

        </div>
        <!-- End Tab 2 -->

        <!-- Tab 3: Clinical Details Required -->
        <div class="protocol-tab-content" data-tab-content="clinical-details">

        <h2 style="font-size: 22px; font-weight: 700; margin-top: 48px; margin-bottom: 24px; padding-top: 24px; border-top: 2px solid var(--border);">Clinical Details Required</h2>

        <div class="info-card blue" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0;">
              <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/>
              <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
            </svg>
            <div>
              <strong>Missing Information:</strong> If you do not have the relevant information, you must reach out to the patient to make a decision.
            </div>
          </div>
        </div>

        <div class="protocol-card" id="gallstones-cholecystitis">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            <strong>Cholelithiasis (Gallstones) or Cholecystitis</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>If no evidence of cholecystectomy:</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Put order on <strong>hold</strong></li>
            <li>Email patient using <strong class="tag orange">Macro 2</strong></li>
            <li>Ask: "Have you had your gallbladder removed? If yes, when?"</li>
          </ul>
          <div class="info-card red">
            <div class="info-card-title">Reject if:</div>
            <div class="info-card-text">Customer confirms <strong>no cholecystectomy</strong> (gallbladder still present)</div>
          </div>
          <div class="info-card green" style="margin-top: 8px;">
            <div class="info-card-title">Prescribe if:</div>
            <div class="info-card-text">Cholecystectomy confirmed by patient (even if not visible on SCR)</div>
          </div>
        </div>

        <div class="protocol-card" id="heart-failure">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            <strong>Heart Failure (HF)</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>If no information on stage:</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Email patient using <strong class="tag orange">Macro 4</strong></li>
            <li>Request: Last letter from cardiologist stating stage OR fitness for GLP1</li>
          </ul>
          <div class="info-card red">
            <div class="info-card-title">Reject if:</div>
            <div class="info-card-text">Customer confirms <strong>Stage IV heart failure</strong></div>
          </div>
          <div class="info-card green" style="margin-top: 8px;">
            <div class="info-card-title">Prescribe if:</div>
            <div class="info-card-text">Stage I, II, or III confirmed</div>
          </div>
        </div>

        <div class="protocol-card" id="chronic-kidney-disease">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--accent); flex-shrink: 0;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
            <strong>Chronic Kidney Disease (CKD)</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>If no information on eGFR or stage:</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Email patient using <strong class="tag orange">Macro 5</strong></li>
            <li>Request: Most recent eGFR result</li>
          </ul>
          <div class="info-card red">
            <div class="info-card-title">Reject if:</div>
            <div class="info-card-text"><strong>eGFR &lt;30</strong> or <strong>Stage 4 CKD</strong> confirmed</div>
          </div>
          <div class="info-card green" style="margin-top: 8px;">
            <div class="info-card-title">Prescribe if:</div>
            <div class="info-card-text">eGFR 30 (Stage 1, 2, or 3)</div>
          </div>
        </div>

        </div>
        <!-- End Tab 3 -->

        <!-- Tab 4: Patient Assessment Required -->
        <div class="protocol-tab-content" data-tab-content="patient-assessment">

        <h2 style="font-size: 22px; font-weight: 700; margin-top: 48px; margin-bottom: 24px; padding-top: 24px; border-top: 2px solid var(--border);">Patient Assessment Required</h2>

        <div class="info-card purple" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0;">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
            </svg>
            <div>
              <strong>Clinical Judgement:</strong> These conditions require gathering information from the patient to determine safety and prescribing decision.
            </div>
          </div>
        </div>

        <div class="protocol-card" id="cancer-assessment">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 8v4M12 16h.01"/>
            </svg>
            <strong>Cancer Diagnosis (excluding MEN2 / medullary thyroid cancer)</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Information required in ALL cases</strong>  Email using <strong class="tag orange">Macro 3</strong>
          </div>
          <ul class="protocol-list">
            <li>Are they under a specialist / currently undergoing treatment from an oncology team?</li>
            <li>Is the cancer in remission? Have they been discharged from oncology?</li>
            <li>Request: Discharge letter / latest oncology letter</li>
          </ul>
          <div class="protocol-text" style="margin-top: 12px;">
            Use clinical judgement based on response to prescribe or reject.
          </div>
        </div>

        <div class="protocol-card" id="pregnancy-assessment">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <strong>Pregnancy</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>More information needed in ALL cases</strong>  Email using <strong class="tag orange">Macro 6</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Are you currently pregnant?</li>
            <li>Are you breastfeeding?</li>
            <li>Are you trying to conceive?</li>
          </ul>
          <div class="info-card red">
            <div class="info-card-title">REJECT if:</div>
            <div class="info-card-text">Currently pregnant, breastfeeding, or trying to conceive</div>
          </div>
          <div class="info-card green" style="margin-top: 8px;">
            <div class="info-card-title">APPROVE if:</div>
            <div class="info-card-text">None of the above apply</div>
          </div>
        </div>

        <div class="protocol-card" id="dementia-assessment">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--accent); flex-shrink: 0;">
              <path d="M12 2a9 9 0 0 0-9 9c0 4.97 4.03 9 9 9s9-4.03 9-9a9 9 0 0 0-9-9z"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <strong>Dementia / Cognitive Impairment</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>More information needed in ALL cases</strong>  Email using <strong class="tag orange">Macro 7</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Are they safe at home to use the medication?</li>
            <li>How do they manage day-to-day tasks?</li>
            <li>Do they have help/support at home?</li>
            <li>Are they capable of safely self-administering injectable medication?</li>
          </ul>
          <div class="protocol-text">
            <strong>Clinical decision:</strong> Prescribe or reject according to the patient's ability to take the medication safely and support around the patient.
          </div>
        </div>

        <div class="protocol-card" id="malabsorption-assessment">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            <strong>Chronic Malabsorption</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>More information needed in ALL cases</strong>  Email using <strong class="tag orange">Macro 8</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Request evidence of formal diagnosis or specialist letter</li>
          </ul>
          <div class="info-card red">
            <div class="info-card-title">REJECT if:</div>
            <div class="info-card-text">Patient has a <strong>formal diagnosis</strong> of chronic malabsorption</div>
          </div>
        </div>

        <div class="protocol-card" id="depression-anxiety-assessment">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M12 2a9 9 0 0 0-9 9c0 4.97 4.03 9 9 9s9-4.03 9-9a9 9 0 0 0-9-9z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <strong>Depression or Anxiety  Acutely Mentally Unwell</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            Email using <strong class="tag orange">Macro 9</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Check SCR for timing:</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>Added to SCR &lt;3 months ago?  <strong class="tag red">REJECT</strong></li>
            <li>Entry older than 3 months?  <strong class="tag green">Prescribe</strong></li>
          </ul>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Antidepressant medications can be used as a proxy:</strong>
          </div>
          <ul class="protocol-list">
            <li>New antidepressant or dose increase in last 3 months?  <strong class="tag red">REJECT</strong></li>
            <li>New antidepressant or increased dose was 3 months ago?  <strong class="tag green">Prescribe</strong></li>
          </ul>
        </div>

        <div class="protocol-card" id="suicidal-ideation-assessment">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--danger); flex-shrink: 0;">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <path d="M12 9v4"/>
              <path d="M12 17h.01"/>
            </svg>
            <strong>Active Suicidal Ideation</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            Email using <strong class="tag orange">Macro 9</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Check SCR for timing:</strong>
          </div>
          <ul class="protocol-list">
            <li>Added to SCR in the last year (&lt;12 months)?  <strong class="tag red">REJECT</strong></li>
            <li>Added 12 months ago or more?  <strong class="tag green">Prescribe</strong></li>
          </ul>
        </div>

        <div class="protocol-card" id="alcohol-abuse-assessment">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--warning); flex-shrink: 0;">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
              <path d="M9 10h.01M15 10h.01M9.5 15.5c1 .5 2.5 .5 3.5 .5s2.5 0 3.5-.5"/>
            </svg>
            <strong>Current Alcohol Abuse or Dependence</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            Email using <strong class="tag orange">Macro 10</strong>
          </div>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Ask patient about current drinking:</strong>
          </div>
          <ul class="protocol-list" style="margin-bottom: 16px;">
            <li>How much are they currently drinking?</li>
            <li>CAGE-style prompts: cut down, annoyed by criticism, guilty, eye-opener?</li>
          </ul>
          <div class="protocol-text" style="margin-bottom: 12px;">
            <strong>Check SCR for timing:</strong>
          </div>
          <ul class="protocol-list">
            <li>Added to SCR in the last year (&lt;12 months) OR current alcohol abuse?  <strong class="tag red">REJECT</strong></li>
            <li>Added 12 months ago?  <strong class="tag green">Prescribe</strong></li>
          </ul>
          <div class="info-card blue" style="margin-top: 12px;">
            <div class="info-card-title">Important Note</div>
            <div class="info-card-text">Only <strong>current alcohol dependence</strong> is an exclusion. Past history (&gt;12 months) is acceptable if patient is no longer dependent.</div>
          </div>
        </div>

        </div>
        <!-- End Tab 4 -->

      </div>
    `;
  },

  getTagsContent() {
    return `
      <div class="protocol-page">
        <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">Tags Reference</h1>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">Quick reference guide for order tags and required actions</p>

        <div class="info-card blue" style="margin-bottom: 20px;">
          <div class="info-card-title">How to Use This Reference</div>
          <div class="info-card-text"><strong>Action Tags</strong> require you to take specific steps before approving/rejecting. <strong>System Tags</strong> are informational only and show patient history or status.</div>
        </div>

        <!-- Tags Reference Tabs -->
        <div class="protocol-tabs">
          <button class="protocol-tab active" data-tab="action-tags">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
              <line x1="7" y1="7" x2="7.01" y2="7"/>
            </svg>
            Action Tags
          </button>
          <button class="protocol-tab" data-tab="system-tags">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
            </svg>
            System Tags
          </button>
        </div>

        <!-- Tab 1: Action Tags -->
        <div class="protocol-tab-content active" data-tab-content="action-tags">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon orange">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
                <line x1="7" y1="7" x2="7.01" y2="7"/>
              </svg>
            </div>
            Action Tags  Require Your Action
          </div>
          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th style="width: 25%;">Tag</th>
                <th style="width: 35%;">What It Means</th>
                <th style="width: 40%;">Action Required</th>
              </tr>
            <tr>
              <td><span class="tag orange">Pending Customer Response</span></td>
              <td>Patient has been emailed for additional information</td>
              <td>Wait for patient reply. Check back in 48 hours. Auto-reject after 7 days.</td>
            </tr>
            <tr>
              <td><span class="tag red">Failed ID</span></td>
              <td>ID verification failed (new patients only)</td>
              <td>Email patient requesting valid photo ID. Add Pending Customer Response tag.</td>
            </tr>
            <tr>
              <td><span class="tag red">Photo Doesn't Match ID</span></td>
              <td>Selfie photo doesn't match ID photo</td>
              <td>Email patient requesting new selfie. If suspicious, escalate to Senior Prescriber.</td>
            </tr>
            <tr>
              <td><span class="tag purple">escalated</span></td>
              <td>Consultation requires Senior Prescriber review</td>
              <td><strong style="color: var(--danger);">Do not approve/reject.</strong> Senior Prescriber will review within 24 hours.</td>
            </tr>
            <tr>
              <td><span class="tag blue">Requested PUE</span></td>
              <td>Patient has been asked to upload proof of previous use</td>
              <td>Wait for PUE upload. Check back in 48 hours. Follow PUE protocol when received.</td>
            </tr>
            <tr>
              <td><span class="tag orange">6-Month Review Due</span></td>
              <td>Patient has been on treatment 6 months</td>
              <td>Check if patient completed review questionnaire. If not, email reminder.</td>
            </tr>
            <tr>
              <td><span class="tag red">Weight Gain >7%</span></td>
              <td>Patient gained >7% since starting treatment</td>
              <td>Follow weight monitoring protocol. Assess tolerance, adherence, contraindications.</td>
            </tr>
            <tr>
              <td><span class="tag orange">GP Contact Required</span></td>
              <td>Need to verify patient details with GP</td>
              <td>Contact GP surgery to confirm registration. Document outcome in notes.</td>
            </tr>
            <tr>
              <td><span class="tag orange">Long treatment gap</span></td>
              <td>Patient has gap >8 weeks since last dose</td>
              <td>Use Gap Adjustment Table in Titration Guide to determine safe restart dose.</td>
            </tr>
            </table>
          </div>
        </div>

        </div>
        <!-- End Tab 1 -->

        <!-- Tab 2: System Tags -->
        <div class="protocol-tab-content" data-tab-content="system-tags">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
              </svg>
            </div>
            System Tags  Informational Only
          </div>

          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th style="width: 30%;">Tag</th>
                <th>What It Means</th>
              </tr>
            <tr>
              <td><span class="tag green">Completed six month review</span></td>
              <td>Patient has completed the 6-month review questionnaire</td>
            </tr>
            <tr>
              <td><span class="tag blue">Transfer Patient</span></td>
              <td>Patient transferred from another GLP-1 provider</td>
            </tr>
            <tr>
              <td><span class="tag purple">Switching Medication</span></td>
              <td>Patient is changing from one GLP-1 to another (use Dose Equivalence Table)</td>
            </tr>
            <tr>
              <td><span class="tag orange">Previous NHS Supply</span></td>
              <td><strong style="color: var(--danger);">Patient previously received GLP-1 through NHS</strong> (cannot continue privately)</td>
            </tr>
            <tr>
              <td><span class="tag green">PUE Verified</span></td>
              <td>Previous Use Evidence has been reviewed and accepted</td>
            </tr>
            <tr>
              <td><span class="tag blue">Linked Accounts</span></td>
              <td>Patient has multiple accounts (duplicate detected - verify identity)</td>
            </tr>
            <tr>
              <td><span class="tag orange">Gap in Treatment >8 weeks</span></td>
              <td>Patient had significant gap between orders (see Titration Guide for dose adjustment)</td>
            </tr>
            <tr>
              <td><span class="tag red">Previous Rejection</span></td>
              <td>Patient was previously rejected (check rejection reason before proceeding)</td>
            </tr>
            <tr>
              <td><span class="tag orange">Order Cancellation Requested</span></td>
              <td><strong style="color: var(--danger);">DO NOT prescribe or reject.</strong> Patient has 24 hours to confirm cancellation.</td>
            </tr>
          </table>
        </div>

        <div class="info-card" style="margin-top: 20px;">
          <div class="info-card-title">Tag Management</div>
          <div class="info-card-text">Tags are automatically applied by the system based on patient actions and consultation answers. You may need to manually add tags like <span class="tag orange">Pending Customer Response</span> or <span class="tag purple">escalated</span> when required.</div>
        </div>

        </div>
        <!-- End Tab 2 -->
      </div>
    `;
  },

  getTransferContent() {
    return `
      <div class="protocol-page">
        <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">Transfer Patients</h1>

        <div class="info-card purple" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0;">
              <path d="M16 3h5v5M4 20L21 3M21 16v5h-5"/>
            </svg>
            <div>
              <strong>Transfer Patient:</strong> A new MedExpress patient who has previously used GLP-1 medication from another <strong>private provider</strong>. Must provide proof of previous supply. <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: var(--danger); color: white; border-radius: 4px; font-size: 11px; font-weight: 700;">NHS TRANSFERS NOT ALLOWED</span>
            </div>
          </div>
        </div>

        <div class="protocol-card">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; color: var(--accent); flex-shrink: 0;">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            <strong>BMI-Based Requirements</strong>
          </div>

          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--accent);">
            <strong>Assessment Rule:</strong> Requirements depend on the patient's <strong>current BMI</strong>. Check their BMI first, then verify appropriate evidence.
          </div>

          <div class="table-wrapper">
            <table class="dose-table" style="margin-top: 16px;">
              <tr>
                <th style="width: 20%;">Current BMI</th>
                <th style="width: 40%;">Required Evidence</th>
                <th style="width: 40%;">Action if Evidence Missing/Fails</th>
              </tr>
            <tr>
              <td><strong style="color: var(--success);">BMI 27</strong><br><span style="font-size: 12px; color: var(--text-secondary);">(Above licence threshold)</span></td>
              <td>
                <strong>Proof of Previous GLP-1 Supply (PUE)</strong><br>
                <span style="font-size: 12px; color: var(--text-secondary);">Just PUE needed  no previous BMI photo required</span>
              </td>
              <td>
                If no PUE provided  Customer Care can amend order to starter dose<br>
                <span style="font-size: 12px; color: var(--accent);">Message: <strong>ME-Clinical-Communication</strong> Slack channel</span>
              </td>
            </tr>
            <tr>
              <td><strong style="color: var(--danger);">BMI &lt;27</strong><br><span style="font-size: 12px; color: var(--text-secondary);">(Below licence threshold)</span></td>
              <td>
                <strong>BOTH required:</strong><br>
                1 Proof of Previous GLP-1 Supply (PUE)<br>
                2 Previous BMI Photo showing BMI 27
              </td>
              <td>
                <strong style="color: var(--danger);">Cannot proceed without BOTH</strong><br>
                If either missing  Patient NOT eligible<br>
                <span style="font-size: 12px; color: var(--accent);">Use email template: <em>Clinical: Evidence of starting BMI</em></span>
              </td>
            </tr>
            </table>
          </div>
        </div>

        <div class="protocol-card" style="margin-top: 20px;">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; color: var(--success); flex-shrink: 0;">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
            </svg>
            <strong>Acceptable Proof of Previous Supply (PUE)</strong>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 16px;">
            <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--success);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; color: var(--success);">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <strong>Prescription Label</strong>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">From previous provider showing medication name and date</div>
            </div>

            <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--success);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; color: var(--success);">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <strong>Order Confirmation</strong>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">Email from previous private provider</div>
            </div>

            <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--success);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; color: var(--success);">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <strong>Pharmacy Receipt</strong>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">Showing GLP-1 medication purchase</div>
            </div>

            <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--success);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; color: var(--success);">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <strong>Medication Photo</strong>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">Box/pen with patient's name visible</div>
            </div>

            <div style="padding: 16px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--success);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; color: var(--success);">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <strong>Prescription Record</strong>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">From previous provider's system</div>
            </div>
          </div>

          <div class="info-card red" style="margin-top: 20px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              <div>
                <strong>NHS Transfers Prohibited:</strong> Patients previously receiving GLP-1 via NHS prescription <strong>cannot</strong> transfer to private MedExpress treatment. They must continue with the NHS pathway.
              </div>
            </div>
          </div>
        </div>

        <div class="protocol-card" style="margin-top: 20px;">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; color: var(--purple); flex-shrink: 0;">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="M21 15l-5-5L5 21"/>
            </svg>
            <strong>Previous BMI Photo Requirements (BMI &lt;27 only)</strong>
          </div>

          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--purple);">
            <strong>When Required:</strong> Only for patients with <strong>current BMI &lt;27</strong>. Must prove they started treatment with BMI 27.
          </div>

          <div style="margin-top: 16px;">
            <strong style="display: block; margin-bottom: 12px;">Photo Must Show:</strong>
            <div class="table-wrapper">
              <table class="dose-table">
                <tr>
                  <th style="width: 30%;">Requirement</th>
                  <th style="width: 70%;">Details</th>
                </tr>
              <tr>
                <td><strong>Full Body on Scales</strong></td>
                <td>Patient must be standing on weighing scales with full body visible</td>
              </tr>
              <tr>
                <td><strong>Clear Scale Display</strong></td>
                <td>Weight reading must be clearly visible and legible</td>
              </tr>
              <tr>
                <td><strong>Date Visible</strong></td>
                <td>Within last 12 months, ideally when they started GLP-1 treatment</td>
              </tr>
              <tr>
                <td><strong>Patient Identifiable</strong></td>
                <td>Must be able to confirm it's the same patient</td>
              </tr>
              <tr>
                <td><strong>BMI 27 Verified</strong></td>
                <td>Calculate BMI from visible weight and stated height  must be 27</td>
              </tr>
              </table>
            </div>
          </div>

          <div class="info-card orange" style="margin-top: 20px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                <path d="M12 9v4M12 17h.01"/>
              </svg>
              <div>
                <strong>If Previous BMI Photo Fails:</strong><br>
                1. Add tag: <span style="display: inline-block; margin: 4px 4px; padding: 3px 8px; background: var(--purple-bg); color: var(--purple); border-radius: 4px; font-size: 11px; font-weight: 600;">previous BMI verification failed</span><br>
                2. Remove tag: <span style="display: inline-block; margin: 4px 4px; padding: 3px 8px; background: var(--accent-bg); color: var(--accent); border-radius: 4px; font-size: 11px; font-weight: 600;">prescriber review</span><br>
                3. Send manual email explaining the failure<br>
                <strong style="color: var(--danger);"> Do NOT use "Weight verification failed" tag</strong>  that's only for current weight photos
              </div>
            </div>
          </div>
        </div>

        <div class="protocol-card" style="margin-top: 20px;">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; color: var(--success); flex-shrink: 0;">
              <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <strong>Transfer Patient Checklist</strong>
          </div>

          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
            Complete all checks below in addition to standard core protocol checks:
          </div>

          <div style="display: grid; gap: 12px; margin-top: 16px;">
            <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
              <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; font-size: 12px;">1</div>
              <div>
                <strong>Verify Proof of Previous GLP-1 Supply (PUE)</strong><br>
                <span style="font-size: 13px; color: var(--text-secondary);">Must be from private provider (see acceptable evidence list above)</span>
              </div>
            </div>

            <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
              <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; font-size: 12px;">2</div>
              <div>
                <strong>Check Current BMI Eligibility</strong><br>
                <span style="font-size: 13px; color: var(--text-secondary);">Determine if BMI 27 or &lt;27 to know evidence requirements</span>
              </div>
            </div>

            <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
              <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; font-size: 12px;">3</div>
              <div>
                <strong>If BMI &lt;27: Verify Previous BMI Photo</strong><br>
                <span style="font-size: 13px; color: var(--text-secondary);">Must show patient on scales with BMI 27 when they started treatment</span>
              </div>
            </div>

            <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
              <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; font-size: 12px;">4</div>
              <div>
                <strong>Confirm NOT NHS Transfer</strong><br>
                <span style="font-size: 13px; color: var(--text-secondary);">Verify previous supply was from private provider only</span>
              </div>
            </div>

            <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
              <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; font-size: 12px;">5</div>
              <div>
                <strong>Verify Dose Appropriateness</strong><br>
                <span style="font-size: 13px; color: var(--text-secondary);">Check dose is suitable for transfer patient (refer to Titration & Gap protocol)</span>
              </div>
            </div>

            <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
              <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--success); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; font-size: 12px;">6</div>
              <div>
                <strong>Complete Standard Verification Checks</strong><br>
                <span style="font-size: 13px; color: var(--text-secondary);">ID verification, age check, photo verification, GP notification consent</span>
              </div>
            </div>
          </div>

          <div style="margin-top: 20px; padding: 14px; background: var(--accent-bg); border-radius: 8px; border-left: 3px solid var(--accent);">
            <strong> Next Steps:</strong> Once all transfer patient checks are complete, proceed to <strong>Core Checks</strong>, <strong>Previous Use Evidence</strong>, and <strong>Titration & Gap</strong> protocols as needed.
          </div>
        </div>
      </div>
    `;
  },

  getConsultationContent() {
    return `
      <div class="protocol-page">
        <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">Consultation Questions</h1>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">Required answers and patient eligibility criteria</p>

        <div class="info-card blue" style="margin-bottom: 20px;">
          <div class="info-card-title">How to Use This Reference</div>
          <div class="info-card-text">All patients must complete consultation form covering age, BMI eligibility, medical history, contraindications, current medications, and consent. The tables below show required answers for approval.</div>
        </div>

        <!-- Consultation Questions Tabs -->
        <div class="protocol-tabs">
          <button class="protocol-tab active" data-tab="eligibility">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
            </svg>
            BMI Eligibility
          </button>
          <button class="protocol-tab" data-tab="critical">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            Critical Questions
          </button>
          <button class="protocol-tab" data-tab="medications">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <path d="M12 9v4M12 17h.01"/>
            </svg>
            Medications
          </button>
          <button class="protocol-tab" data-tab="consent">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
            </svg>
            Consent & Branching
          </button>
        </div>

        <!-- Tab 1: BMI Eligibility -->
        <div class="protocol-tab-content active" data-tab-content="eligibility">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
              </svg>
            </div>
            BMI Eligibility Thresholds
          </div>
          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Patient Characteristics</th>
                <th>BMI Threshold</th>
                <th>Notes</th>
              </tr>
            <tr>
              <td><strong>Standard Eligibility</strong><br><span style="color: var(--text-secondary); font-size: 12px;">White ethnicity, no comorbidities</span></td>
              <td><strong>30 kg/m</strong></td>
              <td>Default BMI requirement</td>
            </tr>
            <tr>
              <td><strong>High-Risk Ethnicity</strong><br><span style="color: var(--text-secondary); font-size: 12px;">Asian, Black, Middle Eastern, Mixed</span></td>
              <td><strong>27.5 kg/m</strong></td>
              <td>Lowered threshold for higher diabetes/CVD risk populations</td>
            </tr>
            <tr>
              <td><strong>With Comorbidities</strong><br><span style="color: var(--text-secondary); font-size: 12px;">Any ethnicity + qualifying comorbidity</span></td>
              <td><strong>27 kg/m</strong></td>
              <td>See comorbidities list below</td>
            </tr>
            <tr>
              <td><strong>Transfer Patients</strong><br><span style="color: var(--text-secondary); font-size: 12px;">Below licence with previous BMI photo</span></td>
              <td><strong>25 kg/m</strong></td>
              <td>Must provide proof of supply + previous BMI photo showing BMI 27</td>
            </tr>
          </table>
          </div>
        </div>

        <div class="protocol-card" style="margin-top: 20px;">
          <div class="protocol-title">
            <div class="icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
              </svg>
            </div>
            Comorbidities (Lowers BMI to 27)
          </div>

          <div class="protocol-text" style="margin-bottom: 16px;">
            If patient selects <strong>ANY</strong> of the following comorbidities, their eligible BMI lowers from 30 to 27 kg/m:
          </div>

          <ul class="protocol-list">
            <li><strong>Prediabetes</strong></li>
            <li><strong>Type 2 diabetes</strong></li>
            <li><strong>High blood pressure</strong></li>
            <li><strong>High cholesterol</strong></li>
            <li><strong>Heart or blood vessel disease</strong> (including previous heart attack)</li>
            <li><strong>Previous stroke</strong></li>
            <li><strong>Obstructive sleep apnoea</strong></li>
            <li><strong>Acid reflux/GORD</strong> <em>(only if taking regular medication)</em></li>
            <li><strong>MASLD</strong> (non-alcoholic fatty liver disease)</li>
            <li><strong>Osteoarthritis</strong></li>
            <li><strong>Depression</strong> <em>(only if taking regular medication AND stable for &gt;3 months)</em></li>
            <li><strong>Erectile dysfunction</strong></li>
            <li><strong>Polycystic ovary syndrome (PCOS)</strong></li>
          </ul>

          <div class="info-card orange" style="margin-top: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                <path d="M12 9v4M12 17h.01"/>
              </svg>
              <div>
                <strong>Depression as Comorbidity:</strong> Patient must be stable and on unchanged treatment for &gt;3 months. Reject if diagnosis is new or mood is unstable/worsening within last 3 months. Changes in dosage/medication may indicate mood instability.
              </div>
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 1 -->

        <!-- Tab 2: Critical Questions -->
        <div class="protocol-tab-content" data-tab-content="critical">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon orange">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
              </svg>
            </div>
            Age & Critical Questions
          </div>

          <div class="info-card orange" style="margin-bottom: 16px;">
            <div class="info-card-title">Mandatory Requirements</div>
            <div class="info-card-text">If patient does not meet these requirements, reject consultation with appropriate reason.</div>
          </div>

          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Question</th>
                <th>Required Answer</th>
                <th>If Incorrect</th>
              </tr>
            <tr>
              <td>Are you aged 18 to 74 years old?</td>
              <td><strong style="color: var(--success);">Yes</strong></td>
              <td>Reject with "Clinically Unsuitable"</td>
            </tr>
            <tr>
              <td>Are you currently pregnant, breastfeeding, or planning pregnancy in next 3 months?</td>
              <td><strong style="color: var(--success);">No</strong></td>
              <td><span style="color: var(--danger);">Absolute contraindication  reject immediately</span></td>
            </tr>
            <tr>
              <td>Have you experienced allergic reaction to Wegovy/Ozempic, Mounjaro, Saxenda/Nevolat/Victoza?</td>
              <td><strong style="color: var(--success);">"I have other allergies"</strong> OR <strong style="color: var(--success);">"None of the above"</strong></td>
              <td>If allergic to any GLP-1  reject</td>
            </tr>
            <tr>
              <td>Have you been diagnosed with thyroid disease, or liver disease or impairment?</td>
              <td><strong>Yes</strong> or <strong>No</strong></td>
              <td>If Yes  Nevolat NOT shown on CTP (only Mounjaro/Wegovy available)</td>
            </tr>
          </table>
          </div>
        </div>

        </div>
        <!-- End Tab 2 -->

        <!-- Tab 3: Medications -->
        <div class="protocol-tab-content" data-tab-content="medications">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon red">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                <path d="M12 9v4M12 17h.01"/>
              </svg>
            </div>
            Interacting Medications
          </div>

          <div class="protocol-text" style="margin-bottom: 16px;">
            Patient must answer <strong>"No"</strong> to the question: "Are you currently taking any of the following medications?" If <strong>Yes</strong> to any  reject consultation.
          </div>

          <div class="dose-table">
            <div class="dose-table-row">
              <div style="flex: 1;">Amiodarone</div>
              <div style="flex: 1;">Carbamazepine</div>
              <div style="flex: 1;">Ciclosporin</div>
            </div>
            <div class="dose-table-row">
              <div style="flex: 1;">Clozapine</div>
              <div style="flex: 1;">Digoxin</div>
              <div style="flex: 1;">Fenfluramine</div>
            </div>
            <div class="dose-table-row">
              <div style="flex: 1;">Lithium</div>
              <div style="flex: 1;">Mycophenolate mofetil</div>
              <div style="flex: 1;">Oral methotrexate</div>
            </div>
            <div class="dose-table-row">
              <div style="flex: 1;">Phenobarbital</div>
              <div style="flex: 1;">Phenytoin</div>
              <div style="flex: 1;">Somatrogon</div>
            </div>
            <div class="dose-table-row">
              <div style="flex: 1;">Tacrolimus</div>
              <div style="flex: 1;">Theophylline</div>
              <div style="flex: 1;">Warfarin</div>
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 3 -->

        <!-- Tab 4: Consent & Branching -->
        <div class="protocol-tab-content" data-tab-content="consent">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
              </svg>
            </div>
            Repeat Patient Branching
          </div>

          <div class="protocol-text" style="margin-bottom: 12px;">
            Repeat patients meeting these criteria get a <strong>shorter consultation</strong> (only answering questions about medical changes):
          </div>

          <ul class="protocol-list">
            <li>Repeat MedExpress patient with GLP-1 order in past 6 months</li>
            <li>Age 18-74 (verified from stored date of birth)</li>
          </ul>

          <div class="protocol-text" style="margin-top: 16px;">
            <strong>Changed Answers Display:</strong> If patient reports changes, system shows which questions changed vs their last consultation. First time changes reported = all answers shown. Second time = only specific changed question shown.
          </div>
        </div>

        <div class="protocol-card" style="margin-top: 20px;">
          <div class="protocol-title">
            <div class="icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
              </svg>
            </div>
            Consent Checkboxes
          </div>

          <div class="protocol-text" style="margin-bottom: 16px;">
            Patients must tick <strong>ALL</strong> compulsory consent boxes. Cannot proceed without all ticked:
          </div>

          <ul class="protocol-list">
            <li>I understand rapid weight loss can raise risk of pancreatitis and gallbladder issues</li>
            <li>I understand severe diarrhoea &gt;24 hours or vomiting within 3 hours of contraceptive pill can reduce effectiveness</li>
            <li>I understand GLP-1s should not be combined with other weight loss medications</li>
            <li>I recognise these treatments may affect mood  will stop and consult doctor if low mood or mental health issues</li>
            <li>Treatment is solely for my own use</li>
            <li>I will read the patient information leaflet</li>
            <li>I will contact MedExpress/GP if I experience side effects or begin new medication</li>
            <li>I agree to MedExpress notifying my GP</li>
            <li>I give permission for MedExpress to request further medical information from GP if necessary</li>
          </ul>

          <div class="info-card blue" style="margin-top: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <div>
                <strong>Repeat Customer Consent:</strong> For repeat customers, prescribers must confirm and record that informed consent for any off-label or unlicensed use (e.g., GLP-1 switching, compounded medication) has been provided, with visibility of consent record in customer file.
              </div>
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 4 -->
      </div>
    `;
  },

  getTitrationGuideContent() {
    return `
      <div class="protocol-page">
        <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">Titration & Gap Management</h1>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">Dose equivalence tables and treatment gap adjustments</p>

        <div class="info-card blue" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <div>
              <strong>Important:</strong> The "step" system helps find equivalent doses across medications based on tolerance and side effects, <strong>NOT clinical efficacy</strong>. Always document clinical decisions for deviations.
            </div>
          </div>
        </div>

        <!-- Titration Guide Tabs -->
        <div class="protocol-tabs">
          <button class="protocol-tab active" data-tab="equivalence">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20V10M18 20V4M6 20v-4"/>
            </svg>
            Dose Equivalence
          </button>
          <button class="protocol-tab" data-tab="gaps">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            Treatment Gaps
          </button>
        </div>

        <!-- Tab 1: Dose Equivalence -->
        <div class="protocol-tab-content active" data-tab-content="equivalence">

        <div class="protocol-card">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; color: var(--accent); flex-shrink: 0;">
              <path d="M12 20V10M18 20V4M6 20v-4"/>
            </svg>
            <strong>Dose Equivalence Table</strong>
          </div>

          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--accent);">
            Use the <strong>"Step"</strong> to find appropriate doses when switching medications or managing tolerability. These represent the most suitable dose for expected tolerance, side effects, and weight loss outcomes.
          </div>

          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th style="width: 12%; background: var(--bg-elevated);">Step</th>
              <th style="width: 22%; background: rgba(99, 102, 241, 0.1);">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                  <strong style="color: var(--accent);">Mounjaro</strong>
                  <span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Tirzepatide (SC Weekly)</span>
                </div>
              </th>
              <th style="width: 22%; background: rgba(34, 197, 94, 0.1);">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                  <strong style="color: var(--success);">Wegovy</strong>
                  <span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Semaglutide (SC Weekly)</span>
                </div>
              </th>
              <th style="width: 22%; background: rgba(245, 158, 11, 0.1);">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                  <strong style="color: var(--warning);">Nevolat</strong>
                  <span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Liraglutide (SC Daily)</span>
                </div>
              </th>
              <th style="width: 22%; background: rgba(168, 85, 247, 0.1);">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                  <strong style="color: var(--purple);">Rybelsus</strong>
                  <span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Semaglutide (Oral Daily)</span>
                </div>
              </th>
            </tr>
            <tr>
              <td><strong style="color: var(--accent);">Step 1A</strong></td>
              <td style="color: var(--text-muted);"></td>
              <td style="color: var(--text-muted);"></td>
              <td><strong>0.6mg</strong></td>
              <td><strong>3mg</strong></td>
            </tr>
            <tr style="background: rgba(245, 158, 11, 0.05);">
              <td><strong style="color: var(--accent);">Step 1B**</strong></td>
              <td style="color: var(--text-muted);"></td>
              <td><strong>0.25mg</strong></td>
              <td><strong>1.2mg</strong></td>
              <td><strong>7mg</strong></td>
            </tr>
            <tr style="background: rgba(99, 102, 241, 0.05);">
              <td><strong style="color: var(--accent);">Step 2*</strong></td>
              <td><strong style="color: var(--accent);">2.5mg</strong></td>
              <td><strong>0.5mg</strong></td>
              <td><strong>1.8mg</strong></td>
              <td><strong>14mg</strong></td>
            </tr>
            <tr style="background: rgba(99, 102, 241, 0.05);">
              <td><strong style="color: var(--accent);">Step 3*</strong></td>
              <td><strong style="color: var(--accent);">5mg</strong></td>
              <td><strong>1.0mg</strong></td>
              <td><strong>2.4mg</strong></td>
              <td style="color: var(--text-muted);"></td>
            </tr>
            <tr style="background: rgba(99, 102, 241, 0.05);">
              <td><strong style="color: var(--accent);">Step 4*</strong></td>
              <td><strong style="color: var(--accent);">7.5mg</strong></td>
              <td><strong>1.7mg</strong></td>
              <td><strong>3.0mg</strong></td>
              <td style="color: var(--text-muted);"></td>
            </tr>
            <tr style="background: rgba(99, 102, 241, 0.05);">
              <td><strong style="color: var(--accent);">Step 5*</strong></td>
              <td><strong style="color: var(--accent);">10mg</strong></td>
              <td><strong>2.4mg</strong></td>
              <td style="color: var(--text-muted);"></td>
              <td style="color: var(--text-muted);"></td>
            </tr>
            <tr>
              <td><strong style="color: var(--accent);">Step 6</strong></td>
              <td><strong style="color: var(--accent);">12.5mg</strong></td>
              <td style="color: var(--text-muted);"></td>
              <td style="color: var(--text-muted);"></td>
              <td style="color: var(--text-muted);"></td>
            </tr>
            <tr>
              <td><strong style="color: var(--accent);">Step 7</strong></td>
              <td><strong style="color: var(--accent);">15mg</strong></td>
              <td style="color: var(--text-muted);"></td>
              <td style="color: var(--text-muted);"></td>
              <td style="color: var(--text-muted);"></td>
            </tr>
          </table>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
            <div style="padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid var(--accent);">
              <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 4px;">* Steps 2-5</div>
              <div style="font-size: 13px; color: var(--text-secondary);">Dose <strong>increases</strong> when switching from Mounjaro to Wegovy</div>
            </div>
            <div style="padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid var(--warning);">
              <div style="font-size: 12px; font-weight: 700; color: var(--warning); margin-bottom: 4px;">** Step 1B</div>
              <div style="font-size: 13px; color: var(--text-secondary);">Dose <strong>increase</strong> when switching Mounjaro/Wegovy to Nevolat or Rybelsus</div>
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 1 -->

        <!-- Tab 2: Treatment Gaps -->
        <div class="protocol-tab-content" data-tab-content="gaps">

        <div class="protocol-card">
          <div class="protocol-title" style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; color: var(--warning); flex-shrink: 0;">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <strong>Gap in Treatment  Dose Adjustments</strong>
          </div>

          <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; border-left: 3px solid var(--warning);">
            <strong>How to use:</strong> Find the patient's last step in the left column, then look across to find the appropriate restart dose based on gap length since last dose.
          </div>

          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th style="width: 15%; background: var(--bg-elevated);">Last Step</th>
              <th style="width: 21.25%; background: rgba(34, 197, 94, 0.1);"><strong style="color: var(--success);">4 weeks</strong><br><span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Short gap</span></th>
              <th style="width: 21.25%; background: rgba(245, 158, 11, 0.1);"><strong style="color: var(--warning);">&gt;4 to 8 weeks</strong><br><span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Medium gap</span></th>
              <th style="width: 21.25%; background: rgba(239, 68, 68, 0.1);"><strong style="color: var(--danger);">&gt;8 to 12 weeks</strong><br><span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Long gap</span></th>
              <th style="width: 21.25%; background: rgba(168, 85, 247, 0.1);"><strong style="color: var(--purple);">&gt;12 weeks</strong><br><span style="font-size: 11px; color: var(--text-muted); font-weight: 500;">Extended gap</span></th>
            </tr>
            <tr>
              <td><strong>Step 1A</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 1A</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong>Step 1A</strong></td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong>Step 1A</strong></td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong>Step 1A</strong></td>
            </tr>
            <tr>
              <td><strong>Step 1B</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 1B</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong style="color: var(--warning);">Step 1A</strong> </td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong style="color: var(--danger);">Step 1A</strong> </td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong style="color: var(--purple);">Step 1A</strong> </td>
            </tr>
            <tr>
              <td><strong>Step 2</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 2</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong style="color: var(--warning);">Step 1B</strong> </td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong style="color: var(--danger);">Step 1A</strong> </td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong style="color: var(--purple);">Step 1A</strong> </td>
            </tr>
            <tr>
              <td><strong>Step 3</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 3</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong style="color: var(--warning);">Step 2</strong> </td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong style="color: var(--danger);">Step 1B</strong> </td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong style="color: var(--purple);">Step 1A</strong> </td>
            </tr>
            <tr>
              <td><strong>Step 4</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 4</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong style="color: var(--warning);">Step 3</strong> </td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong style="color: var(--danger);">Step 2</strong> </td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong style="color: var(--purple);">Step 1B</strong> </td>
            </tr>
            <tr>
              <td><strong>Step 5</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 5</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong style="color: var(--warning);">Step 3</strong> </td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong style="color: var(--danger);">Step 2</strong> </td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong style="color: var(--purple);">Step 1B</strong> </td>
            </tr>
            <tr>
              <td><strong>Step 6</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 6</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong style="color: var(--warning);">Step 3</strong> </td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong style="color: var(--danger);">Step 2</strong> </td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong style="color: var(--purple);">Step 1B</strong> </td>
            </tr>
            <tr>
              <td><strong>Step 7</strong></td>
              <td style="background: rgba(34, 197, 94, 0.05);"><strong>Step 7</strong></td>
              <td style="background: rgba(245, 158, 11, 0.05);"><strong style="color: var(--warning);">Step 3</strong> </td>
              <td style="background: rgba(239, 68, 68, 0.05);"><strong style="color: var(--danger);">Step 2</strong> </td>
              <td style="background: rgba(168, 85, 247, 0.05);"><strong style="color: var(--purple);">Step 1B</strong> </td>
            </tr>
          </table>
          </div>

          <div class="info-card orange" style="margin-top: 16px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0;">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                <path d="M12 9v4M12 17h.01"/>
              </svg>
              <div>
                <strong>Gap Duration:</strong> Periods shown are gaps since the patient's <strong>last dose</strong>. Arrows () indicate step reductions for safety when restarting after gaps.
              </div>
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 2 -->

        <div class="info-card purple" style="margin-top: 20px;">
          <div style="display: flex; align-items: flex-start; gap: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
            </svg>
            <div>
              <strong>Clinical Decision Authority:</strong> Switching doses or deviating from these tables is a clinical decision. If there's a clinical reason not to follow the step table, this <strong>must be documented</strong> on the patient's record with clear justification.
            </div>
          </div>
        </div>
      </div>
    `;
  },

  getRejectionsContent() {
    return `
      <div class="protocol-page">
        <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">Rejection Reasons</h1>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">Manual rejection reasons and when to use them</p>

        <!-- Rejection Reasons Tabs -->
        <div class="protocol-tabs">
          <button class="protocol-tab active" data-tab="manual">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            Manual Rejections
          </button>
          <button class="protocol-tab" data-tab="cancellations">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            </svg>
            Order Cancellations
          </button>
        </div>

        <!-- Tab 1: Manual Rejections -->
        <div class="protocol-tab-content active" data-tab-content="manual">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon red">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
              </svg>
            </div>
            Manual Rejection Reasons
          </div>
          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Reason</th>
                <th>When to Use</th>
              </tr>
            <tr>
              <td><strong>Medical Reason</strong></td>
              <td>GP letter or patient informs us of medical information which is a contraindication. If identified via SCR check  use "SCR Check Fail"</td>
            </tr>
            <tr>
              <td><strong>Drug interaction with your current medication list</strong></td>
              <td>GP letter or patient informs us they're on a contraindicated medication. If identified via SCR  use "SCR Check Fail"</td>
            </tr>
            <tr>
              <td><strong>Due to medical history we are unable to provide treatment online</strong></td>
              <td>GP letter or patient informs us of medical information which is a contraindication. If identified via SCR  use "SCR Check Fail"</td>
            </tr>
            <tr>
              <td><strong>Patient contacted - ID not provided</strong></td>
              <td>ID was not provided after CS outreach OR failed ID (information on ID doesn't match account)</td>
            </tr>
            <tr>
              <td><strong>Patient cannot be contacted for ID check</strong></td>
              <td>Patient cannot be contacted</td>
            </tr>
            <tr>
              <td><strong>Cancel order request by patient - wrong order</strong></td>
              <td>Patient placed wrong order (medication, dose, quantity) and requested to cancel</td>
            </tr>
            <tr>
              <td><strong>Cancel order request by patient - changed mind</strong></td>
              <td>Patient changed their mind and no longer wants medication. For outreach cases with no response  use more relevant rejection reason</td>
            </tr>
            <tr>
              <td><strong>Cancel order request by patient - no reason given</strong></td>
              <td>Patient requested to cancel without providing any reason</td>
            </tr>
            <tr>
              <td><strong>Incomplete address - no response from patient</strong></td>
              <td>Patient didn't provide complete delivery address and has been unresponsive</td>
            </tr>
            <tr>
              <td><strong>Patient over age limit</strong></td>
              <td>Patient is over 74 years old. Ensure DoB on account is updated correctly</td>
            </tr>
            <tr>
              <td><strong>Patient is underaged</strong></td>
              <td>Patient is under 18 years old. Ensure DoB on account is updated correctly</td>
            </tr>
            <tr>
              <td><strong>Multiple Accounts Detected</strong></td>
              <td>Patient has multiple active accounts ordering GLP-1 medications</td>
            </tr>
            <tr>
              <td><strong>Patient can not be contacted for clinical review</strong></td>
              <td>Patient didn't supply necessary information for prescribers to review (unable to reach via phone/email, didn't supply medication list/past medical history)</td>
            </tr>
            <tr>
              <td><strong>Clinically unsuitable to supply - refer to GP</strong></td>
              <td>Patient does not appear to have eligible BMI from photos uploaded</td>
            </tr>
            <tr>
              <td><strong>Patient contacted - missing ID photo and selfie</strong></td>
              <td>ID and weight verification selfie both missing or both inappropriate</td>
            </tr>
            <tr>
              <td><strong>Missing evidence of previous use of GLP-1 weight loss medications</strong></td>
              <td>PUE is missing or does not contain necessary information</td>
            </tr>
            <tr>
              <td><strong>Weight verification process failed</strong></td>
              <td>Weight verification photo not provided or inappropriate after outreach</td>
            </tr>
            <tr>
              <td><strong>Higher Than Recommended Strength Ordered</strong></td>
              <td>Patient ordered higher strength than recommended, unable to provide PUE, and requested to cancel</td>
            </tr>
            <tr>
              <td><strong>Cancel order request by patient - processing delay</strong></td>
              <td>Patient requested to cancel due to delay in processing</td>
            </tr>
            <tr>
              <td><strong>Cancel order request by patient - cheaper elsewhere</strong></td>
              <td>Patient found treatment cheaper elsewhere</td>
            </tr>
            <tr>
              <td><strong>Cancel order request by patient - ordered by mistake</strong></td>
              <td>Patient made a mistake and did not mean to place order</td>
            </tr>
            <tr>
              <td><strong>SCR Check Fail</strong></td>
              <td>A contraindication was found in the patient's SCR</td>
            </tr>
          </table>
        </div>

        </div>
        <!-- End Tab 1 -->

        <!-- Tab 2: Order Cancellations -->
        <div class="protocol-tab-content" data-tab-content="cancellations">

        <div class="protocol-card">
          <div class="protocol-title">
            <div class="icon orange">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              </svg>
            </div>
            Order Cancellation Requests
          </div>

          <div class="protocol-text">Patients can initiate cancellation via Zendesk. They have <strong>24 hours</strong> to click confirmation link. If they don't click within 24 hours, cancellation request expires and order returns to prescribing queue.</div>

          <div class="protocol-section" style="margin-top: 16px;">
            <div class="protocol-section-title">Order Cancellation Requested Tag</div>
            <div class="protocol-text"><strong>Do NOT prescribe or manually reject</strong> orders tagged with <span class="tag orange">Order Cancellation Requested</span>. Allow the patient the full 24-hour window to decide.</div>
          </div>

          <div class="divider"></div>

          <div class="protocol-section">
            <div class="protocol-section-title">Self Cancellation Flow - Zendesk Ticket Status</div>
            <div class="table-wrapper">
              <table class="dose-table">
                <tr>
                  <th>Reason</th>
                  <th>Ticket Status</th>
                </tr>
              <tr>
                <td>BY_PATIENT_CHANGED_MIND</td>
                <td>Automatically closed</td>
              </tr>
              <tr>
                <td>BY_PATIENT_HEALTH_CHANGES</td>
                <td>Ticket to Customer Care  triaged to Clinical</td>
              </tr>
              <tr>
                <td>BY_PATIENT_NEW_MEDICATION</td>
                <td>Ticket to Customer Care  triaged to Clinical</td>
              </tr>
              <tr>
                <td>BY_PATIENT_SIDE_EFFECTS</td>
                <td>Ticket to Customer Care  triaged to Clinical</td>
              </tr>
              <tr>
                <td>BY_PATIENT_WRONG_ORDER</td>
                <td>Automatically closed</td>
              </tr>
              <tr>
                <td>PROCESSING_TOOK_TOO_LONG</td>
                <td>Automatically closed</td>
              </tr>
              <tr>
                <td>OTHER</td>
                <td>Ticket to Customer Care, may be triaged to Clinical</td>
              </tr>
              </table>
            </div>
          </div>
        </div>

        <div class="protocol-card" style="margin-top: 20px;">
          <div class="protocol-title">
            <div class="icon purple">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
              </svg>
            </div>
            Answer Change Response (Comorbidities)
          </div>

          <div class="protocol-text" style="margin-bottom: 16px;">When patients change their comorbidity answer between consultations:</div>

          <div class="table-wrapper">
            <table class="dose-table">
              <tr>
                <th>Change</th>
                <th>Starting BMI</th>
                <th>Action</th>
              </tr>
            <tr>
              <td><strong>Yes  No</strong></td>
              <td>&lt;30</td>
              <td>Contact patient with "Confirmation of Comorbidities" macro. If patient confirms NO comorbidities  reject, send email why, add critical note, raise PSI</td>
            </tr>
            <tr>
              <td><strong>Yes  No</strong></td>
              <td>&gt;30</td>
              <td>Review remaining consultation answers for relevant clinical details. Otherwise no further action</td>
            </tr>
            <tr>
              <td><strong>No  Yes</strong></td>
              <td>&gt;30 by default</td>
              <td>Review remaining consultation answers for relevant clinical details. Otherwise no further action</td>
            </tr>
            </table>
          </div>
          </div>

          <div class="protocol-section" style="margin-top: 16px;">
            <div class="protocol-section-title">Multiple Submissions - GLP1 Consultation</div>
            <div class="table-wrapper">
              <table class="dose-table">
                <tr>
                  <th>Change</th>
                  <th>Initial Answer</th>
                  <th>Action</th>
                </tr>
              <tr>
                <td><strong>No  Yes</strong> (eating disorder or Type 1 diabetes)</td>
                <td>Yes</td>
                <td>Proceed to prescribe based on final answer. If clinically necessary, use <em>ME::multiple submissions - GLP1 consultation</em> macro to contact after prescription</td>
              </tr>
              <tr>
                <td><strong>Weight/height adjusted (BMI)</strong></td>
                <td>N/A</td>
                <td>No action required. This flag tracks data entry errors. Base prescribing decision on BMI value submitted.</td>
              </tr>
              </table>
            </div>
          </div>
        </div>

        </div>
        <!-- End Tab 2 -->
      </div>
    `;
  },

  attachEventListeners(pageId) {
    if (pageId === "dashboard") {
      // Prescription card clicks
      document.querySelectorAll(".prescription-card").forEach((card) => {
        card.addEventListener("click", () => {
          AppState.currentChecklist = card.dataset.type;
          NavigationManager.goToPage("checklists");
        });
      });

      // Quick action clicks
      document.querySelectorAll(".quick-action").forEach((action) => {
        action.addEventListener("click", () => {
          NavigationManager.goToPage(action.dataset.page);
        });
      });
    }

    if (pageId === "checklists") {
      // Protocol links inside checklist items
      document.querySelectorAll(".check-link[data-page]").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          NavigationManager.goToPage(link.dataset.page);
        });
      });

      // Check item clicks
      document.querySelectorAll(".check-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          if (!e.target.closest(".check-link")) {
            ChecklistManager.toggleCheck(item);
          }
        });
      });

      // Reset button
      document.querySelectorAll(".btn-reset").forEach((btn) => {
        btn.addEventListener("click", () => {
          ChecklistManager.resetChecklist(btn.dataset.checklist);
        });
      });

      // Sign button
      document.querySelectorAll(".btn-sign").forEach((btn) => {
        btn.addEventListener("click", () => {
          ChecklistManager.handleSign(btn.dataset.checklist);
        });
      });
    }

    // Back button in protocol pages
    const backBtn = document.querySelector(".back-btn");
    if (backBtn) {
      backBtn.addEventListener("click", () => {
        NavigationManager.goToPage(backBtn.dataset.page || "dashboard");
      });
    }

    // Protocol tabs (for all protocols with tabs)
    if (
      pageId === "proto-core" ||
      pageId === "proto-pue" ||
      pageId === "proto-titration" ||
      pageId === "proto-scr" ||
      pageId === "contraindications"
    ) {
      const tabs = document.querySelectorAll(".protocol-tab");
      const tabContents = document.querySelectorAll(".protocol-tab-content");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const tabId = tab.dataset.tab;

          // Remove active class from all tabs and contents
          tabs.forEach((t) => t.classList.remove("active"));
          tabContents.forEach((content) => content.classList.remove("active"));

          // Add active class to clicked tab and corresponding content
          tab.classList.add("active");
          const activeContent = document.querySelector(`[data-tab-content="${tabId}"]`);
          if (activeContent) {
            activeContent.classList.add("active");
          }
        });
      });
    }

    if (pageId === "proto-scr") {
      const copyButtons = document.querySelectorAll(".copy-btn[data-copy-target]");

      const tryCopyText = async (text) => {
        if (!text) return false;

        // Preferred modern API
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (e) {
            // Fall through to legacy method
          }
        }

        // Legacy fallback (works in many file:// contexts)
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "");
          ta.style.position = "absolute";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        } catch (e) {
          return false;
        }
      };

      copyButtons.forEach((btn) => {
        btn.addEventListener("click", async () => {
          const targetId = btn.dataset.copyTarget;
          const el = document.getElementById(targetId);
          const text = el ? el.textContent : "";

          const original = btn.textContent;
          const ok = await tryCopyText(text);
          btn.textContent = ok ? "Copied" : "Copy failed";
          btn.disabled = true;

          setTimeout(() => {
            btn.textContent = original;
            btn.disabled = false;
          }, 1200);
        });
      });
    }
  },
};

// ============================================
// Checklist Management
// ============================================
const ChecklistManager = {
  toggleCheck(item) {
    const id = item.dataset.id;
    const checklist = item.dataset.checklist;

    AppState.checklists[checklist].checks[id] =
      !AppState.checklists[checklist].checks[id];
    item.classList.toggle("checked", AppState.checklists[checklist].checks[id]);

    this.updateProgress(checklist);
    Utils.saveState();
  },

  updateProgress(checklist) {
    const data = AppState.checklists[checklist];
    const checked = Object.values(data.checks).filter(Boolean).length;
    const total = data.total;
    const percent = (checked / total) * 100;

    // Update progress circle (circumference = 2 *  * 27  169.6)
    const circumference = 169.6;
    const offset = circumference - (percent / 100) * circumference;
    const progressEl = document.getElementById(`progress-${checklist}`);
    if (progressEl) {
      progressEl.style.strokeDashoffset = offset;
    }

    // Update text
    const textEl = document.getElementById(`progress-text-${checklist}`);
    if (textEl) {
      textEl.textContent = `${checked}/${total}`;
    }

    // Update status badge
    const badge = document.getElementById(`status-badge-${checklist}`);
    const btn = document.getElementById(`btn-sign-${checklist}`);

    if (badge && btn) {
      if (checked === total) {
        badge.className = "status-badge complete";
        badge.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Complete</span>`;
        btn.classList.add("ready");
      } else {
        badge.className = "status-badge pending";
        badge.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span>Pending</span>`;
        btn.classList.remove("ready");
      }
    }
  },

  resetChecklist(checklist) {
    AppState.checklists[checklist].checks = {};
    document.querySelectorAll(`[data-checklist="${checklist}"]`).forEach((item) => {
      if (item.classList.contains("check-item")) {
        item.classList.remove("checked");
      }
    });
    this.updateProgress(checklist);
    Utils.saveState();
  },

  handleSign(checklist) {
    const names = {
      starting: "Starting Dose",
      stepup: "Step Up Dose",
      repeat: "Repeat Order",
      "transfer-above": "Transfer (Above Licence)",
      "transfer-below": "Transfer (Below Licence)",
    };

    const now = Utils.formatDateTime();
    alert(
      ` ${names[checklist]} checks complete\n\nTimestamp: ${now}\n\nSafe to sign prescription.`
    );
    this.resetChecklist(checklist);
  },
};

// ============================================
// Initialize Application
// ============================================
document.addEventListener("DOMContentLoaded", () => {
  // Load saved state
  Utils.loadState();

  // Initialize modules
  ThemeManager.init();
  NavigationManager.init();
  SearchManager.init();

  // Update time every minute
  setInterval(() => {
    const timeEl = document.getElementById("current-time");
    if (timeEl) {
      timeEl.textContent = Utils.formatDateTime();
    }
  }, 60000);

  console.log("GLP-1 Prescribing Portal loaded successfully");
});

// ============================================
// Service Worker Registration (for PWA support)
// ============================================
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("/sw.js")
      .then((registration) => console.log("Service Worker registered"))
      .catch((err) => console.log("Service Worker registration failed:", err));
  });
}

  </script>
</body>
</html>
